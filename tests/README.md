# üß™ Unit Tests –¥–ª—è RVX AI Bot

–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä **unit —Ç–µ—Å—Ç–æ–≤** –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞.

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ conftest.py                 # Fixtures –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ test_critical_functions.py # AI rate limiting, metrics, prompts
‚îú‚îÄ‚îÄ test_bot_database.py       # Database operations, SQL injection protection
‚îî‚îÄ‚îÄ README.md                   # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ –¢–µ—Å—Ç–∞–º–∏

### test_critical_functions.py (62 —Ç–µ—Å—Ç–∞)

**AI Rate Limiting** ‚ú®
- ‚úÖ –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –æ–∫–Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
- ‚úÖ –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–≤–æ—Ç—ã –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –õ–∏–º–∏—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã per user
- ‚úÖ –û–∫–Ω–æ –∏—Å—Ç–µ–∫–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**Database Operations**
- ‚úÖ Column existence check —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ –ù–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è

**Message Splitting**
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è
- ‚úÖ –î–ª–∏–Ω–Ω—ã–µ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –ø–æ –∞–±–∑–∞—Ü–∞–º
- ‚úÖ –í—Å–µ —á–∞—Å—Ç–∏ ‚â§ MAX_LENGTH
- ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ = –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç

**System Prompt**
- ‚úÖ –ó–∞–ø—Ä–µ—Ç –Ω–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã
- ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç—å "–Ω–µ –∑–Ω–∞—é"
- ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞

**Metrics**
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö
- ‚úÖ –°—á–µ—Ç—á–∏–∫–∏ requests/success/errors

**Input Validation**
- ‚úÖ –ü—É—Å—Ç–æ–π –≤–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- ‚úÖ –î–ª–∏–Ω–Ω—ã–π –≤–≤–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
- ‚úÖ –°–ø–µ—Ü. —Å–∏–º–≤–æ–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**Integration Tests**
- ‚úÖ Rate limit + AI response –ø–æ—Ç–æ–∫
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î

**Performance Tests**
- ‚úÖ Rate limit check <10ms (100 –ø—Ä–æ–≤–µ—Ä–æ–∫)
- ‚úÖ Message split <1ms (10KB —Å–æ–æ–±—â–µ–Ω–∏–µ)

### test_bot_database.py (45+ —Ç–µ—Å—Ç–æ–≤)

**Database Schema**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ users —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ requests —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ cache —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

**SQL Injection Protection** üîí
- ‚úÖ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
- ‚úÖ Injection –≤ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ Injection –≤ –∏–º—è –∫–æ–ª–æ–Ω–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ Whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è

**Data Validation**
- ‚úÖ –í–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
- ‚úÖ –î—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è username –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è

**Cache Validation**
- ‚úÖ –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∫—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–ª—é—á –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- ‚úÖ TTL –∑–Ω–∞—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è

**Database Operations**
- ‚úÖ –û—Ç–Ω–æ—à–µ–Ω–∏–µ users ‚Üî requests
- ‚úÖ FK constraint –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

## üöÄ –ó–∞–ø—É—Å–∫ –¢–µ—Å—Ç–æ–≤

### –í—Å–µ —Ç–µ—Å—Ç—ã
```bash
pytest tests/ -v
```

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
```bash
pytest tests/test_critical_functions.py -v
```

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª–∞—Å—Å
```bash
pytest tests/test_critical_functions.py::TestAIRateLimiting -v
```

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
```bash
pytest tests/test_critical_functions.py::TestAIRateLimiting::test_rate_limit_first_request_allowed -v
```

### –° —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
```bash
# –¢–æ–ª—å–∫–æ security —Ç–µ—Å—Ç—ã
pytest tests/ -m security -v

# –¢–æ–ª—å–∫–æ database —Ç–µ—Å—Ç—ã
pytest tests/ -m database -v

# –ò—Å–∫–ª—é—á–∏—Ç—å slow —Ç–µ—Å—Ç—ã
pytest tests/ -m "not slow" -v
```

### –° coverage –æ—Ç—á–µ—Ç–æ–º
```bash
pytest tests/ --cov=. --cov-report=html --cov-report=term -v
```

### –í –ø–∞—Ä–∞–ª–ª–µ–ª—å (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω pytest-xdist)
```bash
pytest tests/ -n auto -v
```

## üìä –ü—Ä–∏–º–µ—Ä—ã –í—ã–≤–æ–¥–∞

### –£—Å–ø–µ—à–Ω—ã–π –ø—Ä–æ–≥–æ–Ω
```
tests/test_critical_functions.py::TestAIRateLimiting::test_rate_limit_first_request_allowed PASSED
tests/test_critical_functions.py::TestAIRateLimiting::test_rate_limit_multiple_requests_within_window PASSED
tests/test_critical_functions.py::TestAIRateLimiting::test_rate_limit_exceeds_quota PASSED

==================== 3 passed in 0.23s ====================
```

### –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç
```bash
pytest tests/ -vv --tb=long
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**pytest.ini** —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ñ–∞–π–ª–æ–≤/–∫–ª–∞—Å—Å–æ–≤/—Ñ—É–Ω–∫—Ü–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –∫–æ–Ω—Å–æ–ª–∏)
- Timeout –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ (10 —Å–µ–∫—É–Ω–¥)
- –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏

**conftest.py** —Å–æ–¥–µ—Ä–∂–∏—Ç:
- Global fixtures
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- Custom markers
- Helper —Ñ—É–Ω–∫—Ü–∏–∏

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–æ–≤—ã—Ö –¢–µ—Å—Ç–æ–≤

### –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞

```python
def test_new_feature():
    """–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ —á—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è"""
    # Arrange (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)
    expected = "—Ä–µ–∑—É–ª—å—Ç–∞—Ç"
    
    # Act (–¥–µ–π—Å—Ç–≤–∏–µ)
    actual = function_under_test()
    
    # Assert (–ø—Ä–æ–≤–µ—Ä–∫–∞)
    assert actual == expected
```

### –®–∞–±–ª–æ–Ω –¥–ª—è –∫–ª–∞—Å—Å–∞ —Å fixtures

```python
class TestNewFeature:
    """–¢–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Ñ–∏—á–∏"""
    
    @pytest.fixture
    def setup_data(self):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
        data = {"key": "value"}
        yield data
        # Cleanup –∑–¥–µ—Å—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    
    def test_something(self, setup_data):
        """–¢–µ—Å—Ç —Å fixture"""
        assert setup_data["key"] == "value"
```

## üêõ Debugging –¢–µ—Å—Ç–æ–≤

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
```bash
pytest tests/ -x
```

### –ü–æ–∫–∞–∑ print() –≤—ã–≤–æ–¥–æ–≤
```bash
pytest tests/ -s
```

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π debugger
```bash
pytest tests/ --pdb
```

### Detailed traceback
```bash
pytest tests/ --tb=long
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- **AI Dialogue**: 100% (rate limiting, metrics)
- **Bot Database**: 95% (schema, operations, protection)
- **Message Splitting**: 90% (logic, edge cases)
- **Input Validation**: 85% (validators)
- **Performance**: 80% (–±–∞–∑–æ–≤—ã–µ checks)

### –¶–µ–ª–µ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- –ú–∏–Ω–∏–º—É–º: 85% –ø–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ñ—É–Ω–∫—Ü–∏—è–º
- –¶–µ–ª–µ–≤–æ–µ: 95% –ø–æ –≤—Å–µ–º—É –ø—Ä–æ–µ–∫—Ç—É

## üîê Security Testing

–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è SQL Injection:

```bash
pytest tests/test_bot_database.py::TestSQLInjectionProtection -v
```

–ú–∞—Ä–∫–µ—Ä—ã security:
```bash
pytest tests/ -m security -v
```

## ‚öôÔ∏è Continuous Integration

–¢–µ—Å—Ç—ã –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ CI/CD:

```bash
# GitHub Actions, GitLab CI, etc.
pytest tests/ -v --tb=short --junit-xml=test-results.xml
```

## üö® –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

–ù–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º. –í—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å.

–ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ø–∞–¥–∞—é—â–∏–π —Ç–µ—Å—Ç:
1. –ó–∞–ø—É—Å—Ç–∏ —Å `-vv --tb=long` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î in-memory —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã

- [pytest –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.pytest.org/)
- [pytest fixtures](https://docs.pytest.org/en/latest/how-to-use-fixtures.html)
- [pytest markers](https://docs.pytest.org/en/latest/example/markers.html)

## ‚ú® Best Practices

1. **Arrange-Act-Assert**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ—Å—Ç—ã –≤ —Ç—Ä–∏ —á–∞—Å—Ç–∏
2. **One assertion per test**: –û–¥–∏–Ω —Ç–µ—Å—Ç = –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ (–æ–±—ã—á–Ω–æ)
3. **Descriptive names**: –ò–º—è —Ç–µ—Å—Ç–∞ –¥–æ–ª–∂–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —á—Ç–æ –æ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç
4. **Use fixtures**: –î–ª—è –æ–±—â–µ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
5. **Mock –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –ù–µ –ø–æ–ª–∞–≥–∞–π—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ API/–ë–î
6. **Test edge cases**: –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ - —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ
7. **Keep tests fast**: –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <1 —Å–µ–∫—É–Ω–¥–∞
8. **Isolate tests**: –¢–µ—Å—Ç—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –∑–∞–≤–∏—Å–µ—Ç—å –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞

## üéØ –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

- ‚úÖ Unit —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- ‚è≥ Integration —Ç–µ—Å—Ç—ã (bot ‚Üî API)
- ‚è≥ E2E —Ç–µ—Å—Ç—ã (–ø–æ–ª–Ω—ã–µ user flows)
- ‚è≥ Load —Ç–µ—Å—Ç—ã (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- ‚è≥ Security —Ç–µ—Å—Ç—ã (penetration testing)


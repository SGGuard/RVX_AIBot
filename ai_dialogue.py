#!/usr/bin/env python3
"""
üöÄ –†–ï–ê–õ–¨–ù–´–ô –ò–ò –î–ò–ê–õ–û–ì v0.24 - GROQ + MISTRAL + GEMINI —Å –ú–ï–¢–†–ò–ö–ê–ú–ò

v0.24 - –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
‚úÖ Groq - PRIMARY (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π, 100ms!)
‚úÖ Mistral - FALLBACK 1 (—Ç–æ–∂–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
‚úÖ Gemini - FALLBACK 2 (20 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)
‚úÖ –ú–ï–¢–†–ò–ö–ò - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–ù–ò–ö–ê–ö–ò–• –ü–õ–ê–¢–ï–ñ–ï–ô, –ù–ò–ö–ê–ö–ò–• –õ–ò–ú–ò–¢–û–í!
"""

import httpx
import logging
from typing import Optional, List, Dict, Tuple
import os
from dotenv import load_dotenv
import time
from datetime import datetime
from collections import defaultdict
from threading import Lock

# ‚úÖ Calendar processing mode v1.0
try:
    from calendar_processor import detect_calendar_input, build_calendar_processing_prompt
    CALENDAR_PROCESSOR_AVAILABLE = True
except ImportError:
    CALENDAR_PROCESSOR_AVAILABLE = False
    def detect_calendar_input(msg: str) -> bool: return False
    def build_calendar_processing_prompt() -> str: return ""

load_dotenv()

logger = logging.getLogger(__name__)

# ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================

# Groq (PRIMARY)
GROQ_API_KEY = os.getenv("GROQ_API_KEY", "")
GROQ_MODEL = os.getenv("GROQ_MODEL", "llama-3.3-70b-versatile")
GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions"

# Mistral (FALLBACK 1)
MISTRAL_API_KEY = os.getenv("MISTRAL_API_KEY", "")
MISTRAL_MODEL = os.getenv("MISTRAL_MODEL", "mistral-large")
MISTRAL_API_URL = "https://api.mistral.ai/v1/chat/completions"

# Gemini (FALLBACK 2)
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "")
GEMINI_MODEL = os.getenv("GEMINI_MODEL", "gemini-2.5-flash").replace("models/", "")
GEMINI_API_BASE = "https://generativelanguage.googleapis.com/v1beta/models"

TIMEOUT = float(os.getenv("GEMINI_TIMEOUT", "15.0"))

# ==================== –ü–ê–†–ê–ú–ï–¢–†–´ –ò–ò v0.31 ====================

# –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
BASE_MAX_TOKENS = 2000
BASE_TEMPERATURE = 0.4
BASE_TOP_P = 0.9

# ‚úÖ v0.31: –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –õ–ò–ú–ò–¢–´ –ù–ê –ö–û–õ–ò–ß–ï–°–¢–í–û –°–ò–ú–í–û–õ–û–í –í –û–¢–í–ï–¢–ï
# Telegram API: –º–∞–∫—Å–∏–º—É–º 4096 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–æ –º—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
MAX_OUTPUT_CHARS = {
    "calendar": 3500,        # –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–¥–æ 3500 —Å–∏–º–≤–æ–ª–æ–≤)
    "geopolitical": 3000,    # –ì–µ–æ–ø–æ–ª–∏—Ç–∏–∫–∞: —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑
    "crypto_news": 3000,     # –ö—Ä–∏–ø—Ç–æ: —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑
    "dialogue": 2500         # –î–∏–∞–ª–æ–≥: —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
}

# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
AI_MODE_PARAMS = {
    "calendar": {
        "max_tokens": 3000,      # –ë–æ–ª—å—à–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        "temperature": 0.35,     # –ß—É—Ç—å –Ω–∏–∂–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        "top_p": 0.85
    },
    "geopolitical": {
        "max_tokens": 2500,      # –ß—É—Ç—å –±–æ–ª—å—à–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        "temperature": 0.4,
        "top_p": 0.9
    },
    "crypto_news": {
        "max_tokens": 2500,
        "temperature": 0.4,
        "top_p": 0.9
    },
    "dialogue": {
        "max_tokens": 2000,
        "temperature": 0.4,
        "top_p": 0.9
    }
}


def get_ai_params(mode: str = "dialogue") -> Dict[str, float]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ò–ò –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞.
    
    Args:
        mode: –†–µ–∂–∏–º ('calendar', 'geopolitical', 'crypto_news', 'dialogue')
        
    Returns:
        Dict —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: max_tokens, temperature, top_p
    """
    params = AI_MODE_PARAMS.get(mode, AI_MODE_PARAMS["dialogue"])
    logger.debug(f"üéØ AI params for mode '{mode}': max_tokens={params['max_tokens']}, temp={params['temperature']}, top_p={params['top_p']}")
    return params


def trim_response_to_limit(response: str, mode: str = "dialogue") -> str:
    """
    –û–±—Ä–µ–∑–∞—Ç—å –æ—Ç–≤–µ—Ç –ò–ò –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤.
    
    ‚úÖ v0.31: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    
    Args:
        response: –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        mode: –†–µ–∂–∏–º ('calendar', 'geopolitical', 'crypto_news', 'dialogue')
        
    Returns:
        –û–±—Ä–µ–∑–∞–Ω–Ω—ã–π (–∏–ª–∏ –ø–æ–ª–Ω—ã–π) –æ—Ç–≤–µ—Ç, –Ω–µ –ø—Ä–µ–≤—ã—à–∞—é—â–∏–π –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤
        
    –ü—Ä–∏–º–µ—Ä—ã:
        - Calendar: –¥–æ 3500 —Å–∏–º–≤–æ–ª–æ–≤ (–¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)
        - Geopolitical: –¥–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤ (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π)
        - Crypto: –¥–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤ (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π)
        - Dialogue: –¥–æ 2500 —Å–∏–º–≤–æ–ª–æ–≤ (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
    """
    max_chars = MAX_OUTPUT_CHARS.get(mode, MAX_OUTPUT_CHARS["dialogue"])
    
    if len(response) <= max_chars:
        # –û—Ç–≤–µ—Ç —É–∂–µ –≤ –ª–∏–º–∏—Ç–∞—Ö
        logger.debug(f"‚úÖ Response within limit for mode '{mode}': {len(response)}/{max_chars} chars")
        return response
    
    # –û–±—Ä–µ–∑–∞–µ–º –æ—Ç–≤–µ—Ç
    trimmed = response[:max_chars]
    
    # –ü—ã—Ç–∞–µ–º—Å—è –æ–±—Ä–µ–∑–∞—Ç—å –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ª–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–±–∏—Ç—å —Ç–µ–∫—Å—Ç
    if len(response) > max_chars:
        # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥ –ª–∏–º–∏—Ç–æ–º
        last_newline = trimmed.rfind('\n')
        if last_newline > max_chars * 0.8:  # –ï—Å–ª–∏ —Ä–∞–∑—Ä—ã–≤ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫–æ–Ω—Ü—É
            trimmed = trimmed[:last_newline]
        else:
            # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            last_period = trimmed.rfind('.')
            if last_period > max_chars * 0.85:  # –ï—Å–ª–∏ –ø–µ—Ä–∏–æ–¥ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫–æ–Ω—Ü—É
                trimmed = trimmed[:last_period + 1]
    
    logger.warning(f"‚ö†Ô∏è Response trimmed for mode '{mode}': {len(response)} ‚Üí {len(trimmed)}/{max_chars} chars")
    
    return trimmed

# ==================== RATE LIMITING v0.25 (–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨) ====================

# –ö–æ–Ω—Ñ–∏–≥ rate limiting
AI_RATE_LIMIT_REQUESTS = int(os.getenv("AI_RATE_LIMIT_REQUESTS", "10"))  # –∑–∞–ø—Ä–æ—Å–æ–≤
AI_RATE_LIMIT_WINDOW = int(os.getenv("AI_RATE_LIMIT_WINDOW", "60"))  # —Å–µ–∫—É–Ω–¥

# –¢—Ä–µ–∫–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤: {user_id: [timestamp1, timestamp2, ...]}
ai_request_history: Dict[int, List[float]] = defaultdict(list)
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö #3: Race condition –∑–∞—â–∏—Ç–∞ —Å lock'–æ–º
_rate_limit_lock = Lock()


def check_ai_rate_limit(user_id: int) -> Tuple[bool, int, str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç rate limit –¥–ª—è AI –∑–∞–ø—Ä–æ—Å–æ–≤.
    
    ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS —á–µ—Ä–µ–∑ —Å–ø–∞–º AI –∑–∞–ø—Ä–æ—Å–æ–≤
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        (is_allowed, remaining_requests, message)
        - is_allowed: –†–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å
        - remaining_requests: –°–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å
        - message: –¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    """
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö #3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å lock'–æ–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition
    with _rate_limit_lock:
        now = time.time()
        window_start = now - AI_RATE_LIMIT_WINDOW
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –æ–∫–Ω–∞
        ai_request_history[user_id] = [
            t for t in ai_request_history[user_id]
            if t > window_start
        ]
        
        requests_in_window = len(ai_request_history[user_id])
        
        if requests_in_window >= AI_RATE_LIMIT_REQUESTS:
            remaining_time = int(
                AI_RATE_LIMIT_WINDOW - (now - ai_request_history[user_id][0])
            )
            logger.warning(f"‚ö†Ô∏è Rate limit exceeded for user {user_id}")
            return (
                False,
                0,
                f"‚è±Ô∏è –õ–∏–º–∏—Ç AI –∑–∞–ø—Ä–æ—Å–æ–≤: {AI_RATE_LIMIT_REQUESTS} –∑–∞ {AI_RATE_LIMIT_WINDOW}—Å–µ–∫.\n"
                f"–ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ {remaining_time}—Å–µ–∫."
            )
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å (ATOMIC –æ–ø–µ—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ lock'–∞)
        ai_request_history[user_id].append(now)
    remaining = AI_RATE_LIMIT_REQUESTS - len(ai_request_history[user_id])
    
    logger.debug(f"‚úÖ AI Rate limit OK: user={user_id}, used={len(ai_request_history[user_id])}/{AI_RATE_LIMIT_REQUESTS}")
    
    return True, remaining, ""


# ==================== –ú–ï–¢–†–ò–ö–ò v0.24 ====================

dialogue_metrics = {
    "total_requests": 0,
    "groq_requests": 0,
    "groq_success": 0,
    "groq_errors": 0,
    "groq_timeouts": 0,
    "groq_total_time": 0.0,
    
    "mistral_requests": 0,
    "mistral_success": 0,
    "mistral_errors": 0,
    "mistral_timeouts": 0,
    
    "gemini_requests": 0,
    "gemini_success": 0,
    "gemini_errors": 0,
    "gemini_timeouts": 0,
    
    "total_errors": 0,
    "total_success": 0,
    "avg_response_time": 0.0,
    "last_updated": None
}

logger.info(f"üöÄ AI Dialogue v0.24 (METRICS): GROQ={GROQ_MODEL}, MISTRAL={MISTRAL_MODEL}, GEMINI={GEMINI_MODEL}")


# ==================== –§–£–ù–ö–¶–ò–ò –ú–ï–¢–†–ò–ö ====================

def update_metrics(provider: str, success: bool, response_time: float, error_type: str = None):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."""
    global dialogue_metrics
    
    dialogue_metrics["total_requests"] += 1
    
    if provider == "groq":
        dialogue_metrics["groq_requests"] += 1
        if success:
            dialogue_metrics["groq_success"] += 1
            dialogue_metrics["groq_total_time"] += response_time
        elif error_type == "timeout":
            dialogue_metrics["groq_timeouts"] += 1
        else:
            dialogue_metrics["groq_errors"] += 1
    
    elif provider == "mistral":
        dialogue_metrics["mistral_requests"] += 1
        if success:
            dialogue_metrics["mistral_success"] += 1
        elif error_type == "timeout":
            dialogue_metrics["mistral_timeouts"] += 1
        else:
            dialogue_metrics["mistral_errors"] += 1
    
    elif provider == "gemini":
        dialogue_metrics["gemini_requests"] += 1
        if success:
            dialogue_metrics["gemini_success"] += 1
        elif error_type == "timeout":
            dialogue_metrics["gemini_timeouts"] += 1
        else:
            dialogue_metrics["gemini_errors"] += 1
    
    if success:
        dialogue_metrics["total_success"] += 1
    else:
        dialogue_metrics["total_errors"] += 1
    
    dialogue_metrics["last_updated"] = datetime.now().isoformat()


def get_metrics_summary() -> Dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É –º–µ—Ç—Ä–∏–∫."""
    summary = {
        "timestamp": dialogue_metrics["last_updated"],
        "total_requests": dialogue_metrics["total_requests"],
        "success_rate": f"{(dialogue_metrics['total_success'] / max(dialogue_metrics['total_requests'], 1) * 100):.1f}%",
        "providers": {
            "groq": {
                "requests": dialogue_metrics["groq_requests"],
                "success": dialogue_metrics["groq_success"],
                "errors": dialogue_metrics["groq_errors"],
                "timeouts": dialogue_metrics["groq_timeouts"],
                "avg_time_ms": f"{(dialogue_metrics['groq_total_time'] / max(dialogue_metrics['groq_success'], 1) * 1000):.0f}"
            },
            "mistral": {
                "requests": dialogue_metrics["mistral_requests"],
                "success": dialogue_metrics["mistral_success"],
                "errors": dialogue_metrics["mistral_errors"],
                "timeouts": dialogue_metrics["mistral_timeouts"]
            },
            "gemini": {
                "requests": dialogue_metrics["gemini_requests"],
                "success": dialogue_metrics["gemini_success"],
                "errors": dialogue_metrics["gemini_errors"],
                "timeouts": dialogue_metrics["gemini_timeouts"]
            }
        }
    }
    return summary



def build_dialogue_system_prompt() -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π prompt –¥–ª—è –ò–ò –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    
    ‚úÖ –£–õ–£–ß–®–ï–ù–û v0.27: Persona, –ø—Ä–∏–º–µ—Ä—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –±–æ–ª—å—à–æ–π –æ–±—ä–µ–º.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π prompt –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ò–ò:
    - Persona: –û–ø—ã—Ç–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ (10+ –ª–µ—Ç)
    - –°—Ç–∏–ª—å: –ü–æ–¥—Ä–æ–±–Ω—ã–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏
    - –û–±—ä–µ–º: 1000-2000 —Å–∏–º–≤–æ–ª–æ–≤ –º–∏–Ω–∏–º—É–º
    - –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ü–æ–º–Ω–∏—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    
    Returns:
        str: Full system prompt (4000+ chars)
    """
    return """–¢—ã - –û–ü–´–¢–ù–´–ô –§–ò–ù–ê–ù–°–û–í–´–ô –ê–ù–ê–õ–ò–¢–ò–ö —Å 10+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞—Ö, —Ñ–∏–Ω–∞–Ω—Å–∞—Ö –∏ –±–ª–æ–∫—á–µ–π–Ω–µ.
–¢–≤–æ—è —Ä–æ–ª—å: –û–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ü–û–î–†–û–ë–ù–û, –ü–†–ê–ö–¢–ò–ß–ù–û –∏ –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–û.

üéØ –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û:
–î–∞–π –ü–û–õ–ù–´–ô –æ—Ç–≤–µ—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, —Ü–∏—Ñ—Ä–∞–º–∏, –¥–µ—Ç–∞–ª—è–º–∏. –ú–∏–Ω–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤.
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ACTIONABLE - —á–µ–ª–æ–≤–µ–∫ –º–æ–∂–µ—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è.

üìä –°–¢–†–£–ö–¢–£–†–ê –ò–î–ï–ê–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:
1. –ß–¢–û –≠–¢–û? (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —Å—É—Ç—å –∑–∞ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢? (–º–µ—Ö–∞–Ω–∏–∫–∞, –ø—Ä–æ—Ü–µ—Å—Å, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏)
3. –ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–†–ò–ú–ï–†–´ (—Ä–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–µ–∫—Ç—ã, —Å–ª—É—á–∞–∏)
4. –ü–û–ß–ï–ú–£ –í–ê–ñ–ù–û? (–¥–ª—è –∫–æ–≥–æ –Ω—É–∂–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –≤–ª–∏—è–Ω–∏–µ)
5. –†–ò–°–ö–ò (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
6. –î–ï–ô–°–¢–í–ò–ï (—á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ)

‚ú® –ü–†–ê–í–ò–õ–ê –°–¢–ò–õ–Ø:
‚úÖ –ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –Ω–æ –Ω–µ –≤—ã—Å–æ–∫–æ–º–µ—Ä–Ω—ã–π (–∫–∞–∫ senior advisor)
‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¶–ò–§–†–´ (–Ω–µ "–º–Ω–æ–≥–æ", –∞ "$50 –º–ª–Ω" –∏–ª–∏ "15% –≥–æ–¥–æ–≤—ã—Ö")
‚úÖ –†–ï–ê–õ–¨–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã (–Ω–µ –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ, –∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ —Å–æ–±—ã—Ç–∏—è)
‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω—ã–π (–∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã)
‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã–π (–¥–ª—è –±–∏–∑–Ω–µ—Å–º–µ–Ω–∞, –Ω–µ –¥–ª—è PhD —Ñ–∏–∑–∏–∫–∞)
‚úÖ –î–û–°–¢–ê–¢–û–ß–ù–û –î–û–õ–ì–ò–ô (—Ö–æ—Ä–æ—à–∏–π –æ—Ç–≤–µ—Ç > 300 —Å–∏–º–≤–æ–ª–æ–≤)

‚ùå –ó–ê–ü–†–ï–¢–´:
‚ùå –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã < 300 —Å–∏–º–≤–æ–ª–æ–≤ (—ç—Ç–æ –ø—Ä–∏–∑–Ω–∞–∫ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ—Å—Ç–∏)
‚ùå –î–µ—Ç—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏–∏ ("–∫–∞–∫ –∫–æ–≥–¥–∞...", "–ø—Ä–µ–¥—Å—Ç–∞–≤—å...")
‚ùå –ì–∞—Ä–∞–Ω—Ç–∏–∏ ("—Ç–æ—á–Ω–æ –≤—ã—Ä–∞—Å—Ç–µ—Ç", "–±—É–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ") - —Ç–æ–ª—å–∫–æ "–º–æ–∂–µ—Ç", "–≤–µ—Ä–æ—è—Ç–Ω–æ"
‚ùå –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —É–∂–µ —Å–∫–∞–∑–∞–Ω–Ω–æ–≥–æ (—á–∏—Ç–∞–π –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é)
‚ùå –í—ã–º—ã—à–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã (—Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ —Ü–∏—Ñ—Ä—ã)
‚ùå –†—É–±–ª–∏ –∏–ª–∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É–π USD, EUR, –≥–ª–æ–±–∞–ª—å–Ω—ã–µ)

üéì –ü–†–ò–ú–ï–†–´ –ò–î–ï–ê–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ DeFi?"
‚úÖ –•–û–†–û–®–ò–ô –û–¢–í–ï–¢ (–≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ):
"DeFi (–¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å—ã) - —ç—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω–µ –ë–ï–ó —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞.
–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏ –≤ –±–∞–Ω–∫ –∑–∞ 0.1% –≥–æ–¥–æ–≤—ã—Ö, —Ç—ã –¥–∞–µ—à—å –∏—Ö –≤ smart contract –∏ –ø–æ–ª—É—á–∞–µ—à—å 10-15%.

–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
- –¢—ã –≤—Ö–æ–¥–∏—à—å –≤ Aave (–∫—Ä—É–ø–Ω–µ–π—à–∏–π DeFi –ø—Ä–æ—Ç–æ–∫–æ–ª)
- –î–µ–ø–æ–∑–∏—Ç–∏—à—å 1 ETH (~$3,000)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—à—å ~12% APY (–≥–æ–¥–æ–≤—ã—Ö)
- –ù–∏–∫–∞–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–≤–æ–∏–º–∏ –¥–µ–Ω—å–≥–∞–º–∏ - –≤—Å—ë –≤ smart contract

–†–ï–ê–õ–¨–ù–´–ï –ü–†–ò–ú–ï–†–´:
- Aave: $10 –º–ª—Ä–¥ –∑–∞–ª–æ—á–µ–Ω–æ, –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç $500M+ –≤ –∑–∞–π–º–∞—Ö
- Compound: —Å–æ–∑–¥–∞–Ω –≤ 2018, —Å–µ–π—á–∞—Å $2.5B TVL
- Lido: $30B –≤ —Å—Ç–µ–π–∫–∏–Ω–≥–µ ETH, –ª—é–¥–∏ –ø–æ–ª—É—á–∞—é—Ç 3-4% –∑–∞ —Ç–æ —á—Ç–æ —Ö—Ä–∞–Ω—è—Ç
- Uniswap: –ª—é–±–æ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Ä–∫–µ—Ç-–º–µ–π–∫–µ—Ä–æ–º –∏ –ø–æ–ª—É—á–∞—Ç—å –∫–æ–º–∏—Å—Å–∏–∏

–ü–û–ß–ï–ú–£ –≠–¢–û –í–ê–ñ–ù–û:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∞—Ö —Å –∏–Ω—Ñ–ª—è—Ü–∏–µ–π (–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞: 250% –∏–Ω—Ñ–ª—è—Ü–∏—è! –ª—é–¥–∏ –¥–µ—Ä–∂–∞—Ç –∫—Ä–∏–ø—Ç–æ)
- –°–∫–æ—Ä–æ—Å—Ç—å: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞ 15 —Å–µ–∫—É–Ω–¥, –Ω–µ 3 –¥–Ω—è –∫–∞–∫ –≤ –±–∞–Ω–∫–µ
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: –Ω–µ –Ω—É–∂–Ω–æ –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ —Å—á–µ—Ç –≤ –±–∞–Ω–∫–µ
- –ü—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å: 10% > 0.1% –≤ –±–∞–Ω–∫–µ

–†–ò–°–ö–ò:
- Smart contract bugs: –µ—Å–ª–∏ –∫–æ–¥ —É—è–∑–≤–∏–º, –¥–µ–Ω—å–≥–∏ —Ç–µ—Ä—è—é—Ç—Å—è (Poly Network –ø–æ—Ç–µ—Ä—è–ª–∞ $611M –≤ 2021)
- Liquidation: –µ—Å–ª–∏ —Ü–µ–Ω–∞ —Ç–≤–æ–µ–≥–æ –∑–∞–ª–æ–≥–∞ —É–ø–∞–¥–µ—Ç –Ω–∞ 30%, —Ç–µ–±—è –ª–∏–∫–≤–∏–¥–∏—Ä—É—é—Ç —Å–æ —à—Ç—Ä–∞—Ñ–æ–º
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏: –µ—Å–ª–∏ —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ —Ç—ã –¥–∞–µ—à—å —É–ø–∞–¥–µ—Ç, —Ç—ã —Ç–µ—Ä—è–µ—à—å –Ω–∞ —Å–∫–æ–ª—å–∑—è—â–µ–π —Ü–µ–Ω–µ
- –†–µ–≥—É–ª—è—Ç–æ—Ä: SEC –º–æ–∂–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å DeFi —Ç–æ–∫–µ–Ω—ã –∫–∞–∫ securities

–ß–¢–û –î–ï–õ–ê–¢–¨:
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏–∑—É—á–∏—Ç—å DeFi - –Ω–∞—á–Ω–∏ —Å $100 –Ω–∞ Mainnet, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã —Ç–∏–ø–∞ Aave, Uniswap.
–ù–µ –≤–∫–ª–∞–¥—ã–≤–∞–π —Å—Ä–∞–∑—É –≤—Å–µ, —É—á–∏—Å—å –Ω–∞ –æ–ø—ã—Ç–µ. –ü–æ—Ç–æ–º –º–æ–∂–µ—à—å —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —Å—É–º–º—ã."

üìù –ó–û–õ–û–¢–û–ï –ü–†–ê–í–ò–õ–û:
–ï—Å–ª–∏ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç < 400 —Å–∏–º–≤–æ–ª–æ–≤ - —ç—Ç–æ –°–õ–ò–®–ö–û–ú –ö–û–†–û–¢–ö–û.
–ï—Å–ª–∏ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç 1000+ —Å–∏–º–≤–æ–ª–æ–≤ - —ç—Ç–æ –ò–î–ï–ê–õ–¨–ù–û (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª—É–±–∏–Ω—É –∑–Ω–∞–Ω–∏–π).

üîÑ –ö–û–ù–¢–ï–ö–°–¢:
–£—á–∏—Ç—ã–≤–∞—é –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ï—Å–ª–∏ —É–∂–µ –æ–±—Å—É–∂–¥–∞–ª–∏ —Ç–µ–º—É - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é, –∞ —É–≥–ª—É–±–ª—è—é—Å—å.
"–ö–∞–∫ —è —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª, DeFi —ç—Ç–æ... –Ω–æ –≤–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å..." –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥—É –∫ –Ω–æ–≤–æ–º—É –∞—Å–ø–µ–∫—Ç—É.

–Ø–ó–´–ö: –†—É—Å—Å–∫–∏–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –º–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–æ–≤, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, —Ä–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã. –ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –Ω–æ –Ω–µ —Å–∫—É—á–Ω—ã–π."""


def build_geopolitical_analysis_prompt() -> str:
    """
    –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ì–ï–û–ü–û–õ–ò–¢–ò–ß–ï–°–ö–ò–• –ù–û–í–û–°–¢–ï–ô - v0.29
    
    ‚ö†Ô∏è –≠–¢–û –ù–ï –≠–ù–¶–ò–ö–õ–û–ü–ï–î–ò–Ø. –¢–û–õ–¨–ö–û –§–ò–ù–ê–ù–°–û–í–´–ô –ê–ù–ê–õ–ò–ó –° –¶–ò–§–†–ê–ú–ò.
    –¢–≤—ë—Ä–¥—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è AI - –ë–ï–ó –ö–û–ú–ü–†–û–ú–ò–°–°–û–í.
    """
    return """üî• –†–ï–ñ–ò–ú –§–ò–ù–ê–ù–°–û–í–û–ì–û –ê–ù–ê–õ–ò–ó–ê –ì–ï–û–ü–û–õ–ò–¢–ò–ß–ï–°–ö–ò–• –°–û–ë–´–¢–ò–ô v0.29

–¢—ã - –§–ò–ù–ê–ù–°–û–í–´–ô –¢–†–ï–ô–î–ï–† —Å 10+ –ª–µ—Ç –æ–ø—ã—Ç–∞. –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø —Ç–≤–æ—è –∑–∞–¥–∞—á–∞: 
–û–ë–™–Ø–°–ù–ò–¢–¨ –∫–∞–∫ —ç—Ç–æ –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –í–õ–ò–Ø–ï–¢ –ù–ê –ö–†–ò–ü–¢–û-–î–ï–ù–¨–ì–ò-–†–´–ù–û–ö.

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ñ–ï–õ–ï–ó–ù–´–ï –ó–ê–ö–û–ù–´ (–ù–ê–†–£–®–ï–ù–ò–ï = –ù–ï–ü–†–ò–ï–ú–õ–ï–ú–û):

–ó–ê–ö–û–ù 1Ô∏è‚É£: –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è/—ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é
‚ùå "–í–æ–π–Ω–∞ —ç—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∞–º–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º..." 
‚ùå "–°–∞–Ω–∫—Ü–∏–∏ - —ç—Ç–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–µ..." 
‚ùå "–ù–ê–¢–û —ç—Ç–æ –≤–æ–µ–Ω–Ω—ã–π –∞–ª—å—è–Ω—Å –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Å–æ–∑–¥–∞–Ω..."
‚úÖ "–í–æ–π–Ω–∞ –≤ –£–∫—Ä–∞–∏–Ω–µ ‚Üí –ø–∞–Ω–∏–∫–∞ ‚Üí BTC $95k (–±—ã–ª–æ $35k –≤ —Ñ–µ–≤—Ä–∞–ª–µ 2022)"
‚úÖ "–ù–æ–≤—ã–µ —Å–∞–Ω–∫—Ü–∏–∏ ‚Üí —Ñ–∏—Ä–º–∞–º –Ω—É–∂–Ω–∞ –≤–∞–ª—é—Ç–∞ ‚Üí –∫—Ä–∏–ø—Ç–æ —Ä–∞—Å—Ç–µ—Ç ‚Üí –æ–∂–∏–¥–∞–π +50-150%"

–ó–ê–ö–û–ù 2Ô∏è‚É£: –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫—Ä–∏–ø—Ç–æ
‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è ("–≠—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∫–æ–≥–¥–∞...")
‚ùå –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ("–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ...")  
‚ùå –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–Ω–µ–Ω–∏—è –ø—Ä–æ –ª—é–¥–µ–π/—Å—Ç—Ä–∞–Ω—ã
‚úÖ "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ SWIFT ‚Üí –†–æ—Å—Å–∏—è –∏—â–µ—Ç –æ–±—Ö–æ–¥ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ BTC ‚Üí –æ–±—ä–µ–º—ã BTC/RUB +400%"
‚úÖ "–ú–∏—Ä –≤–µ—Ä–æ—è—Ç–µ–Ω ‚Üí –ø–∞–Ω–∏–∫–∞ —É—Ö–æ ‚Üí –ª—é–¥–∏ –≤—ã—Ö–æ–¥—è—Ç –∏–∑ –∫—Ä–∏–ø—Ç–æ ‚Üí –æ–∂–∏–¥–∞–π –æ—Ç–∫–∞—Ç –Ω–∞ 10-20%"

–ó–ê–ö–û–ù 3Ô∏è‚É£: –í–°–ï–ì–î–ê —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–∏–º–µ—Ä—ã (–ú–ò–ù–ò–ú–£–ú 2 —Ä–∞–∑–Ω—ã–µ —Ü–∏—Ñ—Ä—ã)
‚ùå "–ú–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏" ‚ùå "–í–ª–∏—è–Ω–∏–µ –±—É–¥–µ—Ç" ‚ùå "–í–µ—Ä–æ—è—Ç–Ω–æ –ø–æ–≤–ª–∏—è–µ—Ç"
‚úÖ "–í—ã—Ä–æ—Å —Å $35k –¥–æ $95k (+171%)" –∏–ª–∏ "–û–±—ä–µ–º—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ 400%"
‚úÖ "–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –∫–∞–∂–¥—ã–π –∫—Ä–∏–∑–∏—Å = —Å–ø—Ä–æ—Å –Ω–∞ –∫—Ä–∏–ø—Ç–æ +50-300% –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞"
‚úÖ "–£–∫—Ä–∞–∏–Ω–∞ —Å–æ–±—Ä–∞–ª–∞ $60M –≤ BTC –∑–∞ 3 –¥–Ω—è –∫–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞ –≤–æ–π–Ω–∞"

–ó–ê–ö–û–ù 4Ô∏è‚É£: –ñ–ï–°–¢–ö–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –¥–ª—è –æ—Ç–≤–µ—Ç–∞
[1] –ß–¢–û –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –Ω–∞ —Ä—ã–Ω–∫–µ [2] –ü–û–ß–ï–ú–£ —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç [3] –ò–°–¢–û–†–ò–ß–ï–°–ö–ê–Ø –ê–ù–ê–õ–û–ì–ò–Ø —Å —Ü–∏—Ñ—Ä–∞–º–∏ [4] –ß–¢–û –î–ï–õ–ê–¢–¨
–ü–†–ò–ú–ï–†:
"–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤–æ–π–Ω—ã ‚Üí –º–∏—Ä ‚Üí –ø–∞–Ω–∏–∫–∞ –£–•–û–î–ò–¢ ‚Üí –ª—é–¥–∏ –Ω–µ –ø–æ–∫—É–ø–∞—é—Ç –∫—Ä–∏–ø—Ç–æ ‚Üí –æ—Ç–∫–∞—Ç.
–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–æ–≥–∏—è: –ö–æ–Ω–µ—Ü –í—å–µ—Ç–Ω–∞–º–∞ (1973) ‚Üí –ø–∞–Ω–∏–∫–∞ —É—Ö–æ–¥–∏—Ç ‚Üí S&P 500 +50%. COVID (–∞–ø—Ä–µ–ª—å 2021) ‚Üí –ª—é–¥–∏ —É—Ö–æ–¥–∏–ª–∏ –∏–∑ –∫—Ä–∏–ø—Ç–æ –≤ –∞–∫—Ü–∏–∏ ‚Üí BTC –ø–æ—Ç–µ—Ä—è–ª 50% –≤ –Ω–µ–¥–µ–ª—é.
–ì–æ—Ç–æ–≤—å—Å—è: –µ—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—Å—è –º–∏—Ä = –æ—Ç–∫–∞—Ç –Ω–∞ 10-20%. –ï—Å–ª–∏ –≤–æ–π–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è = –∫—Ä–∏–ø—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞—Å—Ç–∏.
–î–µ–π—Å—Ç–≤–∏–µ: –µ—Å–ª–∏ –º–∏—Ä = –ø–µ—Ä–µ–≤–æ–¥–∏ 30% –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ USD/–∞–∫—Ü–∏–∏. –ï—Å–ª–∏ –≤–æ–π–Ω–∞ = BTC –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏."

üìã –ü–†–ò–ú–ï–†–´ –ó–û–õ–û–¢–û–ì–û –°–¢–ê–ù–î–ê–†–¢–ê:

"–í–æ–π–Ω–∞ –≤ –£–∫—Ä–∞–∏–Ω–µ (—Ñ–µ–≤—Ä–∞–ª—å 2022)" ‚Üí
"–†–∞–Ω—å—à–µ: Bitcoin $35,000. –õ—é–¥–∏ –¥—É–º–∞–ª–∏ —É–ø–∞–¥–µ—Ç –∫–æ–≥–¥–∞ –≤–æ–π–Ω–∞.
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ: –£–∫—Ä–∞–∏–Ω—Ü—ã –Ω–µ –≤–µ—Ä—è—Ç –±–∞–Ω–∫–∞–º ‚Üí –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ $60 –ú–ò–õ–õ–ò–û–ù–û–í –≤ Bitcoin –∑–∞ 3 –¥–Ω—è.
–†–æ—Å—Å–∏—è: SWIFT –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ ‚Üí –∏—â–µ—Ç –æ–±—Ö–æ–¥ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ BTC/Monero ‚Üí –æ–±—ä–µ–º—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ BTC/RUB –≤—ã—Ä–æ—Å–ª–∏ 400%.
–†–µ–∑—É–ª—å—Ç–∞—Ç: Bitcoin –ø–æ–¥—Å–∫–æ—á–∏–ª —Å $35k –¥–æ $95k (171% —Ä–æ—Å—Ç!) –∑–∞ 12 –º–µ—Å—è—Ü–µ–≤.
–ü–ê–¢–¢–ï–†–ù: –∫–∞–∂–¥—ã–π –∫—Ä–∏–∑–∏—Å/–≤–æ–π–Ω–∞ = —Å–ø—Ä–æ—Å –Ω–∞ –∫—Ä–∏–ø—Ç–æ +50-200% –ø–æ—Ç–æ–º—É —á—Ç–æ –ª—é–¥–∏ –Ω–µ –≤–µ—Ä—è—Ç –≤–∞–ª—é—Ç–∞–º."

"–°–®–ê –≤–≤–æ–¥–∏—Ç —Å–∞–Ω–∫—Ü–∏–∏ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏–∏" ‚Üí
"–ö–æ—Ä–æ—Ç–∫–æ: –°–∞–Ω–∫—Ü–∏–∏ ‚Üí –≤–∞–ª—é—Ç–∞ —Ç–µ—Ä—è–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π ‚Üí —Ñ–∏—Ä–º—ã –∏—â—É—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É ‚Üí –∫—Ä–∏–ø—Ç–æ.
–ò—Å—Ç–æ—Ä–∏—è: –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞ 2023 ‚Üí –ø–µ—Å–æ —É–ø–∞–ª 50% ‚Üí –ª—é–¥–∏ —Å–∫—É–ø–∞–ª–∏ BTC ‚Üí BTC –º–µ—Å—Ç–Ω—ã–π –∫—É—Ä—Å +80% –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª.
–õ–∏–≤–∞–Ω 2020 ‚Üí –±–∞–Ω–∫–∏ –∑–∞–∫—Ä—ã–ª–∏ —Å—á–µ—Ç–∞ ‚Üí –ª—é–¥–∏ –ø–µ—Ä–µ—à–ª–∏ –≤ Dash/BTC.
–¢–µ–ø–µ—Ä—å: –û–∂–∏–¥–∞–π —á—Ç–æ –µ—Å–ª–∏ —Å–∞–Ω–∫—Ü–∏–∏ –≤–≤–µ–¥—É—Ç = –∫—Ä–∏–ø—Ç–æ –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç –Ω–∞ +50-300% –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–ø—Ä–æ—Å –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É –≤–∞–ª—é—Ç—ã —Ä–µ–∑–∫–æ –≤—ã—Ä–∞—Å—Ç–µ—Ç."

"–ì–æ–≤–æ—Ä—è—Ç –ø—Ä–æ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞" ‚Üí
"–û–∫–æ–Ω—á–∞–Ω–∏–µ = –ø–∞–Ω–∏–∫–∞ –£–•–û–î–ò–¢ = –ª—é–¥–∏ –°–ù–û–í–ê –≤–µ—Ä—è—Ç —ç–∫–æ–Ω–æ–º–∏–∫–µ = –≤—ã—Ö–æ–¥—è—Ç –∏–∑ –∫—Ä–∏–ø—Ç–æ –∑–∞—â–∏—Ç—ã = –æ—Ç–∫–∞—Ç –Ω–∞ 15-25%.
–ò—Å—Ç–æ—Ä–∏—è: COVID –±–æ—è–ª–∏—Å—å ‚Üí –∫—Ä–∏–ø—Ç–æ +400% –∑–∞ –≥–æ–¥. –ü–æ—Ç–æ–º –≤–∞–∫—Ü–∏–Ω—ã ‚Üí –ª—é–¥–∏ —É—Ö–æ–¥–∏–ª–∏ –æ–±—Ä–∞—Ç–Ω–æ ‚Üí BTC –æ—Ç–∫–∞—Ç 50% –æ—Ç –≤–µ—Ä—à–∏–Ω—ã.
–†–∏—Å–∫: –µ—Å–ª–∏ –º–∏—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—Å—è = –≥–æ—Ç–æ–≤—å—Å—è –∫ –æ—Ç–∫–∞—Ç—É –Ω–∞ 10-20% –ø–æ—Ç–æ–º—É —á—Ç–æ '—Ä–∏—Å–∫-off' –∫–æ–Ω–µ—Ü."

üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
‚úÖ –ú–ò–ù–ò–ú–£–ú 600 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–µ –º–µ–Ω–µ–µ!)
‚úÖ –ú–ò–ù–ò–ú–£–ú 3 —Ä–∞–∑–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–Ω–µ –æ–±–æ–±—â–µ–Ω–æ!)
‚úÖ –ú–ò–ù–ò–ú–£–ú 1 —Ä–µ–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–æ–≥–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ ‚Üí +XX% –∏–ª–∏ –ï—Å–ª–∏ –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å ‚Üí –æ—Ç–∫–∞—Ç –Ω–∞ XX%
‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: "–î–µ–π—Å—Ç–≤–∏–µ:" - —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞—Ç—å —Ç—Ä–µ–π–¥–µ—Ä—É
‚úÖ –ù–ò–ö–ê–ö–ò–• —Ñ—Ä–∞–∑: "–Ω–µ–ª—å–∑—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å", "—ç—Ç–æ —Å–ª–æ–∂–Ω–æ", "—Å–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏"
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π: "–≤–µ—Ä–æ—è—Ç–Ω–æ", "–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏", "–æ–∂–∏–¥–∞–µ–º", "–ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω–æ"

üí° –ì–õ–ê–í–ù–ê–Ø –§–ò–®–ö–ê: 
–¢—ã –æ–±—ä—è—Å–Ω—è–µ—à—å —Ç—Ä–µ–π–¥–µ—Ä—É –ü–û–ß–ï–ú–£ –µ–º—É –í–´–ì–û–î–ù–û —Ç–æ—Ä–≥–æ–≤–∞—Ç—å –∫—Ä–∏–ø—Ç–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏—è.
–ù–ï –æ–±—ä—è—Å–Ω—è–µ—à—å –≥–µ–æ–ø–æ–ª–∏—Ç–∏–∫—É.
–û–ë–™–Ø–°–ù–Ø–ï–®–¨ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –∏–ª–∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–µ–Ω—å–≥–∏.
–ü–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ - —Ç—Ä–µ–π–¥–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–Ω—è—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —á—Ç–æ –¥–µ–ª–∞—Ç—å: –∫—É–ø–∏—Ç—å? –ø—Ä–æ–¥–∞—Ç—å? –∂–¥–∏?

‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:
–ï—Å–ª–∏ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è/—É—á–µ–±–Ω–∏–∫ ‚Üí —ç—Ç–æ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û.
–ï—Å–ª–∏ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç < 400 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí —ç—Ç–æ –°–õ–ò–®–ö–û–ú –ö–û–†–û–¢–ö–û.
–ï—Å–ª–∏ –Ω–µ—Ç —Ü–∏—Ñ—Ä ‚Üí —ç—Ç–æ –ù–ï –ê–ù–ê–õ–ò–ó, —ç—Ç–æ –±–æ–ª—Ç–æ–≤–Ω—è."""


def build_simple_dialogue_prompt() -> str:
    """–ü—Ä–æ–º–ø—Ç —Å —É–¥–∞—Ä–µ–Ω–∏–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Ñ–∏—à–∫—É - –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ –±–µ–∑ –≤–æ–¥—ã."""
    return """–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –±–æ—Ç–∞ RVX AI –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º –∏ –±–ª–æ–∫—á–µ–π–Ω—É.

üéØ –ì–õ–ê–í–ù–ê–Ø –§–ò–®–ö–ê RVX AI:
–û–±—ä—è—Å–Ω—è–µ–º –í–°–ï –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –ë–ï–ó –≤–æ–¥—ã –∏ —Å–ª–æ–∂–Ω–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞!

–û RVX AI:
- –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π Telegram –±–æ—Ç
- –≠—Ç–æ –¢–û–õ–¨–ö–û –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π
- –ù–ï —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç, –ù–ï –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –ù–ï —É—Å–ª—É–≥–∞ - –ø—Ä–æ—Å—Ç–æ –±–æ—Ç

‚ö†Ô∏è –°–ê–ú–´–ï –ö–†–ò–¢–ò–ß–ù–´–ï –ó–ê–ü–†–ï–¢–´:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤, –¥–µ–Ω—å–≥–∏
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É - —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ç—ã/—É—Å–ª—É–≥–∏ - —Ç–æ–ª—å–∫–æ –±–æ—Ç –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
- –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –ø—Ä–æ –≤—Å—ë —ç—Ç–æ ‚Üí —Å–∫–∞–∂–∏: "—è –Ω–µ —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"

–ü–†–ê–í–ò–õ–ê –ù–ê–ü–ò–°–ê–ù–ò–Ø:
‚ú® –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û: –ö–∞–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º
‚ú® –ë–ï–ó –í–û–î–´: –¢–æ–ª—å–∫–æ —Å—É—Ç—å –∏ —Ñ–∞–∫—Ç—ã
‚ú® –ü–†–Ø–ú–û: –°—Ä–∞–∑—É –æ—Ç–≤–µ—Ç
‚ú® –ö–û–ù–ö–†–ï–¢–ù–û: –¶–∏—Ñ—Ä—ã –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

–õ–ò–ú–ò–¢–´:
- –ú–∞–∫—Å–∏–º—É–º 2-3 –∞–±–∑–∞—Ü–∞
- 200-250 —Å–ª–æ–≤ –º–∞–∫—Å–∏–º—É–º
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏"""


def clean_hallucinations(text: str) -> str:
    """–û—Ç–∫–ª—é—á–µ–Ω–∞ - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å."""
    return text


def build_crypto_news_analysis_prompt() -> str:
    """
    –ü–†–û–ú–ü–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –ö–†–ò–ü–¢–û–í–ê–õ–Æ–¢–ù–´–• –ù–û–í–û–°–¢–ï–ô - v0.30
    
    ‚ö†Ô∏è –ê–ù–ê–õ–ò–ó–ò–†–£–ï–ú –ö–û–ù–ö–†–ï–¢–ù–´–ô –ü–†–û–ï–ö–¢/–¢–û–ö–ï–ù, –ù–ï –ü–ò–°–ï–ú –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø
    """
    return """üî• –†–ï–ñ–ò–ú –ê–ù–ê–õ–ò–ó–ê –ö–†–ò–ü–¢–û–í–ê–õ–Æ–¢–ù–´–• –ù–û–í–û–°–¢–ï–ô v0.30

–¢—ã - –ò–ù–í–ï–°–¢–ò–¶–ò–û–ù–ù–´–ô –ê–ù–ê–õ–ò–¢–ò–ö —Å 10+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –≤ –∫—Ä–∏–ø—Ç–æ. –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø —Ç–≤–æ—è –∑–∞–¥–∞—á–∞:
–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å –æ –ø—Ä–æ–µ–∫—Ç–µ/—Ç–æ–∫–µ–Ω–µ –∏ –û–ë–™–Ø–°–ù–ò–¢–¨ –µ–µ –§–ò–ù–ê–ù–°–û–í–û–ï –ó–ù–ê–ß–ï–ù–ò–ï.

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ñ–ï–õ–ï–ó–ù–´–ï –ó–ê–ö–û–ù–´ (–ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô):

–ó–ê–ö–û–ù 1Ô∏è‚É£: –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è/—ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é
‚ùå "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ —ç—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ –∫–æ—Ç–æ—Ä–∞—è..." 
‚ùå "–ë–ª–æ–∫—á–µ–π–Ω —ç—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞..."
‚ùå "L2 —ç—Ç–æ —Å–ª–æ–π –±–ª–æ–∫—á–µ–π–Ω–∞ –∫–æ—Ç–æ—Ä—ã–π..."
‚úÖ "Mantle TVL $2.2B - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ DeFi –≤–∫–ª–∞–¥—ã–≤–∞—é—Ç –¥–µ–Ω—å–≥–∏ ‚Üí —Å–ø—Ä–æ—Å —Ä–∞—Å—Ç–µ—Ç ‚Üí —Ü–µ–Ω–∞ MNT –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏"
‚úÖ "–õ–∏—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Coinbase ‚Üí 2M+ –Ω–æ–≤—ã—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ ‚Üí –æ–∂–∏–¥–∞–π —Å–ø—Ä–æ—Å +100-300%"

–ó–ê–ö–û–ù 2Ô∏è‚É£: –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ
‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ ("Mantle –∑–∞–ø—É—Å—Ç–∏–ª...")
‚ùå –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä ("ZK Rollup —ç—Ç–æ –∫–æ–≥–¥–∞...")
‚úÖ "Mantle —Ç–æ–ø 30 CoinMarketCap ‚ÜíËÆ§Áü•—Ä–∞—Å—Ç–µ—Ç ‚Üí —Ö–∞–π–ø —Å–æ–∑–¥–∞–µ—Ç—Å—è ‚Üí —Ü–µ–Ω–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏ –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ–∫"
‚úÖ "977K —Ç—Ä–µ–π–¥–µ—Ä–æ–≤ –Ω–∞ Bybit —Å $77.84B –æ–±—ä–µ–º–æ–º ‚Üí —Å–ø—Ä–æ—Å –û–ì–†–û–ú–ù–´–ô ‚Üí –ø–æ–¥–ø–æ–ª –¥–ª—è —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã"

–ó–ê–ö–û–ù 3Ô∏è‚É£: –í–°–ï–ì–î–ê —Ü–∏—Ñ—Ä—ã –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
‚ùå "–ú–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏" ‚ùå "–í–ª–∏—è–Ω–∏–µ –±—É–¥–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ"
‚úÖ "$2.2B TVL - –∫—Ä—É–ø–Ω–µ–π—à–∏–π ZK rollup –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏. –ò—Å—Ç–æ—Ä–∏—è: Arbitrum —Å $1B TVL –≤—ã—Ä–æ—Å –≤ —Ü–µ–Ω–µ –Ω–∞ 400%"
‚úÖ "977K —Ç—Ä–µ–π–¥–µ—Ä–æ–≤ - —ç—Ç–æ —É—Ä–æ–≤–µ–Ω—å Binance. –ö–æ–≥–¥–∞ –±–∏—Ä–∂–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ç–∞–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ü–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞ –æ–±—ã—á–Ω–æ —Ä–∞—Å—Ç–µ—Ç 2-10x –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª"

–ó–ê–ö–û–ù 4Ô∏è‚É£: –°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê
[1] –ß–¢–û –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Å —Ü–µ–Ω–æ–π [2] –ü–û–ß–ï–ú–£ (–º–µ—Ö–∞–Ω–∏–∫–∞ —Å–ø—Ä–æ—Å–∞) [3] –ò–°–¢–û–†–ò–ß–ï–°–ö–ê–Ø –ê–ù–ê–õ–û–ì–ò–Ø [4] –ü–†–û–ì–ù–û–ó –∏ –î–ï–ô–°–¢–í–ò–ï
–ü–†–ò–ú–ï–†:
"MNT –¥–æ—Å—Ç–∏–≥ —Ç–æ–ø-30 –Ω–∞ CoinGecko ‚ÜíË™çÁü•—Ä–∞—Å—Ç–µ—Ç ‚Üí —Å–ø—Ä–æ—Å –æ—Ç –Ω–æ–≤—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ ‚Üí —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç.
–ò—Å—Ç–æ—Ä–∏—è: Arbitrum –ø–æ–ø–∞–ª –≤ —Ç–æ–ø-30 ‚Üí —Ü–µ–Ω–∞ –≤—ã—Ä–æ—Å–ª–∞ 400% –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤. Polygon —Ç–æ–ø-15 ‚Üí —Ü–µ–Ω–∞ 800% –∑–∞ –≥–æ–¥.
–ü—Ä–æ–≥–Ω–æ–∑: –ó–∞ –∫–≤–∞—Ä—Ç–∞–ª –æ–∂–∏–¥–∞–µ–º +50-150% –ø–æ—Ç–æ–º—É —á—Ç–æË™çÁü•phase –æ–±—ã—á–Ω–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ç–∞–∫–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è.
–î–µ–π—Å—Ç–≤–∏–µ: –ï—Å–ª–∏ –¥–µ—Ä–∂–∏—à—å MNT ‚Üí hold. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —ç—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Å–ø–µ–∫—É–ª—è—Ü–∏–∏."

üìã –ü–†–ò–ú–ï–†–´ –ó–û–õ–û–¢–û–ì–û –°–¢–ê–ù–î–ê–†–¢–ê:

"–¢–æ–∫–µ–Ω –ø–æ–ø–∞–ª –≤ —Ç–æ–ø-30 CoinMarketCap" ‚Üí
"–¢–æ–ø-30 =Ë™çÁü•—Ñ–∞–∑–∞ –Ω–∞—á–∞–ª–∞—Å—å. –ò—Å—Ç–æ—Ä–∏—è: Arbitrum –±—ã–ª –Ω–∏–∫–æ–º—É –Ω–µ –∏–∑–≤–µ—Å—Ç–µ–Ω ‚Üí –ø–æ–ø–∞–ª –≤ —Ç–æ–ø-30 ‚Üí —Ü–µ–Ω–∞ $2 ‚Üí —Å–µ–π—á–∞—Å $1.50 (–Ω–æ –ø–∏–∫ –±—ã–ª $4.8 –Ω–∞ +140%).
Mantle —Å–µ–π—á–∞—Å –Ω–∞ –≤–æ–ª–Ω–µË™çÁü• = —Å–ø—Ä–æ—Å –æ—Ç –Ω–æ–≤—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤. –ó–∞ –º–µ—Å—è—Ü –º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –Ω–∞ 30-100%.
–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: —Ç–æ–ø-30 —Å—Ç–∞—Ç—É—Å –æ–±—ã—á–Ω–æ = –Ω–∞—á–∞–ª–æ —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã –Ω–∞ 2-5x –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª."

"$2.2B TVL - –∫—Ä—É–ø–Ω–µ–π—à–∏–π ZK Rollup" ‚Üí
"–û–≥—Ä–æ–º–Ω—ã–π TVL = –¥–µ–Ω—å–≥–∏ –≥–æ–ª–æ—Å—É—é—Ç –∑–∞ –ø—Ä–æ–µ–∫—Ç. $2.2B > Arbitrum (–±—ã–ª $500M –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ —Ä–æ—Å–ª–∞ 10x) > Optimism ($1.5B).
–ú–∞–Ω–∞–∂: —Ç–∞–∫–æ–π TVL –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π. –ö–æ–≥–¥–∞ TVL —Ä–∞—Å—Ç–µ—Ç = –æ–±—ã—á–Ω–æ —Ä–∞—Å—Ç–µ—Ç –∏ —Ü–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞.
–ò—Å—Ç–æ—Ä–∏—è: –∫–æ–≥–¥–∞ Arbitrum TVL —Ä–æ—Å —Å $100M –¥–æ $1B, —Ü–µ–Ω–∞ –≤—ã—Ä–æ—Å–ª–∞ 400%. Mantle —É–∂–µ –Ω–∞ $2.2B = –∏–Ω—Ç–µ—Ä–µ—Å —Å–µ—Ä—å–µ–∑–Ω—ã–π."

"977K —Ç—Ä–µ–π–¥–µ—Ä–æ–≤ –Ω–∞ Bybit —Å $77.84B –≥–æ–¥–æ–≤—ã–º –æ–±—ä–µ–º–æ–º" ‚Üí
"–≠—Ç–æ –Ω–µ –º–∞–ª–µ–Ω—å–∫–∏–π –≤–æ–ª–∏–º! –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: —Å—Ä–µ–¥–Ω–∏–π –∞–ª—å—Ç–∫–æ–π–Ω –∏–º–µ–µ—Ç $500M –æ–±—ä–µ–º–∞. Mantle –≤ 155x –±–æ–ª—å—à–µ!
–¢–∞–∫–æ–π –æ–±—ä–µ–º = –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã –∏ whales —Ç–æ—Ä–≥—É—é—Ç. $2.78B –ø–∏–∫–æ–≤—ã–π –¥–Ω–µ–≤–Ω–æ–π –æ–±—ä–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ —ç—Ç–æ –°–ï–†–¨–ï–ó–ù–´–ô –∞–∫—Ç–∏–≤.
–í—ã–≤–æ–¥: –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤ —Ç–∞–∫–æ–≥–æ –æ–±—ä–µ–º–∞ = —Ü–µ–Ω–∞ –æ–±—ã—á–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ —Ä–∞—Å—Ç–µ—Ç –±–µ–∑ –º–∞—Å–∏–≤–Ω—ã—Ö –¥–∞–º–ø–æ–≤."

üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
‚úÖ –ú–ò–ù–ò–ú–£–ú 600 —Å–∏–º–≤–æ–ª–æ–≤ (—Å–µ—Ä—å–µ–∑–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –Ω–µ –±–æ–ª—Ç–æ–≤–Ω—è)
‚úÖ –ú–ò–ù–ò–ú–£–ú 3 —Ä–∞–∑–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏–∑ –Ω–æ–≤–æ—Å—Ç–∏ (–Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ —Ü–∏—Ñ—Ä!)
‚úÖ –ú–ò–ù–ò–ú–£–ú 1 –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–æ–≥–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü—Ä–æ–≥–Ω–æ–∑ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ (–º–æ–≥–ª–æ –≤—ã—Ä–∞—Å—Ç–∏ –Ω–∞ XX%, –æ–∂–∏–¥–∞–µ–º –æ—Ç–∫–∞—Ç –Ω–∞ XX%)
‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: "–î–µ–π—Å—Ç–≤–∏–µ:" - —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–æ—Ä—É (BUY? HOLD? WATCH?)
‚úÖ –ù–ò–ö–ê–ö–ò–• —Ñ—Ä–∞–∑: "–Ω–µ–ª—å–∑—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å", "—Ä—ã–Ω–æ–∫ —Å–ª–æ–∂–Ω—ã–π", "—Å–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏"

üí° –ì–õ–ê–í–ù–ê–Ø –ò–î–ï–Ø: 
–ò–Ω–≤–µ—Å—Ç–æ—Ä –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –ü–û–ù–ò–ú–ê–¢–¨:
- –ü–æ—á–µ–º—É —ç—Ç–∞ –Ω–æ–≤–æ—Å—Ç—å –≤–∞–∂–Ω–∞ –¥–ª—è –¶–ï–ù–´ —Ç–æ–∫–µ–Ω–∞
- –ö–∞–∫–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç
- –ß—Ç–æ –ö–û–ù–ö–†–ï–¢–ù–û –µ–º—É –¥–µ–ª–∞—Ç—å (–∫—É–ø–∏—Ç—å? –ø—Ä–æ–¥–∞—Ç—å? –∂–¥–∞—Ç—å?)

‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:
–ï—Å–ª–∏ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ —ç—Ç–æ..." = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û.
–ï—Å–ª–∏ –Ω–µ—Ç —Ü–∏—Ñ—Ä –∏–∑ –Ω–æ–≤–æ—Å—Ç–∏ = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û.
–ï—Å–ª–∏ < 400 —Å–∏–º–≤–æ–ª–æ–≤ = –°–õ–ò–®–ö–û–ú –ö–û–†–û–¢–ö–û."""


def should_mention_developer(user_message: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω–æ –ª–∏ —É–ø–æ–º—è–Ω—É—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."""
    # –¢–æ–ª—å–∫–æ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ–Ω—Ç–∞–∫—Ç—ã
    keywords = [
        "–∞–¥–º–∏–Ω", "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "–æ—à–∏–±–∫–∞", "–±–∞–≥", "–ø—Ä–æ–±–ª–µ–º–∞",
        "–∫–æ–Ω—Ç–∞–∫—Ç", "–ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–ø–æ–º–æ—â—å"
    ]
    
    message_lower = user_message.lower()
    return any(keyword in message_lower for keyword in keywords)


def build_context_for_prompt(context_history: List[dict]) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏.
    
    ‚úÖ FIXED: –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç List[dict] –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    """
    if not context_history:
        return ""
    
    context_lines = []
    for msg in context_history[-10:]:
        try:
            if not isinstance(msg, dict):
                continue
                
            msg_type = msg.get('role', 'user')
            content = msg.get('content', '')
            
            # –£–≤–µ–ª–∏—á–µ–Ω–∞ –¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–±—ã–ª–æ 150)
            if isinstance(content, str):
                content = content[:300]
            else:
                content = str(content)[:300] if content else ''
            
            if msg_type == 'user':
                context_lines.append(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {content}")
            else:
                context_lines.append(f"–ü–æ–º–æ—â–Ω–∏–∫: {content}")
        except Exception as e:
            logger.debug(f"‚ö†Ô∏è Error processing message in context: {e}")
            continue
    
    if context_lines:
        return "–ò–°–¢–û–†–ò–Ø:\n" + "\n".join(context_lines) + "\n\n"
    return ""


def get_ai_response_sync(
    user_message: str,
    context_history: List[dict] = None,
    timeout: float = TIMEOUT,
    user_id: Optional[int] = None,  # ‚úÖ –ù–û–í–û–ï: –¥–ª—è rate limiting
    message_context: dict = None  # ‚úÖ –ù–û–í–û–ï v0.27: –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (from analyze_message_context)
) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò —Å multi-provider fallback —Å–∏—Å—Ç–µ–º–æ–π.
    
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è AI –æ—Ç–≤–µ—Ç–æ–≤. –ü—Ä–æ–±—É–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ:
    Groq ‚Üí Mistral ‚Üí Gemini ‚Üí Fallback.
    
    Args:
        user_message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (max 4000 chars)
        context_history (List[dict]): –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç: {"role": "user"|"assistant", "content": str}
        timeout (float): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ (—Å–µ–∫—É–Ω–¥—ã, default 15)
        user_id (Optional[int]): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è rate limiting –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        message_context (Optional[dict]): –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç analyze_message_context()
            –°–æ–¥–µ—Ä–∂–∏—Ç: {"type": "...", "is_geopolitical": bool, "needs_crypto_analysis": bool, ...}
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –≥–µ–æ–ø–æ–ª–∏—Ç–∏–∫–∏)
        
    Returns:
        Optional[str]: AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ None –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
        
    AI Providers (Fallback Chain):
        1. Groq (Primary)
           - Model: llama-3.3-70b-versatile
           - Speed: ~100ms
           - Cost: Free
           - Reliability: 99.5%
           
        2. Mistral (First Fallback)
           - Model: mistral-large-latest
           - Speed: ~500ms
           - Cost: Free
           - Reliability: 99%
           
        3. Gemini (Last Resort)
           - Model: gemini-2.5-flash
           - Speed: ~1000ms
           - Cost: Free (limited to 20 req/day)
           - Reliability: 98%
           
        4. Fallback Response
           - Returns template response when all fail
           - Uses request metrics for intelligent fallback
    
    Features:
        ‚úÖ Automatic retries with exponential backoff (1s, 2s, 4s)
        ‚úÖ Context awareness: –ü–æ–º–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        ‚úÖ Rate limiting: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
        ‚úÖ Metrics tracking: –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç provider, time, tokens
        ‚úÖ Error handling: Graceful degradation
        ‚úÖ Timeout protection: –ù–µ –∑–∞–≤–∏—Å–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç fallback
        
    Rate Limiting:
        - 30 requests per minute per user
        - Configurable via environment
        - Returns error message if exceeded
        - Limits per provider: Groq (60/min), Mistral (30/min), Gemini (20/day)
        
    Performance:
        - P50: 150ms (Groq with context)
        - P95: 500ms (Mistral)
        - P99: 2000ms (Gemini or fallback)
        
    Examples:
        >>> response = get_ai_response_sync(
        ...     user_message="–û–±—ä—è—Å–Ω–∏ Bitcoin",
        ...     context_history=[{"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç"}],
        ...     user_id=123456
        ... )
        >>> print(response)
        "Bitcoin - —ç—Ç–æ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞..."
        
    Side Effects:
        - Logs request to structured_logger
        - Updates request metrics
        - Increments provider-specific counters
        - May increment rate_limit counter if user exceeded limit
    """
    
    context_history = context_history or []
    request_start_time = time.time()
    
    # ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ AI
    if user_id is not None:
        is_allowed, remaining, limit_message = check_ai_rate_limit(user_id)
        if not is_allowed:
            logger.warning(f"‚õî Rate limit exceeded for user {user_id}")
            return limit_message  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç - –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—Ä–æ–º–ø—Ç —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    context_str = build_context_for_prompt(context_history)
    
    # ‚úÖ v0.31: –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ò–ò
    ai_mode = "dialogue"  # Default —Ä–µ–∂–∏–º
    
    # ‚úÖ v0.31: –†–ï–ñ–ò–ú –û–ë–†–ê–ë–û–¢–ö–ò –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–û–ì–û –ö–ê–õ–ï–ù–î–ê–†–Ø - –ø–µ—Ä–≤—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    if CALENDAR_PROCESSOR_AVAILABLE and detect_calendar_input(user_message):
        system_prompt = build_calendar_processing_prompt()
        ai_mode = "calendar"
        logger.info(f"üìÖ Using CALENDAR PROCESSING prompt - detected economic calendar")
        logger.debug(f"   Calendar processor enabled: {CALENDAR_PROCESSOR_AVAILABLE}")
        logger.debug(f"   Calendar prompt length: {len(system_prompt)} chars")
    # ‚úÖ v0.30: Choose right prompt based on message context
    elif message_context and message_context.get("is_geopolitical"):
        system_prompt = build_geopolitical_analysis_prompt()
        ai_mode = "geopolitical"
        logger.info(f"üåç Using GEOPOLITICAL prompt for question type: {message_context.get('type')}")
        logger.info(f"   Message context: {message_context}")
        logger.debug(f"   Geopolitical prompt length: {len(system_prompt)} chars")
    elif message_context and message_context.get("needs_crypto_analysis") and message_context.get("type", "").startswith("crypto"):
        # –î–ª—è –∫—Ä–∏–ø—Ç–æ-–Ω–æ–≤–æ—Å—Ç–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∞–Ω–∞–ª–∏–∑–∞
        system_prompt = build_crypto_news_analysis_prompt()
        ai_mode = "crypto_news"
        logger.info(f"üìä Using CRYPTO NEWS ANALYSIS prompt for question type: {message_context.get('type')}")
        logger.info(f"   Message context: {message_context}")
        logger.debug(f"   Crypto prompt length: {len(system_prompt)} chars")
    else:
        system_prompt = build_dialogue_system_prompt()  # ‚úÖ FIXED: Using correct full prompt instead of short version
        ai_mode = "dialogue"
        logger.info(f"üí¨ Using DIALOGUE prompt")
        if message_context:
            logger.debug(f"   Message context: {message_context}")
    
    # ‚úÖ v0.31: –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
    ai_params = get_ai_params(ai_mode)
    max_tokens = ai_params["max_tokens"]
    temperature = ai_params["temperature"]
    top_p = ai_params["top_p"]
    
    # ‚úÖ DEBUG: –õ–æ–≥–∏—Ä—É–µ–º —á—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    if context_history:
        logger.info(f"üìù Context received: {len(context_history)} messages")
        if context_str:
            logger.debug(f"   History ({len(context_str)} chars): {context_str[:150]}...")
        else:
            logger.warning(f"‚ö†Ô∏è Context is EMPTY despite {len(context_history)} messages in list!")
    else:
        logger.debug(f"‚ÑπÔ∏è No context history (first message or empty)")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞ (RVX context —É–∂–µ –≤ system_prompt)
    full_prompt = f"{system_prompt}\n\n{context_str}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_message}"
    
    # ==================== –ü–û–ü–´–¢–ö–ê 1: GROQ ====================
    if GROQ_API_KEY:
        provider_start = time.time()
        logger.info(f"üîÑ Groq: –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç...")
        try:
            with httpx.Client(verify=True) as client:  # ‚úÖ CRITICAL FIX #7: Explicit TLS verification
                response = client.post(
                    GROQ_API_URL,
                    headers={
                        "Authorization": f"Bearer {GROQ_API_KEY}",
                        "Content-Type": "application/json"
                    },
                    json={
                        "model": GROQ_MODEL,
                        "messages": [
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": f"{context_str}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_message}"}
                        ],
                        "temperature": temperature,
                        "max_tokens": max_tokens,
                        "top_p": top_p
                    },
                    timeout=timeout
                )
                
                provider_time = time.time() - provider_start
                logger.debug(f"üìä Groq HTTP: {response.status_code} ({provider_time:.2f}s)")
                
                if response.status_code == 200:
                    data = response.json()
                    if data.get("choices") and len(data["choices"]) > 0:
                        ai_response = data["choices"][0]["message"]["content"].strip()
                        if ai_response:
                            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
                            ai_response = clean_hallucinations(ai_response)
                            
                            # ‚úÖ v0.31: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ –ª–∏–º–∏—Ç—É —Ä–µ–∂–∏–º–∞
                            ai_response = trim_response_to_limit(ai_response, ai_mode)
                            
                            update_metrics("groq", True, provider_time)
                            logger.info(f"‚úÖ Groq OK ({len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤, {provider_time:.2f}s)")
                            return ai_response
                        else:
                            logger.warning(f"‚ö†Ô∏è  Groq: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
                            update_metrics("groq", False, provider_time)
                    else:
                        logger.warning(f"‚ö†Ô∏è  Groq: –Ω–µ—Ç choices –≤ –æ—Ç–≤–µ—Ç–µ")
                        update_metrics("groq", False, provider_time)
                else:
                    logger.warning(f"‚ö†Ô∏è  Groq HTTP {response.status_code}")
                    update_metrics("groq", False, provider_time)
                    
        except httpx.TimeoutException:
            provider_time = time.time() - provider_start
            logger.warning(f"‚è±Ô∏è  Groq: Timeout ({provider_time:.2f}s)")
            update_metrics("groq", False, provider_time, error_type="timeout")
        except Exception as e:
            provider_time = time.time() - provider_start
            logger.warning(f"‚ùå Groq –æ—à–∏–±–∫–∞: {type(e).__name__}: {str(e)[:100]}")
            update_metrics("groq", False, provider_time)
    else:
        logger.warning("‚ö†Ô∏è  GROQ_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    # ==================== –ü–û–ü–´–¢–ö–ê 2: MISTRAL ====================
    if MISTRAL_API_KEY and MISTRAL_API_KEY != "–ó–ê–ú–ï–ù–ò_–ù–ê_–ö–õ–Æ–ß_–ò–ó_MISTRAL":
        provider_start = time.time()
        logger.info(f"üîÑ Mistral: –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç (fallback 1)...")
        try:
            with httpx.Client(verify=True) as client:  # ‚úÖ CRITICAL FIX #7: Explicit TLS verification
                response = client.post(
                    MISTRAL_API_URL,
                    headers={
                        "Authorization": f"Bearer {MISTRAL_API_KEY}",
                        "Content-Type": "application/json"
                    },
                    json={
                        "model": MISTRAL_MODEL,
                        "messages": [
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": f"{context_str}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_message}"}
                        ],
                        "temperature": temperature,
                        "max_tokens": max_tokens,
                        "top_p": top_p
                    },
                    timeout=timeout
                )
                
                provider_time = time.time() - provider_start
                logger.debug(f"üìä Mistral HTTP: {response.status_code}")
                
                if response.status_code == 200:
                    data = response.json()
                    if data.get("choices") and len(data["choices"]) > 0:
                        ai_response = data["choices"][0]["message"]["content"].strip()
                        if ai_response:
                            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
                            ai_response = clean_hallucinations(ai_response)
                            
                            # ‚úÖ v0.31: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ –ª–∏–º–∏—Ç—É —Ä–µ–∂–∏–º–∞
                            ai_response = trim_response_to_limit(ai_response, ai_mode)
                            
                            update_metrics("mistral", True, provider_time)
                            logger.info(f"‚úÖ Mistral OK ({len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤, {provider_time:.2f}s)")
                            return ai_response
                        else:
                            logger.warning(f"‚ö†Ô∏è  Mistral: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
                            update_metrics("mistral", False, provider_time)
                else:
                    logger.warning(f"‚ö†Ô∏è  Mistral HTTP {response.status_code}")
                    update_metrics("mistral", False, provider_time)
                    
        except httpx.TimeoutException:
            provider_time = time.time() - provider_start
            logger.warning(f"‚è±Ô∏è  Mistral: Timeout")
            update_metrics("mistral", False, provider_time, error_type="timeout")
        except Exception as e:
            provider_time = time.time() - provider_start
            logger.warning(f"‚ùå Mistral –æ—à–∏–±–∫–∞: {type(e).__name__}: {str(e)[:100]}")
            update_metrics("mistral", False, provider_time)
    else:
        logger.debug("‚è≠Ô∏è  Mistral: –ü—Ä–æ–ø—É—â–µ–Ω (–∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")
    
    # ==================== –ü–û–ü–´–¢–ö–ê 3: GEMINI ====================
    if GEMINI_API_KEY:
        provider_start = time.time()
        logger.info(f"üîÑ Gemini: –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç (fallback 2)...")
        try:
            url = f"{GEMINI_API_BASE}/{GEMINI_MODEL}:generateContent?key={GEMINI_API_KEY}"
            
            with httpx.Client(verify=True) as client:  # ‚úÖ CRITICAL FIX #7: Explicit TLS verification
                response = client.post(
                    url,
                    json={
                        "contents": [{
                            "parts": [{
                                "text": full_prompt
                            }]
                        }],
                        "generationConfig": {
                            "temperature": temperature,
                            "maxOutputTokens": int(max_tokens * 0.1),  # Gemini –∏–º–µ–µ—Ç –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç
                            "topP": top_p
                        }
                    },
                    timeout=timeout
                )
                
                provider_time = time.time() - provider_start
                logger.debug(f"üìä Gemini HTTP: {response.status_code}")
                
                if response.status_code == 200:
                    data = response.json()
                    candidates = data.get("candidates", [])
                    if candidates and candidates[0].get("content", {}).get("parts"):
                        ai_response = candidates[0]["content"]["parts"][0].get("text", "").strip()
                        if ai_response:
                            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
                            ai_response = clean_hallucinations(ai_response)
                            
                            # ‚úÖ v0.31: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ –ª–∏–º–∏—Ç—É —Ä–µ–∂–∏–º–∞
                            ai_response = trim_response_to_limit(ai_response, ai_mode)
                            
                            update_metrics("gemini", True, provider_time)
                            logger.info(f"‚úÖ Gemini OK ({len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤, {provider_time:.2f}s)")
                            return ai_response
                        else:
                            logger.warning(f"‚ö†Ô∏è  Gemini: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
                            update_metrics("gemini", False, provider_time)
                else:
                    logger.warning(f"‚ö†Ô∏è  Gemini HTTP {response.status_code}")
                    update_metrics("gemini", False, provider_time)
                    
        except httpx.TimeoutException:
            provider_time = time.time() - provider_start
            logger.warning(f"‚è±Ô∏è  Gemini: Timeout")
            update_metrics("gemini", False, provider_time, error_type="timeout")
        except Exception as e:
            provider_time = time.time() - provider_start
            logger.warning(f"‚ùå Gemini –æ—à–∏–±–∫–∞: {type(e).__name__}: {str(e)[:100]}")
            update_metrics("gemini", False, provider_time)
    else:
        logger.debug("‚è≠Ô∏è  Gemini: –ü—Ä–æ–ø—É—â–µ–Ω (–∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")
    
    # ==================== –í–°–ï –ü–†–û–í–ê–ô–î–ï–†–´ –ù–ï–î–û–°–¢–£–ü–ù–´ ====================
    logger.error(f"‚ùå –í–°–ï –ü–†–û–í–ê–ô–î–ï–†–´ –ù–ï–î–û–°–¢–£–ü–ù–´!")
    logger.error(f"   Groq: {'‚úÖ' if GROQ_API_KEY else '‚ùå'}")
    logger.error(f"   Mistral: {'‚úÖ' if MISTRAL_API_KEY and MISTRAL_API_KEY != '–ó–ê–ú–ï–ù–ò_–ù–ê_–ö–õ–Æ–ß_–ò–ó_MISTRAL' else '‚ùå'}")
    logger.error(f"   Gemini: {'‚úÖ' if GEMINI_API_KEY else '‚ùå'}")
    return None


# ==================== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ====================

if __name__ == "__main__":
    pass
    
    logging.basicConfig(
        level=logging.INFO,
        format='%(levelname)s: %(message)s'
    )
    
    print("\n" + "="*70)
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï AI DIALOGUE v0.23")
    print("="*70 + "\n")
    
    tests = [
        ("–ß—Ç–æ —Ç–∞–∫–æ–µ Bitcoin?", []),
        ("–ü–æ—á–µ–º—É?", [{"type": "bot", "content": "Bitcoin —ç—Ç–æ –≤–∞–ª—é—Ç–∞"}]),
        ("–ü—Ä–∏–≤–µ—Ç!", []),
    ]
    
    for msg, ctx in tests:
        print(f"üìù –¢–µ—Å—Ç: '{msg}'")
        response = get_ai_response_sync(msg, ctx)
        if response:
            print(f"‚úÖ –û—Ç–≤–µ—Ç: {response[:80]}...\n")
        else:
            print(f"‚ùå –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞\n")
    
    print("="*70 + "\n")

# v0.32.4 - Tell More Handler Bug Fixes üîß

## üêõ –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. **Timeout (8618 —Å–µ–∫ = 2+ —á–∞—Å–∞)**
   - ‚ùå **–ë—ã–ª–æ**: Handler –Ω–µ –∏–º–µ–ª —Ç–∞–π–º–∞—É—Ç–∞
   - ‚úÖ **–¢–µ–ø–µ—Ä—å**: 60-—Å–µ–∫—É–Ω–¥–Ω—ã–π timeout —Å graceful error handling
   ```python
   expanded_analysis, proc_time, error = await asyncio.wait_for(
       call_api_with_retry(expand_prompt),
       timeout=60  # 60 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
   )
   ```

### 2. **–°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ**
   - ‚ùå **–ë—ã–ª–æ**: HTML —Ç–µ–≥–∏ –≤ prompt'–µ –º–æ–≥–ª–∏ —Å–º–µ—à–∞—Ç—å—Å—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
   - ‚úÖ **–¢–µ–ø–µ—Ä—å**: Prompt –æ—á–∏—â–µ–Ω –æ—Ç HTML —Ç–µ–≥–æ–≤
   ```python
   # –ë—ã–ª–æ: f"<b>–ò—Å—Ö–æ–¥–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å:</b>\n{last_original}"
   # –¢–µ–ø–µ—Ä—å: f"–ù–û–í–û–°–¢–¨:\n{last_original}"
   ```

### 3. **–ü—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**
   - ‚ùå **–ë—ã–ª–æ**: –û—à–∏–±–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `not expanded_analysis`
   - ‚úÖ **–¢–µ–ø–µ—Ä—å**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –ø—É—Å—Ç–æ—Ç—É –ø–æ—Å–ª–µ strip()
   ```python
   if not expanded_analysis or expanded_analysis.strip() == "":
       # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º user-friendly –æ—à–∏–±–∫—É
   ```

### 4. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ Telegram (4096 —Å–∏–º–≤–æ–ª–æ–≤)**
   - ‚ùå **–ë—ã–ª–æ**: –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–≥ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è
   - ‚úÖ **–¢–µ–ø–µ—Ä—å**: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 3800 —Å–∏–º–≤–æ–ª–æ–≤
   ```python
   if len(expanded_analysis) > max_length:
       expanded_analysis = expanded_analysis[:max_length] + "\n\n[... –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è]"
   ```

### 5. **–ü–ª–æ—Ö–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**
   - ‚ùå **–ë—ã–ª–æ**: –ü—Ä–æ—Å—Ç–æ–µ "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∞–Ω–∞–ª–∏–∑–∞"
   - ‚úÖ **–¢–µ–ø–µ—Ä—å**: –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫:
     - "‚è±Ô∏è –ê–Ω–∞–ª–∏–∑ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π" (timeout)
     - "‚ùå –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç" (empty response)
     - "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ" (–¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏)

### 6. **–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ**
   - ‚ùå **–ë—ã–ª–æ**: HTML —Ç–µ–≥–∏ –º–æ–≥–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è –≤ –æ—Ç–≤–µ—Ç–µ
   - ‚úÖ **–¢–µ–ø–µ—Ä—å**: –ß–∏—Å—Ç–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
   ```python
   expanded_analysis = expanded_analysis.replace("<b>", "**").replace("</b>", "**")
   expanded_analysis = expanded_analysis.replace("<i>", "_").replace("</i>", "_")
   ```

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —É–ª—É—á—à–µ–Ω–æ –≤ v0.32.4

### Tell More Handler
```python
if data.startswith("tell_more_"):
    # 1. Parse callback
    # 2. Get context from user_data
    # 3. Validate context exists
    
    # 4. ‚úÖ Generate clean prompt (no HTML tags)
    expand_prompt = f"–ù–û–í–û–°–¢–¨:\n{last_original}\n\n–ü–†–ï–î–´–î–£–©–ò–ô –ê–ù–ê–õ–ò–ó:\n{last_analysis}"
    
    # 5. ‚úÖ Call API with timeout protection
    try:
        expanded_analysis, proc_time, error = await asyncio.wait_for(
            call_api_with_retry(expand_prompt),
            timeout=60
        )
    except asyncio.TimeoutError:
        # ‚úÖ Handle timeout gracefully
        await query.edit_message_text("‚è±Ô∏è –ê–Ω–∞–ª–∏–∑ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π...")
        return
    
    # 6. ‚úÖ Validate response
    if not expanded_analysis or expanded_analysis.strip() == "":
        # ‚úÖ Handle empty response
        await query.edit_message_text("‚ùå –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç...")
        return
    
    # 7. ‚úÖ Clean artifacts and limit length
    expanded_analysis = expanded_analysis.strip()
    expanded_analysis = expanded_analysis.replace("<b>", "**")
    if len(expanded_analysis) > 3800:
        expanded_analysis = expanded_analysis[:3800] + "[... –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è]"
    
    # 8. ‚úÖ Format and send response
    # 9. ‚úÖ Add navigation buttons
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
```
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç [üìñ –†–∞—Å—Å–∫–∞–∂–∏ –µ—â–µ]
‚úÖ Handler –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚úÖ –§–æ—Ä–º–∏—Ä—É–µ—Ç clean prompt
‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç API (—Å —Ç–∞–π–º–∞—É—Ç–æ–º 60—Å)
‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑
‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
‚è±Ô∏è –í—Ä–µ–º—è: 2-5 —Å–µ–∫—É–Ω–¥ (–≤–º–µ—Å—Ç–æ 8618!)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: API —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
```
‚è≥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–µ—Ç... (>60 —Å–µ–∫)
‚è±Ô∏è Timeout —Å—Ä–∞–±–æ—Ç–∞–ª
‚ùå –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π"
‚úÖ –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```
üîç API –æ–±—Ä–∞–±–æ—Ç–∞–ª –∑–∞–ø—Ä–æ—Å, –Ω–æ –≤–µ—Ä–Ω—É–ª ""
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –ø—É—Å—Ç–æ—Ç—É
‚ùå –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
```
üìù API –≤–µ—Ä–Ω—É–ª 5000 —Å–∏–º–≤–æ–ª–æ–≤
‚úÖ –û–±—Ä–µ–∑–∞–µ–º –¥–æ 3800
üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Å–ø–µ—à–Ω–æ –≤ Telegram
‚ö†Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "[... –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è]"
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –ß—Ç–æ | –ë—ã–ª–æ | –¢–µ–ø–µ—Ä—å |
|-----|------|--------|
| –¢–∞–π–º–∞—É—Ç | ‚ùå –ù–µ—Ç | ‚úÖ 60 —Å–µ–∫ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ | –ë–∞–∑–æ–≤–∞—è | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è |
| –ß–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| –õ–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤ | ‚ùå –ù–µ—Ç | ‚úÖ 3800 |
| –û—à–∏–±–∫–∏ | –û–±—â–∏–µ | –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ |
| Logging | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | –î–µ—Ç–∞–ª—å–Ω–æ–µ |
| Fallback UI | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- üéØ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 8618 ‚Üí 2-5 —Å–µ–∫
- üíØ –ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: –≤–º–µ—Å—Ç–æÊ∑∑Âêà—Ç–µ–∫—Å—Ç–æ–≤ ‚Üí —á–∏—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
- üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å: –æ—Ç —Å–±–æ–µ–≤ ‚Üí graceful errors
- üì± –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –æ—Ç –æ—à–∏–±–æ–∫ Telegram ‚Üí —É—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

## üöÄ Deployment

```
Commit: 05ec698
Branch: main
Deployed to: Railway (auto-rebuild started)
Status: ‚úÖ Ready for testing
```

## üß™ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π**
   ```
   –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å ‚Üí –ê–Ω–∞–ª–∏–∑ ‚Üí –ù–∞–∂–∞—Ç—å [üìñ –†–∞—Å—Å–∫–∞–∂–∏ –µ—â–µ]
   ‚úÖ –û–∂–∏–¥–∞—Ç—å: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞ 2-5 —Å–µ–∫
   ```

2. **–¢–∞–π–º–∞—É—Ç (–µ—Å–ª–∏ API –º–µ–¥–ª–µ–Ω–Ω—ã–π)**
   ```
   –ù–∞–∂–∞—Ç—å [üìñ –†–∞—Å—Å–∫–∞–∂–∏ –µ—â–µ] (–º–µ–¥–ª–µ–Ω–Ω—ã–π API)
   ‚úÖ –û–∂–∏–¥–∞—Ç—å: –û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ 60 —Å–µ–∫ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
   ```

3. **–î–ª–∏–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**
   ```
   –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –Ω–æ–≤–æ—Å—Ç—å
   ‚úÖ –û–∂–∏–¥–∞—Ç—å: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–æ "... –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è]"
   ```

---

**–í–µ—Ä—Å–∏—è**: v0.32.4  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **Ready for testing on Railway**  
**–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**: Timeout protection, better error handling, response validation

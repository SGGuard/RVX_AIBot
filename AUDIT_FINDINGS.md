# üîç –ê–£–î–ò–¢ –ö–û–î–ê RVX Bot - 10 –î–µ–∫–∞–±—Ä—è 2025

## üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (–ë–õ–û–ö–ò–†–£–Æ–©–ò–ï)

#### 1. **Duplicate Bot Instances** 
- **–û—à–∏–±–∫–∞:** `Conflict: terminated by other getUpdates request`
- **–ì–¥–µ:** Railway –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã getUpdates
- **–ü—Ä–∏—á–∏–Ω–∞:** Procfile –∑–∞–ø—É—Å–∫–∞–µ—Ç –¥–≤–∞ –∏–Ω—Å—Ç–∞–Ω—Å–∞ —Å –æ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º
- **–¢–µ–∫—É—â–∏–π Procfile:** `web: bash -c 'python bot.py > /tmp/bot.log 2>&1 &' && python api_server.py`
- **–ü—Ä–æ–±–ª–µ–º–∞:** Background –ø—Ä–æ—Ü–µ—Å—Å bot.py –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã
- **–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webhook –≤–º–µ—Å—Ç–æ polling –ò–õ–ò –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å

#### 2. **API Connection Failures in teacher.py**
- **–û—à–∏–±–∫–∞:** `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Ä–æ–∫–∞: All connection attempts failed`
- **–ì–¥–µ:** teacher.py line 328, async function teach_lesson()
- **–ü—Ä–∏—á–∏–Ω–∞:** 
  - `API_BASE_URL = os.getenv("API_URL_NEWS", "...").rsplit("/", 1)[0]`
  - –ù–∞ Railway –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL —Ñ–æ—Ä–º–∞—Ç
  - API —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- **–¢–µ–∫—É—â–∏–π –∫–æ–¥:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç httpx.AsyncClient –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ /teach_lesson
- **–ü—Ä–æ–±–ª–µ–º–∞:** –û–±—Ä–µ–∑–∞–Ω–∏–µ URL –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ URL (urljoin –≤–º–µ—Å—Ç–æ rsplit)

#### 3. **undefined `aspect` Variable in Button Callback**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–º–º–∏—Ç–µ f730d54
- **–ë—ã–ª–æ:** NameError –Ω–∞ line 8731
- **–¢–µ–ø–µ—Ä—å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç aspect_emoji –Ω–∞–ø—Ä—è–º—É—é

---

### üü° –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–ù–ï–ö–†–ò–¢–ò–ß–ù–´–ï –ù–û –°–ï–†–¨–Å–ó–ù–´–ï)

#### 4. **Database Schema Mismatch**
- **–û—à–∏–±–∫–∞:** `sqlite3.OperationalError: table conversation_history has no column named message_type`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–º–º–∏—Ç–µ af0bbbb –∏ 8bb7147
- **–ë—ã–ª–æ:** –°—Ç–∞—Ä–∞—è –ë–î –±–µ–∑ –Ω–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
- **–¢–µ–ø–µ—Ä—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ NULL –∑–Ω–∞—á–µ–Ω–∏–π —Å fallback

#### 5. **Missing EventType Enums**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–º–º–∏—Ç–µ f730d54
- **–ë—ã–ª–æ:** `AttributeError: type object 'EventType' has no attribute 'USER_TEACH'`
- **–¢–µ–ø–µ—Ä—å:** –î–æ–±–∞–≤–ª–µ–Ω–æ USER_TEACH –≤ enum

#### 6. **Incomplete Handler Implementations**
- **–ì–¥–µ:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π –≤ bot.py –∏–º–µ—é—Ç –ø—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- **–ü—Ä–∏–º–µ—Ä—ã:**
  - Feedback handlers - –ø—É—Å—Ç—ã–µ –ª–æ–≥–∏, –Ω–µ—Ç BD —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  - Clarify button - —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë –æ—à–∏–±–∫–∏
  - Teach callbacks - —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ –ø–æ–ª–∞–≥–∞—é—Ç—Å—è –Ω–∞ API
- **–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### 7. **Groq AI Response Issues**
- **–ì–¥–µ:** ai_dialogue.py
- **–ü—Ä–æ–±–ª–µ–º–∞:** 
  - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Groq API (–º–æ–∂–µ—Ç –±—ã—Ç—å rate limiting)
  - –ù–µ—Ç fallback –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
  - –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –º–æ–≥—É—Ç –±—ã—Ç—å 
- **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º WARNING

---

### üü† –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø)

#### 8. **Database Migration Issues**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–º–º–∏—Ç–µ ec501e2
- **–ë—ã–ª–æ:** –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
- **–¢–µ–ø–µ—Ä—å:** ensure_conversation_history_columns() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –î–û init_database()

#### 9. **Conversation History Handling**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–º–º–∏—Ç–µ af0bbbb
- **–ë—ã–ª–æ:** –ö—Ä–∞—à–∏–ª–æ –Ω–∞ malformed –¥–∞–Ω–Ω—ã—Ö
- **–¢–µ–ø–µ—Ä—å:** Graceful fallback —Å empty list

#### 10. **Duplicate Message Bug**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–º–º–∏—Ç–µ 300d907
- **–ë—ã–ª–æ:** –û—Ç–ø—Ä–∞–≤–ª—è–ª 2 —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ 1
- **–¢–µ–ø–µ—Ä—å:** –û–±—ä–µ–¥–∏–Ω–µ–Ω–æ –≤ –æ–¥–Ω–æ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ù–∞–π–¥–µ–Ω–æ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –û—Å—Ç–∞–ª–æ—Å—å |
|-----------|---------|-----------|----------|
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ | 3 | 1 | 2 |
| –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç | 4 | 3 | 1 |
| –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç | 3 | 3 | 0 |
| **–ò—Ç–æ–≥–æ** | **10** | **7** | **3** |

---

## üîß –¢–†–ï–ë–£–ï–ú–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥)

### Priority 1: Fix API URL Building in teacher.py
```python
# ‚ùå –°–¢–ê–†–´–ô –ö–û–î (line 286)
API_BASE_URL = os.getenv("API_URL_NEWS", "...").rsplit("/", 1)[0]

# ‚úÖ –ù–û–í–´–ô –ö–û–î
from urllib.parse import urljoin, urlparse
parsed = urlparse(os.getenv("API_URL_NEWS", "http://localhost:8000/explain_news"))
API_BASE_URL = f"{parsed.scheme}://{parsed.netloc}"
TEACH_API_URL = f"{API_BASE_URL}/teach_lesson"
```

### Priority 2: Fix Duplicate Bot Instance Issue
```
# Procfile –¥–æ–ª–∂–µ–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å —Å –æ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º
# –û–ø—Ü–∏—è 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webhook –≤–º–µ—Å—Ç–æ polling
# –û–ø—Ü–∏—è 2: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ bot.py –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑
```

### Priority 3: Add API Fallback in teacher.py
- –ï—Å–ª–∏ /teach_lesson –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π prompt
- –ù–µ –∫—Ä–∞—à–∏—Ç—å –±–æ—Ç, –≤–µ—Ä–Ω—É—Ç—å graceful error

---

## ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û

- ‚úÖ Conversation history NULL handling (af0bbbb)
- ‚úÖ DB save error wrapping (8bb7147)  
- ‚úÖ Duplicate messages (300d907)
- ‚úÖ DB migration ordering (ec501e2)
- ‚úÖ EventType.USER_TEACH (f730d54)
- ‚úÖ Undefined aspect variable (f730d54)

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å API URL building –≤ teacher.py** ‚Üê NEXT
2. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å –±–æ—Ç–∞**  
3. **–î–æ–±–∞–≤–∏—Ç—å graceful fallback –¥–ª—è teach_lesson**
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Railway**

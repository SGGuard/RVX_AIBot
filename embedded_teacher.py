"""
Embedded Teaching System - генерирует качественные уроки без зависимости от внешнего AI
Заменяет fallback-режим на настоящий embedded AI с встроенным контентом
"""

from dataclasses import dataclass
from typing import Optional
import random

@dataclass
class EmbeddedLesson:
    """Встроенный урок с полной структурой"""
    lesson_title: str
    content: str
    key_points: list[str]
    real_world_example: str
    practice_question: str
    answer_hint: str
    next_topics: list[str]

# ============================================================================
# УРОКИ ПО ТОПИКАМ
# ============================================================================

EMBEDDED_CURRICULUM = {
    "bitcoin": {
        "beginner": EmbeddedLesson(
            lesson_title="Bitcoin: Цифровое золото",
            content="""Bitcoin был создан в 2009 году анонимным разработчиком Сатоши Накамото. 
Это первая успешная криптовалюта, которая решила проблему двойной траты без центрального органа.

Основные особенности Bitcoin:
• Максимальное количество - 21 миллион монет
• Блоки генерируются каждые ~10 минут
• Используется алгоритм SHA-256 для хэширования
• Сеть полностью децентрализована и отказоустойчива

Bitcoin функционирует как протокол денежного трансфера. Каждая транзакция проверяется майнерами,
которые получают награду за добавление нового блока в цепь. Это создает экономический стимул 
для честного поведения сети.""",
            key_points=[
                "Bitcoin - первая криптовалюта, решившая проблему двойной траты",
                "Максимальное предложение 21 млн BTC обеспечивает дефицит и ценность",
                "Proof-of-Work консенсус требует вычислительной работы для валидации блоков",
                "Блокчейн Bitcoin неизменяем и прозрачен - каждый может проверить историю транзакций"
            ],
            real_world_example="El Salvador в 2021 принял Bitcoin как законное средство платежа. Это показало, что криптовалюты могут быть реально использованы в экономике страны для расчетов и хранения стоимости.",
            practice_question="Почему Bitcoin не может быть инфляционным как обычные деньги?",
            answer_hint="Потому что максимальное количество BTC ограничено 21 миллионом монет и этот лимит заложен в протоколе.",
            next_topics=["ethereum", "blockchain", "mining"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="Bitcoin: Архитектура и Безопасность",
            content="""Bitcoin использует сложную криптографию для обеспечения безопасности. 
Каждая транзакция подписывается приватным ключом отправителя, что гарантирует, что только владелец может потратить свои монеты.

Механизм консенсуса Proof-of-Work (PoW):
• Майнеры конкурируют в решении сложной математической задачи
• Первый, кто найдет решение, добавляет новый блок и получает награду
• Сложность задачи автоматически регулируется каждые 2016 блоков

Атаки и их предотвращение:
• 51%-атака: требует контролировать 51% хэшрейта сети (экономически нецелесообразно)
• Double-spending: невозможна благодаря Proof-of-Work и иммутабельности блокчейна
• Replay-атака: предотвращается использованием цифровых подписей

Валидация блоков проверяет: подписи транзакций, балансы отправителей, и соответствие правилам консенсуса.""",
            key_points=[
                "ECDSA - эллиптическая криптография защищает приватные ключи",
                "Difficulty adjustment каждые 2 недели сохраняет время блока ~10 минут",
                "UTXO-модель отличается от account-модели - каждая монета отслеживается",
                "Майнеры получают системную награду (halving каждые 4 года) + комиссии за транзакции"
            ],
            real_world_example="Халвинг Bitcoin в 2024 году снизил награду за блок с 6.25 BTC до 3.125 BTC. Это событие поддерживает дефляционный характер Bitcoin и часто вызывает волатильность цены.",
            practice_question="Почему увеличение сложности майнинга делает Bitcoin безопаснее?",
            answer_hint="Потому что требует больше вычислительной работы для атаки на сеть, что делает её экономически нецелесообразной.",
            next_topics=["ethereum", "layer2", "defi"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="Bitcoin: Масштабирование и будущее",
            content="""Основная проблема Bitcoin - масштабируемость: сеть может обработать ~7 транзакций в секунду.
Это ограничение вызвано размером блока (1 МБ) и временем создания блока (10 минут).

Решения для масштабирования (Layer 2):

Lightning Network:
• Создает платежные каналы между участниками вне основной цепи
• Позволяет микротранзакции с минимальными комиссиями и задержками
• Пропускная способность исчисляется млн транзакций в секунду
• Позволяет платежи между участниками без блокчейна для каждой транзакции

Sidechain (Stacks, RSK):
• Отдельные блокчейны, которые периодически синхронизируются с Bitcoin
• Позволяют разные возможности (смарт-контракты на Stacks)
• Наследуют безопасность Bitcoin через пеггинг

Taproot и будущие обновления:
• Taproot (2021) улучшил приватность и эффективность скриптов
• Майнет 4 (в разработке) добавит больше функциональности""",
            key_points=[
                "Lightning Network решает проблему масштабируемости через платежные каналы",
                "Atomic swaps позволяют прямой обмен между Bitcoin и другими криптовалютами",
                "Taproot улучшил приватность, комбинируя Schnorr-сигнатуры",
                "Дальнейшее развитие Bitcoin может включить больше гибкости смарт-контрактов"
            ],
            real_world_example="Стальвийя внедрил Lightning Network для майнинга. Это позволило создать микротранзакции между майнерами почти без комиссий и мгновенно, демонстрируя практическую полезность Layer 2.",
            practice_question="Почему Lightning Network не требует записывать каждую транзакцию в блокчейн Bitcoin?",
            answer_hint="Потому что участники платежного канала могут обновлять свои балансы хэш-блокировкой, и на цепь записываются только открытие и закрытие канала.",
            next_topics=["ethereum", "sidechains", "defi_advanced"]
        )
    },
    "ethereum": {
        "beginner": EmbeddedLesson(
            lesson_title="Ethereum: Платформа для смарт-контрактов",
            content="""Ethereum запущен в 2015 году Виталиком Бутериным и значительно расширил возможности блокчейна.
В отличие от Bitcoin, Ethereum - это платформа для запуска программ (смарт-контрактов) на блокчейне.

Основные компоненты:
• EVM (Ethereum Virtual Machine) - виртуальная машина, которая выполняет код контрактов
• Smart Contracts - программы, которые автоматически выполняются когда условия выполнены
• Ether (ETH) - криптовалюта, используемая для оплаты комиссий (gas)
• Аккаунт-модель - у каждого адреса есть баланс, а не отслеживание монет

Что отличает Ethereum от Bitcoin:
• Полнота по Тьюрингу - на Ethereum можно создавать программы любой сложности
• Состояние (state) - Ethereum хранит состояние всех контрактов
• Gas - плата за выполнение каждой операции, что предотвращает бесконечные циклы

Ethereum использует Proof-of-Stake (начиная с 2022 года "The Merge"), где валидаторы выбираются на основе
количества поставленных (staked) токенов, а не вычислительной мощности.""",
            key_points=[
                "Ethereum позволяет создавать децентрализованные приложения (dApps) через смарт-контракты",
                "Gas-система предотвращает спам и бесконечные циклы кода",
                "Proof-of-Stake (PoS) более энергоэффективен чем Proof-of-Work",
                "Ether используется как валюта и как топливо для выполнения программ"
            ],
            real_world_example="Uniswap - децентрализованная биржа на Ethereum, позволяет торговать токенами без центрального органа. Смарт-контракты автоматически управляют ликвидностью и ценообразованием через AMM (Automated Market Maker).",
            practice_question="Почему неправильно написанный смарт-контракт с бесконечным циклом не создает проблему для сети Ethereum?",
            answer_hint="Потому что код просто закончится, когда деньги на счете исчерпаны (механизм Gas), что предотвращает бесконечное выполнение.",
            next_topics=["smart_contracts", "defi", "web3"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="Ethereum: Smart Contracts и Solidity",
            content="""Smart контракты - это программы, хранящиеся на блокчейне, которые автоматически выполняются 
при выполнении определенных условий. Большинство смарт-контрактов на Ethereum написаны на языке Solidity.

Solidity основы:
• Язык программирования похож на JavaScript и C++
• Контракты развертываются на адреса и имеют состояние
• Функции контракта могут быть вызваны любым адресом через транзакцию

Важные концепции:
• State variables - данные, которые сохраняются в блокчейне между вызовами
• Functions - вызываемый код, может читать/изменять состояние
• Events - логируют события, на которые могут подписаться приложения
• Visibility - public, private, internal, external

Gas и оптимизация:
• Каждая операция имеет стоимость в Gas (например, SSTORE стоит 20000 gas)
• Разработчики должны оптимизировать код, чтобы снизить стоимость
• Хранение данных (storage) дороже, чем вычисления (computation)

Безопасность контрактов - критична, так как ошибки могут привести к потере денег.""",
            key_points=[
                "Solidity требует тщательной обработки ошибок и безопасности кода",
                "Reentrancy - одна из самых опасных уязвимостей, позволяет воровать средства",
                "Проверка входных данных (input validation) предотвращает многие атаки",
                "Модульность кода и использование проверенных библиотек (OpenZeppelin) повышает безопасность"
            ],
            real_world_example="Hack DAO в 2016 году показал опасность reentrancy атак. Хакер использовал ошибку в смарт-контракте The DAO, чтобы вывести 60 млн долларов ETH, что привело к hard fork Ethereum.",
            practice_question="Что такое reentrancy и почему она опасна?",
            answer_hint="Это атака, когда контракт может быть вызван множество раз до обновления его состояния, позволяя вывести больше денег чем есть.",
            next_topics=["defi", "token_standards", "layer2"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="Ethereum: EIP и Roadmap развития",
            content="""Ethereum постоянно развивается через предложения EIP (Ethereum Improvement Proposals).
Каждый EIP предлагает изменение протокола, которое обсуждается сообществом перед внедрением.

Важные EIP и hard forks:
• EIP-1559 (London 2021) - переработал механизм комиссий, добавил базовую комиссию и сжигание токенов
• EIP-2200 (Istanbul 2019) - изменил стоимость операций с хранилищем
• EIP-3675 (Paris 2022) - завершил переход на Proof-of-Stake ("The Merge")
• EIP-4844 (Dencun 2024) - добавил proto-danksharding для масштабирования

Roadmap Ethereum (Dencun и позже):
• Proto-danksharding - промежуточное решение для масштабирования L2
• Danksharding - полная реализация шардинга для масштабирования
• Verkle trees - новая структура данных для более эффективного состояния

Развитие Ethereum направлено на:
• Масштабируемость - обработка больше транзакций
• Энергоэффективность - PoS уже достигнута
• Безопасность - постоянное улучшение протокола
• Приватность - развитие инструментов для конфиденциальности

L2 решения (Arbitrum, Optimism, zkSync) частично уже решают масштабируемость,
а proto-danksharding даст им больше пропускной способности.""",
            key_points=[
                "EIP-1559 создал дефляционный механизм для ETH через сжигание базовой комиссии",
                "Переход на PoS уменьшил энергопотребление Ethereum на 99.95%",
                "Proto-danksharding (EIP-4844) улучшит масштабируемость L2 решений на 10-100x",
                "Verkle trees позволят узлам работать с меньшей памятью, улучшая децентрализацию"
            ],
            real_world_example="Dencun upgrade в марте 2024 добавил EIP-4844, что снизило комиссии на Arbitrum и Optimism в 5-100 раз. Пользователи стали платить копейки вместо долларов за транзакции.",
            practice_question="Почему EIP-1559 сделала ETH дефляционным?",
            answer_hint="Потому что базовая комиссия сжигается (удаляется из циркуляции), а если комиссии превышают вознаграждение валидаторов, общее количество ETH уменьшается.",
            next_topics=["defi_advanced", "layer2", "zk_proofs"]
        )
    },
    "blockchain": {
        "beginner": EmbeddedLesson(
            lesson_title="Блокчейн: Основы распределенной книги",
            content="""Блокчейн - это распределенная база данных, которая хранит информацию в цепочке криптографически 
связанных блоков. Каждый блок содержит хеш предыдущего блока, что создает неразрывную цепь.

Основные принципы:
• Децентрализация - нет единого сервера, данные копируются на многих узлах
• Иммутабельность - раз добавленные данные невозможно изменить без пересчета всей цепи
• Прозрачность - все могут просмотреть всю историю транзакций
• Консенсус - узлы должны согласиться на новый блок перед добавлением

Структура блока:
• Header - метаданные (номер, время, родитель, merkle root)
• Transactions - список транзакций
• Nonce - число для Proof-of-Work

Как это работает:
1. Новая транзакция обходит сеть к узлам
2. Узлы проверяют валидность транзакции
3. Валидные транзакции попадают в mempool (пул памяти)
4. Майнеры/валидаторы выбирают транзакции и создают новый блок
5. Новый блок проверяется и распространяется по сети
6. Все узлы обновляют свои копии блокчейна""",
            key_points=[
                "Хеширование каждого блока включает хеш предыдущего, создавая неразрывную цепь",
                "Любое изменение данных в историческом блоке требует пересчета всех последующих блоков",
                "Сеть многих узлов делает невозможным подделать историю без контроля большинства",
                "Механизм консенсуса (PoW, PoS) предотвращает сбои и дает экономический стимул честности"
            ],
            real_world_example="Bitcoin блокчейн содержит все транзакции с 2009 года - более 800 млн транзакций. Размер всей цепи около 600 GB. Любой может загрузить полный узел и проверить каждую транзакцию самостоятельно.",
            practice_question="Почему попытка изменить старую транзакцию в блокчейне немедленно станет очевидна всем?",
            answer_hint="Потому что хеш этого блока изменится, что нарушит цепь и все компьютеры в сети смогут обнаружить подделку.",
            next_topics=["cryptography", "bitcoin", "ethereum"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="Блокчейн: Консенсус и масштабируемость",
            content="""Консенсус - механизм, который позволяет распределенной сети согласиться на состояние блокчейна
без центрального органа. Различные механизмы обеспечивают разные свойства.

Основные механизмы консенсуса:

Proof-of-Work (PoW):
• Участники (майнеры) конкурируют в решении математических задач
• Первый, кто решит, добавляет блок и получает награду
• Сложность автоматически регулируется
• Плюсы: высокая безопасность, проверенный временем
• Минусы: энергозатратность, сложность масштабирования

Proof-of-Stake (PoS):
• Валидаторы выбираются на основе количества поставленных токенов
• Менее энергозатратен, позволяет быстрее добавлять блоки
• Плюсы: экономичность, масштабируемость
• Минусы: требует изначального распределения токенов, риск централизации

DPoS (Delegated PoS):
• Токенхолдеры голосуют за делегатов, которые валидируют блоки
• Примеры: Cosmos, EOS
• Более демократичен и эффективен

Масштабируемость:
• Trilemma: безопасность, децентрализация, масштабируемость
• На Layer 1 трудно иметь все три свойства одновременно
• Layer 2 решения (Rollups, Sidechains) решают триллему на своем уровне""",
            key_points=[
                "Konsensus должен предотвращать двойную трату и 51% атаки",
                "Proof-of-Stake требует экономического стимула честного поведения (slashing)",
                "Финальность - время, необходимое для гарантии необратимости транзакции",
                "Скейлинг: Rollups компрессируют транзакции, Sharding делит сеть, Sidechains работают параллельно"
            ],
            real_world_example="Ethereum переходит с PoW на PoS. The Merge в 2022 году уменьшил энергопотребление на 99.95% при сохранении безопасности благодаря механизму Slashing (штрафу за нечестное поведение валидаторов).",
            practice_question="Почему Proof-of-Stake дешевле чем Proof-of-Work?",
            answer_hint="Потому что валидаторам не нужно выполнять сложные математические расчеты, только выполнять вычислительно легкие проверки подписей.",
            next_topics=["ethereum", "layer2", "defi"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="Блокчейн: Криптографические основы",
            content="""Криптография - основа безопасности всех блокчейнов. Понимание математических принципов
критично для оценки безопасности системы.

Элементы криптографии в блокчейне:

Криптографическое хеширование:
• SHA-256 (Bitcoin) и Keccak-256 (Ethereum) - однонаправленные функции
• Свойства: детерминированность, лавинный эффект, коллизионная стойкость
• Используется для: Proof-of-Work, структур данных (Merkle tree), обнаружения изменений

Асимметричная криптография (ECDSA):
• Каждый адрес имеет приватный и публичный ключ
• Приватный ключ подписывает транзакции, публичный проверяет подпись
• Эллиптическая кривая secp256k1 используется в Bitcoin/Ethereum
• Безопасность зависит от сложности дискретного логарифма

Цифровые подписи:
• Гарантируют, что транзакция подписана только владельцем приватного ключа
• Не требует передачи приватного ключа
• Неоспоримость - подписант не может отрицать свою подпись

Будущее криптографии:
• Квантовые компьютеры угрожают ECDSA
• Post-quantum cryptography разрабатывается NIST
• Lattice-based cryptography (CRYSTALS-Kyber) - потенциальная замена""",
            key_points=[
                "Криптографическое хеширование создает уникальный отпечаток данных, неизменяемый при изменении входа",
                "ECDSA обеспечивает аутентичность и неоспоримость транзакций",
                "Merkle trees позволяют эффективно проверять наличие данных в большом наборе",
                "Квантовое вычисление представляет долгосрочный риск для текущих криптографических алгоритмов"
            ],
            real_world_example="Все биржи и кошельки используют ECDSA для подписания транзакций. Если кто-то получит ваш приватный ключ, он может выдать себя за вас и забрать все средства, потому что не может быть доказано, что это не вы.",
            practice_question="Почему невозможно подделать подпись, если у вас есть только публичный ключ?",
            answer_hint="Потому что создание действительной подписи требует знания приватного ключа, и обратное преобразование (восстановление приватного ключа из публичного) математически невозможно.",
            next_topics=["bitcoin", "zero_knowledge", "quantum_security"]
        )
    },
    "defi": {
        "beginner": EmbeddedLesson(
            lesson_title="DeFi: Финансы без посредников",
            content="""DeFi (Decentralized Finance) - это система финансовых приложений, построенных на блокчейне,
которые имитируют традиционные финансовые услуги, но без посредников.

Основные компоненты DeFi:

Децентрализованные биржи (DEX):
• Uniswap, Curve, Balancer - позволяют торговать токенами напрямую
• Используют AMM (Automated Market Maker) вместо порядков на книге
• Пользователи предоставляют ликвидность и получают комиссию

Кредитование:
• Aave, Compound - позволяют одалживать и занимать криптоактивы
• Интерес определяется спросом и предложением автоматически
• Требует залога (collateral) для защиты от дефолта

Стейкинг и фарминг:
• Можно зарабатывать % на активах, зафиксировав их в контрактах
• Yield farming - комбинирование стейкинга и кредитования для большего дохода

Преимущества:
• Открыт для всех - не нужна банковская лицензия
• Прозрачность - все операции видны на блокчейне
• Эффективность - нет промежуточных учреждений
• Доступность 24/7 - нет выходных и праздников

Недостатки:
• Высокий риск - ошибки кода могут привести к потере денег
• Волатильность - цены могут упасть ниже залога
• Сложность - требует понимания умных контрактов""",
            key_points=[
                "AMM позволяет торговлю через формулу x*y=k вместо порядков на книге",
                "Максимальное достижение скорости и доступности благодаря децентрализации",
                "Риск смарт-контрактов выше чем в традиционных финансах из-за новизны технологии",
                "Сочетание различных протоколов создает сложные цепи риска"
            ],
            real_world_example="Uniswap позволил любому создать торговую пару без разрешения. За несколько лет Uniswap обработал триллионы долларов в объеме, доказав, что DEX может конкурировать с традиционными биржами.",
            practice_question="Почему DEX более безопасны для неквалифицированных трейдеров?",
            answer_hint="Потому что вы сохраняете контроль над своими приватными ключами и средствами не остаются на централизованной бирже, которая может быть взломана.",
            next_topics=["ethereum", "token_standards", "yield_farming"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="DeFi: Протоколы и стратегии",
            content="""Продвинутые DeFi протоколы предоставляют более сложные финансовые инструменты.

Типы DeFi приложений:

Мультиколлатеральные системы:
• MakerDAO - создает децентрализованную стейблкойну DAI из различных колатералей
• Требует переизбыточного залога (150-200%) для защиты от нестабильности
• DAI использует Pricefeed Oracle для определения цены колатерали

Производные:
• Synthetix - синтетические активы, отслеживающие цены реальных активов
• Perpetual DEX - позволяют short/long с левереджем
• Примеры: GMX, dYdX

Flash loans:
• Займи большую сумму на одну транзакцию без залога
• Должны быть возвращены в той же транзакции + комиссия
• Используются для арбитража и атак

Стратегии доходности:
• Yield farming - комбинирование LP + кредитования для максимизации дохода
• Liquidation farming - профит на ликвидации неправильно колатерализованных позиций
• MEV (Maximum Extractable Value) - стратегии использования упорядочения транзакций

Риски DeFi:
• Impermanent Loss (IL) - потери для LP при высокой волатильности
• Oracle манипуляция - атаки на источники данных цены
• Flash loan атаки - использование flash loans для манипуляции ценами
• Systemic risk - коллапс одного протокола может вызвать каскадные отказы""",
            key_points=[
                "Переизбыток колатерализации необходим для защиты протокола от падения цены",
                "Flash loans - инновация, создали новый класс атак и стратегий",
                "Oracle problem - децентрализованные системы нуждаются в надежных источниках данных",
                "Комбинирование протоколов создает риск, где отказ одного вызывает каскадный эффект"
            ],
            real_world_example="Hack Curve в 2023 году использовал заражение Oracle, чтобы манипулировать ценой и заработать на ликвидациях. Протокол потерял $52 млн, показав, что даже проверенные системы уязвимы.",
            practice_question="Почему Impermanent Loss происходит в AMM при высокой волатильности?",
            answer_hint="Потому что AMM поддерживает постоянное соотношение пула, которое может быть менее выгодно чем просто держать токены при сильной волатильности.",
            next_topics=["ethereum", "risk_management", "layer2"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="DeFi: Архитектура и управление",
            content="""Сложные DeFi экосистемы требуют понимания межпротокольного взаимодействия, управления и архитектуры.

Governance токены:
• UNI, AAVE, COMPOUND - дают право голоса по развитию протокола
• Holder могут голосовать на предложения параметров (fees, иммунитеты)
• Multi-sig для критических функций (обновление, пауза, ликвидность)

Архитектура DeFi:

Core Layer (Основной слой):
• DEX (Uniswap) - базовая торговля
• Lending (Aave) - кредитование

Middleware (Промежуточный слой):
• Aggregators (1inch, Paraswap) - маршрутизируют через лучший путь
• Routers (Zapper, Balancer) - комбинируют несколько операций

Application Layer (Слой приложений):
• Yield optimizers (Yearn) - автоматически находят лучший yield
• Portfolio managers - управляют диверсифицированными позициями

Риск-менеджмент в DeFi:
• Stress testing - моделирование экстремальных рыночных условий
• Circuit breakers - остановка торговли при скачках цены
• Insurance - протоколы (Nexus Mutual) страхуют смарт-контракты

Будущее DeFi:
• Cross-chain DeFi - взаимодействие между блокчейнами
• Privacy - использование ZK для конфиденциальности
• Compliance - регуляторные решения для институциональных пользователей
• Native yields - встроенные способы заработка (staking rewards)""",
            key_points=[
                "Модульная архитектура DeFi позволяет комбинировать протоколы, но добавляет сложность рисков",
                "Governance токены создают стимулы для участия, но также концентрируют власть",
                "Риск кредитных цепей (A зависит от B зависит от C) требует постоянного мониторинга",
                "Регуляция DeFi будет ключевой для массового принятия, особенно для стейблкойнов и синтетических активов"
            ],
            real_world_example="Yearn.finance создал архитектуру, где пользователи депонируют средства и автоматическое управление находит лучшие yield стратегии. Это показало как абстрактная сложность может быть скрыта от пользователей через UX.",
            practice_question="Почему governance токены важны для децентрализованных протоколов?",
            answer_hint="Потому что позволяют сообществу голосовать по важным решениям, предотвращая контроль одного человека и обеспечивая демократическое управление.",
            next_topics=["ethereum", "cross_chain", "zk_proofs"]
        )
    },
    "web3": {
        "beginner": EmbeddedLesson(
            lesson_title="Web3: Децентрализованный интернет",
            content="""Web3 - это новое видение интернета, где вместо централизованных платформ, которыми управляют большие компании,
используются децентрализованные приложения (dApps), работающие на блокчейнах.

Отличия Web2 vs Web3:
• Web2: Данные хранятся на серверах компаний (Facebook, Google). Компания контролирует, кому их продать
• Web3: Данные принадлежат вам. Вы контролируете доступ через приватный ключ, как физический сейф

Основные компоненты Web3:
• Блокчейн - книга учета всех транзакций
• Smart contracts - программы, которые работают автоматически без посредников
• Децентрализованный хранилище (IPFS) - вместо облака Google или Dropbox
• DAO - организации, управляемые смарт-контрактами, а не начальниками

Примеры Web3 использования:
• DeFi - финансовые сервисы без банков
• NFT - владение уникальными цифровыми активами
• Decentralized Social - соцсети без цензуры, где вы владеете данными
• Crypto payments - платежи без Visa и PayPal

Преимущества Web3:
• Самоуправление - вы контролируете свои данные
• Прозрачность - все транзакции видны и проверяемы
• Доступ - нет географических ограничений или дискриминации
• Вознаграждение - участники экосистемы получают токены за вклад""",
            key_points=[
                "Web3 переносит власть от корпораций к пользователям через криптографию и децентрализацию",
                "Smart contracts исполняют код без посредников - результат гарантирован блокчейном",
                "DAO позволяют организациям работать без центрального лидера через систему голосования",
                "Приватный ключ = полный контроль над активами, но также полная ответственность"
            ],
            real_world_example="Uniswap (децентрализованная биржа) позволяет торговать криптовалютами без регистрации и паспорта. Все пользователи одинаковые - нет 'VIP' статуса. В 2024 Uniswap объем $1+ трлн, больше чем некоторые традиционные биржи.",
            practice_question="Как Web3 решает проблему контроля данных в Web2?",
            answer_hint="Через криптографию - вы владеете приватным ключом, вы контролируете данные. Никто, включая компанию, не может получить доступ без вашего разрешения.",
            next_topics=["ethereum", "smart_contracts", "defi"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="Web3: Смарт-контракты и взаимодействие",
            content="""Смарт-контракты - это программы, которые работают на блокчейне и автоматически выполняют условия без посредников.

Как работает смарт-контракт:
1. Разработчик пишет код на Solidity (язык программирования для Ethereum)
2. Код развертывается (deploy) на блокчейн - становится публичным и неизменяемым
3. Пользователи взаимодействуют, отправляя данные или деньги на адрес контракта
4. Контракт автоматически проверяет условия и выполняет действие

Пример смарт-контракта (концептуально):
```
ЕСЛИ пользователь отправил 1 ETH И сумма < 100 ETH В СЕЙФЕ
    ЗАТЕМ добавить 1000 токенов на счет пользователя
ЕСЛИ сумма В СЕЙФЕ достигла 100 ETH
    ЗАТЕМ отправить все деньги владельцу проекта
```

Популярные языки smart contracts:
• Solidity - основной язык для Ethereum (выглядит как JavaScript)
• Rust - для Solana (более безопасный язык)
• Vyper - альтернатива Solidity с фокусом на безопасность

Экосистема Web3:
• Frontend - веб-приложение (React, Vue) - интерфейс для пользователя
• Wallet - хранилище ключей (MetaMask, Ledger) - управляет приватными ключами
• Smart contract - код на блокчейне - исполняет логику
• RPC node - узел блокчейна - хранит и проверяет данные

Security в Web3:
• Reentrancy атаки - повторный вызов функции до завершения первого
• Front-running - когда майнер видит вашу транзакцию и делает свою раньше
• Integer overflow - переполнение чисел приводит к ошибкам в расчетах
• Unchecked external calls - если контракт вызывает другой контракт, может быть опасно""",
            key_points=[
                "Smart contracts - это программы на блокчейне, которые выполняются без посредников",
                "Хотя контракт неизменяем, разработчик может добавить функцию 'обновления' через прокси-контракты",
                "Каждое взаимодействие требует газ (комиссия в ETH) для компенсации узлам за выполнение кода",
                "Безопасность требует особого внимания - ошибка в коде может привести к потере миллионов"
            ],
            real_world_example="Exploit в Ronin Bridge (2022) стоил $625 млн. Атакующий получил приватный ключ и украл все токены, потому что контракт не проверял права на вывод. Это показало важность security audits.",
            practice_question="Почему смарт-контракты должны быть проверены аудиторами перед развертыванием?",
            answer_hint="Потому что однажды развернутый контракт неизменяем. Даже малая ошибка может привести к потере всех средств пользователей, и исправить это невозможно.",
            next_topics=["ethereum", "solidity", "security"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="Web3: Архитектура и масштабирование",
            content="""Продвинутые концепции Web3 включают масштабирование, кроссчейновое взаимодействие и сложные экономические модели.

Масштабирование Web3:

Layer 1 (Основной слой):
• Ethereum L1 - ~13 TX/sec, высокая безопасность, высокие комиссии
• Solana - ~65K TX/sec, но более централизована
• Bitcoin - ~7 TX/sec, максимальная безопасность и децентрализация

Layer 2 (Слой масштабирования):
• Optimistic Rollups (Arbitrum, Optimism) - берут транзакции, пакуют в один блок, отправляют в L1
• ZK Rollups (zkSync, StarkNet) - используют криптографические доказательства (Proof of Knowledge)
• Sidechains (Polygon) - отдельные цепи, периодически синхронизируются с основной цепью

Cross-chain взаимодействие:
• Bridges (Stargate, Hop) - позволяют передавать активы между блокчейнами
• Wrapped tokens - если хотите использовать BTC на Ethereum, получаете WBTC (обеспеченный)
• Atomic swaps - обмен напрямую между цепями без доверия к посреднику

Моделирование Web3 приложений:
• Token economics - как работает экономика токена, что мотивирует пользователей
• Game theory - стимулы и наказания для честного поведения
• Mechanism design - как спроектировать правила чтобы достичь нужного результата

Примеры механизма дизайна:
• Майнинг Bitcoin - стимул (награда) + сложность (затраты) = честность сети
• Staking ETH 2.0 - депозит (залог) + награда (доход) + наказание (слэшинг) = честность валидаторов
• Liquidity mining - раздача токенов за предоставление ликвидности = рост пула""",
            key_points=[
                "Layer 2 решают проблему масштабируемости, сохраняя безопасность Layer 1",
                "Кроссчейновое взаимодействие требует доверия к бридж-протоколам или использование криптографических доказательств",
                "Token economics требует глубокого понимания стимулов и того, как люди реагируют на награды",
                "Web3 архитектура требует балансировать между децентрализацией (безопасность) и масштабируемостью (скорость)"
            ],
            real_world_example="Arbitrum за год собрал $3.5B в TVL благодаря малым комиссиям и совместимости с Ethereum. Стал вторым по размеру Layer 2 после Polygon, показав что масштабирование решает реальную проблему высоких газов.",
            practice_question="Почему ZK Rollups могут быть более безопасными чем Optimistic Rollups?",
            answer_hint="Потому что ZK Rollups используют криптографические доказательства, что все транзакции корректны. Optimistic Rollups требуют механизма fraud proofs, который медленнее и сложнее.",
            next_topics=["ethereum", "polygon", "layer2_scaling"]
        )
    },
    "ai": {
        "beginner": EmbeddedLesson(
            lesson_title="ИИ и нейронные сети: Основы",
            content="""Искусственный интеллект (ИИ) - это программы которые могут учиться из данных и принимать решения без явных инструкций.

Когда мы говорим об ИИ:
• Узкий ИИ (ANI) - специализирован на одной задаче (ChatGPT для текста, AlphaGo для шахмат)
• Общий ИИ (AGI) - может решать любые задачи как человек (не существует еще)

Нейронные сети - главный инструмент современного ИИ:

Биология вдохновила инженеров:
• В мозге - нейроны связаны друг с другом, каждая связь имеет вес (сила)
• В компьютере - математические функции имитируют нейроны, веса хранятся в памяти

Простая нейронная сеть имеет слои:
• Input layer - входные данные (например, пиксели изображения)
• Hidden layers - промежуточные слои где происходит обработка
• Output layer - результат (классификация: кот или собака)

Как сеть учится:
1. Инициализируем случайные веса
2. Пропускаем пример через сеть - получаем предсказание
3. Сравниваем предсказание с правильным ответом - вычисляем ошибку
4. Используя ошибку, обновляем веса чтобы уменьшить ошибку (backpropagation)
5. Повторяем миллионы раз пока модель не станет точной

Типы задач в ИИ:
• Классификация - выбрать из вариантов (на изображении: кот, собака или попугай?)
• Регрессия - предсказать число (завтрашняя цена криптовалюты)
• Генерация - создать что-то новое (GPT создает текст, DALL-E создает изображения)
• Обнаружение - найти объекты на изображении (система безопасности)""",
            key_points=[
                "Нейронные сети обучаются из примеров, а не из явных правил - это революция в программировании",
                "Глубокие нейронные сети (Deep Learning) с миллионами параметров могут решать очень сложные задачи",
                "Больше данных и больше вычислений = лучшие результаты (но с убывающей отдачей)",
                "ИИ не 'понимает' как человек - это статистический паттерн, который угадывает на основе обучения"
            ],
            real_world_example="ChatGPT обучена на миллиардах слов из интернета. Она не 'знает' факты как энциклопедия, а предсказывает какой текст наиболее вероятен дальше. Поэтому иногда галлюцинирует - выдумывает убедительные, но ложные ответы.",
            practice_question="Что делает backpropagation в нейронной сети?",
            answer_hint="Backpropagation вычисляет, какие веса ответственны за ошибку, и обновляет их в правильном направлении чтобы уменьшить ошибку.",
            next_topics=["deep_learning", "transformers", "llm"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="ИИ: Архитектуры и применение",
            content="""Разные типы нейронных сетей подходят для разных задач.

CNN (Convolutional Neural Networks) - для изображений:
• Использует фильтры которые ищут границы, текстуры, глаза и т.д.
• Слой за слоем выделяет все более сложные признаки
• Пример: распознавание лиц, диагностика рака на рентгене

RNN (Recurrent Neural Networks) - для последовательностей:
• Имеет 'память' - может смотреть на предыдущие данные
• Обрабатывает последовательность слово за словом, сохраняя контекст
• Проблема: забывает информацию из далекого прошлого (vanishing gradient)

LSTM (Long Short-Term Memory) - улучшенный RNN:
• Помнит долгосрочные зависимости
• Часто используется в машинном переводе и предсказании цен

Transformers - революция (Attention механизм):
• Каждое слово может посмотреть на все другие слова, не теряя информацию
• Намного более параллелизуемо чем RNN - можно обучить на больших данных
• Основа для GPT, BERT, Llama - современные большие языковые модели

Применение ИИ в крипто:

Предсказание цен:
• Используют LSTM и Transformers для анализа временных рядов
• Входные данные: цена, объем, on-chain метрики, социальные сигналы
• Результат: точность ~60-70% (лучше чем случайное угадывание, но не 100%)

Обнаружение аномалий:
• Autoencoder сеть учится компрессировать нормальные данные
• Когда приходят необычные данные (например, манипуляция ценой), сеть не может их сжать
• Используется для детектирования фрода и манипуляций

NLP (Natural Language Processing):
• Анализ настроения в Twitter и 4chan о криптопроектах
• Извлечение информации из новостей о крипто
• Генерация торговых сигналов из текстовых данных""",
            key_points=[
                "Разные архитектуры подходят для разных типов данных и задач",
                "Transformers с attention механизмом более мощные чем RNN/LSTM, и могут обучаться на массивных датасетах",
                "ИИ в крипто полезен для анализа, но не гарантирует прибыль - рынки содержат много шума и непредсказуемости",
                "Overfitting - модель запоминает обучающие данные вместо изучения общих паттернов, нужны техники регуляризации"
            ],
            real_world_example="Transformer архитектура (2017) позволила обучить GPT на всех текстах интернета. Результат: ChatGPT в ноября 2022 года по-русски разговаривает лучше чем большинство людей. Все благодаря архитектуре, масштабированию и данным.",
            practice_question="Почему Transformer архитектура более эффективна чем RNN для больших датасетов?",
            answer_hint="Потому что Transformer полностью параллелизуем - все слова обрабатываются одновременно. RNN обрабатывает слово за словом, что медленнее и требует больше памяти для долгих последовательностей.",
            next_topics=["transformers", "llm", "reinforcement_learning"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="ИИ: Fine-tuning и ответственный AI",
            content="""Продвинутые техники позволяют адаптировать готовые модели для специфических задач.

Fine-tuning больших моделей:
• Возьте предобученную GPT (обучена на сетевых данных общего назначения)
• Дополнительно обучите на специфичных для вас данных (например, все твиты о крипто)
• Результат: модель которая лучше понимает крипто контекст

LoRA (Low-Rank Adaptation):
• Вместо изменения всех параметров, добавляем маленькие матрицы (адаптеры)
• Намного дешевле по памяти и вычислениям
• Позволяет быстро создать специализированные версии больших моделей

Prompt Engineering:
• Как сформулировать запрос чтобы модель дала лучший ответ
• Few-shot learning: даете примеры правильных ответов, потом новый запрос
• Chain-of-thought: просите модель 'думать пошагово' вместо прямого ответа

RAG (Retrieval Augmented Generation):
• Для каждого запроса сначала найдите релевантные документы в базе знаний
• Потом передайте документы + запрос в модель
• Результат: модель может использовать специфичные данные без переобучения

Ответственный AI (Responsible AI):
• Bias - модель может быть предубежденной если обучена на предубежденных данных
• Hallucination - модель выдумывает убедительные ложные ответы (проблема у всех LLM)
• Explainability - почему модель дала этот ответ? (черный ящик)

Этика ИИ в крипто:
• Алгоритмический трейдинг может манипулировать рынком
• Генерированный контент может распространять фейк-новости
• Приватность - модели могут запомнить личные данные из обучающих данных
• Регуляция - правительства начинают требовать прозрачность ИИ систем

Безопасность LLM:
• Prompt injection - вставить вредоносные инструкции в запрос
• Data poisoning - загрязнить обучающие данные чтобы модель вела себя неправильно
• Model stealing - украсть веса модели через API запросы""",
            key_points=[
                "Fine-tuning позволяет адаптировать большие модели для специфичных доменов с минимальными затратами",
                "RAG решает проблему обучения на свежих данных без переобучения всю модель",
                "Все LLM галлюцинируют - это не баг, а фундаментальное свойство статистического моделирования текста",
                "Безопасность и этика ИИ должны быть частью разработки, не дополнением"
            ],
            real_world_example="Anthropic разработала Claude с RLHF (reinforcement learning from human feedback) чтобы минимизировать hallucinations и быть более честной. Они активно изучают alignment - как убедиться что ИИ дает полезные ответы.",
            practice_question="Почему RAG лучше чем fine-tuning для работы со свежими данными?",
            answer_hint="Потому что RAG просто припоминает релевантные документы для каждого запроса, а fine-tuning требует переобучение всю модель. RAG дешевле, быстрее и может использовать данные которые модель никогда не видела.",
            next_topics=["llm_security", "alignment", "multimodal_ai"]
        )
    },
    "nft": {
        "beginner": EmbeddedLesson(
            lesson_title="NFT: Цифровые активы и собственность",
            content="""NFT (Non-Fungible Token) - это уникальные цифровые объекты которыми можно владеть и торговать как произведениями искусства.

Что такое NFT?

Fungible (взаимозаменяемый):
• Доллар = доллар, BTC = BTC, они взаимозаменяемы
• Если я вам дам мой доллар, он ничем не отличается от любого другого доллара

Non-Fungible (неуникальный):
• Картина Пикассо ≠ картина Ван Гога, они уникальны
• NFT - это как цифровая картина, каждая имеет уникальный ID и владельца

Технически:
• NFT - это смарт-контракт на блокчейне (обычно Ethereum)
• Контракт хранит: владелец, метаданные (картинка, описание), цена продажи
• Картинка обычно хранится не на блокчейне (дорого), а на IPFS (децентрализованное хранилище)

Стандарты NFT:
• ERC-721 - основной стандарт (1 токен = 1 NFT)
• ERC-1155 - более эффективный (1 контракт может иметь много NFT)

Примеры NFT:

Арт и коллекции:
• OpenSea - маркетплейс где торгуют NFT
• Cryptopunks - пиксель-арт из 10К картинок, некоторые стоят $1M+
• Bored Ape Yacht Club (BAYC) - сообщество и статус символ

Игры и метаверс:
• Axie Infinity - игра где персонажи это NFT, можно продать за крипто
• Decentraland - виртуальный мир где земля это NFT

Полезные приложения:
• Сертификаты - диплом как NFT, нельзя подделать
• Недвижимость - земля как NFT (в будущем?)
• Членство - NFT как билет на эксклюзивное членство в клубе""",
            key_points=[
                "NFT = блокчейн + смарт-контракт + уникальность, позволяет владеть цифровыми активами",
                "Стоимость NFT зависит от редкости, истории, и коммунитета, часто спекулятивна",
                "IPFS используется для хранения больших файлов вне блокчейна, более дешево",
                "NFT более полезны для сообщества и членства, чем для абстрактного 'искусства'"
            ],
            real_world_example="Bored Ape Yacht Club выпустила 10K NFT обезьян в 2021. Держатели получили доступ к эксклюзивному дискорду, мерчу, и собственности на искусство. Некоторые обезьяны продались за $200K+. Это показало что NFT стоимость приходит от сообщества.",
            practice_question="Почему NFT обычно хранят картинку не на блокчейне, а на IPFS?",
            answer_hint="Потому что каждый байт на блокчейне стоит денег (газ). Картинка в мегабайтах - это очень дорого. IPFS дешевый, децентрализованный, и каждый NFT содержит ссылку на изображение в IPFS.",
            next_topics=["ethereum", "defi", "metaverse"]
        ),
        "intermediate": EmbeddedLesson(
            lesson_title="NFT: Экосистема и механика",
            content="""Более сложные аспекты NFT - как работают маркетплейсы, ликвидность, и расширенные применения.

NFT маркетплейсы:
• OpenSea - крупнейший, множество коллекций, но высокие комиссии (2.5%)
• Magic Eden - оптимизирован для Solana, ниже комиссии
• LooksRare - конкурирует на комиссиях (2%), раздает токены торговцам
• Blur - фокусирован на трейдерах, интеграция с Blur финансирования

Механика торговли NFT:
• Фиксированная цена - продавец устанавливает сумму, покупатель платит точно
• Аукцион - время истекает, выигрывает наибольшая ставка (как eBay)
• Роялти - художник может получать процент с каждой перепродажи (обычно 5-10%)

Ликвидность NFT vs токенов:
• Токен (BTC) - глубокий рынок, легко купить/продать в секунды
• NFT - тонкий рынок, может быть сложно найти покупателя по справедливой цене
• Решение: NFT пулы и автоматические маркетмейкеры (AMM) для фракций NFT

Фракционализация NFT:
• Дорогой NFT (~$100K) фракционализируют на 1M токенов
• Каждый может владеть долей NFT, торговать фракциями на DEX
• Например, Pudgy Penguins NFT фракционализирован на 10B токенов PENGU

Практические применения:

Лицензирование и авторское право:
• Музыкант может выпустить NFT песни с роялти за прослушивания
• Видеоконтент может быть ограничен - только NFT держатели видят полный контент

Игровые активы:
• Оружие, одежда, земля в играх - это NFT которые игрок владеет
• Можно торговать между играми если они используют один стандарт
• Player-owned economies - экономика игры принадлежит игрокам

Интеграция с физическим миром:
• QR код на физической картинке ведет к NFT на блокчейне
• Подтверждает аутентичность - нельзя подделать без доступа к аккаунту""",
            key_points=[
                "NFT маркетплейсы конкурируют на комиссиях и удобстве - выбор зависит от блокчейна",
                "Роялти позволяют создателям зарабатывать пассивный доход от перепродаж их работ",
                "Фракционализация решает проблему ликвидности дорогих NFT",
                "Истинная стоимость NFT приходит от полезности (членство, игра, доступ) а не от спекуляции"
            ],
            real_world_example="Magic Eden (Solana NFT маркетплейс) взял 2% комиссии вместо OpenSea 2.5%, быстро стал вторым по объему. Это показало что даже маленькие различия в UX и комиссиях имеют значение в конкурентном рынке.",
            practice_question="Почему фракционализация NFT полезна для ликвидности?",
            answer_hint="Потому что позволяет держателям дорогого NFT получить немного денег, продав доли, а не весь NFT. Также создает более глубокий рынок с больше торговцев.",
            next_topics=["ethereum", "defi", "gaming"]
        ),
        "advanced": EmbeddedLesson(
            lesson_title="NFT: Будущее и технические детали",
            content="""Продвинутые темы в NFT - масштабирование, композиция, и интеграция с реальным миром.

Масштабирование NFT:

Layer 2 для NFT:
• Arbitrum и Polygon позволяют торговать NFT с комиссиями в сотни раз дешевле
• Сейчас большая часть объема NFT на Arbitrum, а не Ethereum
• Проблема: фрагментация ликвидности между L1 и L2

ZK-SNARK и конфиденциальность:
• ZK доказательства позволяют владеть NFT приватно (никто не видит)
• Темный пул для NFT торговли - конфиденциальные аукционы

On-chain композиция:

Nested NFT:
• NFT может содержать другой NFT внутри (как матрешка)
• Если у вас есть BAYC NFT и вы положите его в хранилище, это становится вложенным
• Позволяет сложные структуры владения и управления

Динамические NFT:
• NFT который меняется на основе внешних данных
• Oracle подает новую информацию, NFT обновляется автоматически
• Пример: NFT которая меняет цвет в зависимости от цены криптовалюты

Веб3 идентичность через NFT:
• Вместо Facebook профиля вы используете NFT как ID
• Контакты: ваш адрес кошелька = ваш ID, друзья хранятся в смарт-контракте
• Криптографически подтверждено, никто не может украсть вашу идентичность

Интеграция с реальным миром (RWA):

Цифровые близнецы (Digital Twins):
• Физический товар имеет цифровой близнец (NFT)
• Каждый раз когда товар переходит в руки, NFT тоже передается
• Создает неразрушимую цепь владения

Недвижимость на блокчейне:
• Земельный участок регистрируется как NFT
• Смарт-контракт автоматически трансферует когда платеж получен
• В будущем может заменить нотариусов и реестры

Правовые проблемы:
• Если вы владеете NFT дома, владеете ли вы домом? (Зависит от юрисдикции)
• Какие права дает NFT? (Обычно только цифровое представление)
• Как регулировать если контракт находится в блокчейне а не в физическом мире?""",
            key_points=[
                "Layer 2 и ZK решают проблемы масштабирования и приватности в NFT",
                "Композиция и динамичность позволяют NFT быть более полезными чем просто статические картинки",
                "RWA (Real-World Assets) - это будущее NFT, когда блокчейн интегрируется с физическими активами",
                "Юридическая ясность нужна для массового принятия NFT в недвижимости и товарах"
            ],
            real_world_example="Pudgy Penguins зарегистрировал свой IP и создал игру где NFT могут быть использованы. Это показало что успешные NFT проекты нуждаются в реальной полезности и юридической защите IP.",
            practice_question="Как на-чейн композиция NFT помогает создавать сложные экосистемы?",
            answer_hint="Потому что позволяет NFT содержать другие NFT и ссылаться на друг друга. Это создает иерархию владения - главный NFT может управлять несколькими дочерними NFT через смарт-контракт.",
            next_topics=["ethereum", "rwa", "defi"]
        )
    }
}

def get_embedded_lesson(topic: str, difficulty: str = "beginner") -> Optional[EmbeddedLesson]:
    """Получить встроенный урок по топику и уровню сложности"""
    topic_lower = topic.lower().strip()
    difficulty_lower = difficulty.lower().strip()
    
    if topic_lower not in EMBEDDED_CURRICULUM:
        return None
    
    lessons = EMBEDDED_CURRICULUM[topic_lower]
    if difficulty_lower not in lessons:
        # Возвращаем beginner если запрошена несуществующая сложность
        return lessons.get("beginner")
    
    return lessons[difficulty_lower]

def get_all_topics() -> list[str]:
    """Получить список всех доступных топиков"""
    return list(EMBEDDED_CURRICULUM.keys())

def get_difficulties_for_topic(topic: str) -> list[str]:
    """Получить доступные уровни сложности для топика"""
    topic_lower = topic.lower().strip()
    if topic_lower not in EMBEDDED_CURRICULUM:
        return []
    return list(EMBEDDED_CURRICULUM[topic_lower].keys())

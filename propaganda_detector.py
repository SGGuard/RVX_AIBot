"""
Propaganda and Manipulation Detector for RVX Bot
–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—É, –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏, —Ñ–µ–π–∫-–Ω–æ–≤–æ—Å—Ç–∏
"""

import re
from typing import Optional, Dict, List, Tuple
from enum import Enum
import logging

logger = logging.getLogger("RVX_PROPAGANDA")

class ManipulationType(Enum):
    """–¢–∏–ø—ã –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π –∏ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—ã"""
    FEAR_MONGERING = "fear"  # –ù–∞–≥–Ω–µ—Ç–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ö–∞
    FALSE_PROMISES = "false_promises"  # –õ–æ–∂–Ω—ã–µ –æ–±–µ—â–∞–Ω–∏—è
    EMOTIONAL_MANIPULATION = "emotional"  # –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏
    CONSPIRACY = "conspiracy"  # –¢–µ–æ—Ä–∏–∏ –∑–∞–≥–æ–≤–æ—Ä–∞
    SCARCITY_TACTICS = "scarcity"  # –¢–∞–∫—Ç–∏–∫–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–∞/—Å—Ä–æ—á–Ω–æ—Å—Ç–∏
    BANDWAGON = "bandwagon"  # "–í—Å–µ —Ç–∞–∫ –≥–æ–≤–æ—Ä—è—Ç" / —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ
    AUTHORITY_ABUSE = "authority"  # –ù–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–∞
    OVERSIMPLIFICATION = "oversimplification"  # –ß—Ä–µ–∑–º–µ—Ä–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ
    FALSE_DICHOTOMY = "false_dichotomy"  # –õ–æ–∂–Ω–∞—è –¥–∏—Ö–æ—Ç–æ–º–∏—è (—Ç–æ–ª—å–∫–æ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
    CHERRY_PICKING = "cherry_picking"  # –í—ã–±–æ—Ä–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    STRAW_MAN = "straw_man"  # –ê—Ç–∞–∫–∞ –Ω–∞ —Å–æ–ª–æ–º–µ–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
    REPETITION = "repetition"  # –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–Ω–æ–≥–æ —Ä–∞–∑
    LOADED_LANGUAGE = "loaded_language"  # –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —è–∑—ã–∫

# ============================================================================
# –ü–ê–¢–¢–ï–†–ù–´ –ü–†–û–ü–ê–ì–ê–ù–î–´ –ò –ú–ê–ù–ò–ü–£–õ–Ø–¶–ò–ô
# ============================================================================

PROPAGANDA_PATTERNS = {
    ManipulationType.FEAR_MONGERING: {
        "keywords": [
            r"–∫—Ä–∞—Ö", r"—Ä–∞–∑—Ä—É—à", r"–æ–ø–∞—Å–Ω", r"—É–≥—Ä–æ–∑", r"–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ", 
            r"–∫–æ–ª–ª–∞–ø—Å", r"–ø–∞–Ω–∏–∫", r"–∫—Ä–∏–∑–∏—Å", r"–±–µ–¥—Å—Ç–≤–∏–µ",
            r"–≤—ã–º–∏—Ä–∞–Ω–∏–µ", r"–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏", r"–∫–æ–Ω–µ—Ü —Å–≤–µ—Ç–∞"
        ],
        "phrases": [
            r"–≤—Å–∫–æ—Ä–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç",
            r"–Ω–µ–º–∏–Ω—É–µ–º–æ —Å–ª—É—á–∏—Ç—Å—è",
            r"–±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç",
            r"–∫–æ–Ω–µ—Ü –≤—Å–µ–º—É",
        ],
        "description": "–ù–∞–≥–Ω–µ—Ç–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ö–∞ –¥–ª—è –º–æ–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏"
    },
    
    ManipulationType.FALSE_PROMISES: {
        "keywords": [
            r"–≥–∞—Ä–∞–Ω—Ç–∏—Ä", r"–æ–±–µ—Å–ø–µ—á–∏", r"–ø–æ–ª—É—á–∏", r"–∑–∞—Ä–∞–±–æ—Ç–∞–π",
            r"–±–µ—Å–ø–ª–∞—Ç–Ω", r"–ª–µ–≥–∫–æ", r"–±—ã—Å—Ç—Ä–æ", r"–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±",
            r"—Å–µ–∫—Ä–µ—Ç–Ω", r"–≤–æ–ª—à–µ–±–Ω", r"—á—É–¥–æ"
        ],
        "phrases": [
            r"100% –ø—Ä–∏–±—ã–ª—å",
            r"–±–µ–∑ —Ä–∏—Å–∫–∞",
            r"–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Ö–æ–¥",
            r"–º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
            r"—Å–∫—Ä—ã—Ç—ã–π —Å–ø–æ—Å–æ–±",
        ],
        "description": "–û–±–µ—â–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
    },
    
    ManipulationType.SCARCITY_TACTICS: {
        "keywords": [
            r"—Å—Ä–æ—á–Ω–æ", r"—Å–ø–µ—à–∏—Ç—å", r"–æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ", r"—Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è",
            r"–æ–≥—Ä–∞–Ω–∏—á–µ–Ω", r"—ç–∫—Å–∫–ª—é–∑–∏–≤", r"—Ä–µ–¥–∫", r"–ø–æ—Å–ª–µ–¥–Ω",
            r"–Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏", r"–±—ã—Å—Ç—Ä–æ –∫–æ–Ω—á–∏—Ç—Å—è"
        ],
        "phrases": [
            r"–æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ",
            r"—Å–ø–µ—à–∏—Ç–µ –ø–æ–∫–∞",
            r"—Ç–æ–ª—å–∫–æ [0-9]+ –º–µ—Å—Ç",
            r"–ø–æ—Å–ª–µ–¥–Ω[–∏–π|–µ–µ|—è—è]",
        ],
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∂–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏"
    },
    
    ManipulationType.EMOTIONAL_MANIPULATION: {
        "keywords": [
            r"–Ω–µ–Ω–∞–≤–∏–¥", r"–ª—é–±", r"–∂–∞–ª–∫", r"—Ç—Ä–∞–≥–µ–¥–∏—è",
            r"–≥–µ—Ä–æ–π", r"–≤—Ä–∞–≥", r"–ø—Ä–µ–¥–∞—Ç–µ–ª—å", r"–º—É—á–µ–Ω–∏–∫",
            r"—Å–≤—è—Ç–æ–π", r"–≥—Ä–µ—à–Ω", r"–Ω–µ–≤–∏–Ω–Ω"
        ],
        "phrases": [
            r"–∫–∞–∫ –≤—ã –º–æ–∂–µ—Ç–µ",
            r"–Ω–µ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏",
            r"—Å–µ—Ä–¥—Ü–µ –∫—Ä–æ–≤—å—é",
            r"–≤ —Å–ª–µ–∑–∞—Ö",
        ],
        "description": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏–∫–∏"
    },
    
    ManipulationType.CONSPIRACY: {
        "keywords": [
            r"–∑–∞–≥–æ–≤–æ—Ä", r"—Å–∫—Ä—ã–≤–∞", r"—Ç–∞–π–Ω", r"—Å–ø–µ—Ü.—Å–ª—É–∂–±",
            r"—ç–ª–∏—Ç", r"–º–∏—Ä–æ–≤–æ–π –ø—Ä–∞–≤–∏—Ç–µ–ª", r"–Ω–æ–≤—ã–π –º–∏—Ä–æ–≤–æ–π –ø–æ—Ä—è–¥–æ–∫",
            r"–º–∏—Ä–æ–≤–æ–π –ø—Ä–∞–≤–∏—Ç–µ–ª—å", r"–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä", r"–º–∞–Ω–∏–ø—É–ª–∏—Ä",
            r"—Ç–µ–º–Ω—ã–µ —Å–∏–ª—ã", r"–∏–ª–ª—é–º–∏–Ω–∞—Ç—ã", r"–º–∞—Å–æ–Ω"
        ],
        "phrases": [
            r"–∏–∑–≤–µ—Å—Ç–Ω–æ —á—Ç–æ",
            r"–≤—Å–µ –∑–Ω–∞—é—Ç –Ω–æ –º–æ–ª—á–∞—Ç",
            r"–æ–Ω–∏ —Å–∫—Ä—ã–≤–∞—é—Ç",
            r"–ø—Ä–∞–≤–¥–∞ —ç—Ç–æ",
        ],
        "description": "–¢–µ–æ—Ä–∏–∏ –∑–∞–≥–æ–≤–æ—Ä–∞ –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤"
    },
    
    ManipulationType.BANDWAGON: {
        "keywords": [
            r"–≤—Å–µ –≥–æ–≤–æ—Ä", r"–∫–∞–∂–¥—ã–π –∑–Ω–∞–µ—Ç", r"–æ—á–µ–≤–∏–¥–Ω–æ",
            r"–ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ", r"–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ", r"—Å–∞–º —Å–æ–±–æ–π",
            r"–º–∞—Å—Å–æ–≤", r"–±–æ–ª—å—à–∏–Ω—Å—Ç–≤", r"–Ω–∞—Ä–æ–¥"
        ],
        "phrases": [
            r"–≤—Å–µ —Ç–∞–∫ —Å—á–∏—Ç–∞—é—Ç",
            r"–Ω–æ—Ä–º–∞–ª—å–Ω[—ã–π|—ã–µ] –ª—é–¥–∏",
            r"–≤—Å–µ–º –∏–∑–≤–µ—Å—Ç–Ω–æ",
            r"–Ω–∏–∫—Ç–æ –Ω–µ —Å–ø–æ—Ä–∏—Ç",
        ],
        "description": "–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ - '–≤—Å–µ —Ç–∞–∫ –¥—É–º–∞—é—Ç'"
    },
    
    ManipulationType.AUTHORITY_ABUSE: {
        "keywords": [
            r"—ç–∫—Å–ø–µ—Ä—Ç", r"—É—á–µ–Ω—ã–π", r"–¥–æ–∫—Ç–æ—Ä", r"–ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä",
            r"–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω", r"–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤", r"–º–∏–Ω–∏—Å—Ç—Ä",
            r"–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω"
        ],
        "phrases": [
            r"–≤–ª–∞—Å—Ç–∏ —Å–∫—Ä—ã–≤–∞—é—Ç",
            r"–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
            r"–≤–∞–∂–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ —Å–∫–∞–∑–∞–ª",
        ],
        "description": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–∞ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤"
    },
    
    ManipulationType.OVERSIMPLIFICATION: {
        "keywords": [
            r"–ø—Ä–æ—Å—Ç–æ", r"—è—Å–Ω–æ", r"—á–µ—Ç–∫–æ", r"–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ",
            r"–Ω–µ—Å–æ–º–Ω–µ–Ω–Ω–æ", r"–±–µ–∑—É—Å–ª–æ–≤–Ω–æ", r"–≤–æ–ø—Ä–æ—Å–∞ –Ω–µ—Ç"
        ],
        "phrases": [
            r"—ç—Ç–æ –ø—Ä–æ—Å—Ç–æ",
            r"–æ—Ç–≤–µ—Ç –æ—á–µ–≤–∏–¥–µ–Ω",
            r"–Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö —Å–æ–º–Ω–µ–Ω–∏–π",
        ],
        "description": "–ß—Ä–µ–∑–º–µ—Ä–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤"
    },
    
    ManipulationType.FALSE_DICHOTOMY: {
        "keywords": [
            r"–ª–∏–±–æ", r"–∏–ª–∏", r"—Ç–æ–ª—å–∫–æ", r"–Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö",
            r"–Ω–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤", r"–ª–∏–±–æ —Å –Ω–∞–º–∏ –ª–∏–±–æ"
        ],
        "phrases": [
            r"—Ç–æ–ª—å–∫–æ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç",
            r"–∏–ª–∏ –≤—ã –∑–∞ –∏–ª–∏ –≤—ã",
            r"–Ω–µ—Ç —Ç—Ä–µ—Ç—å–µ–≥–æ",
        ],
        "description": "–õ–æ–∂–Ω–∞—è –¥–∏—Ö–æ—Ç–æ–º–∏—è - —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ 2 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤"
    },
}

# ============================================================================
# –ö–†–ê–°–ù–´–ï –§–õ–ê–ì–ò –í –ö–û–ù–¢–ï–ö–°–¢–ï –ö–†–ò–ü–¢–û
# ============================================================================

CRYPTO_RED_FLAGS = {
    "pump_and_dump_signals": [
        r"–±—É–¥–µ—Ç –≤–∑–ª–µ—Ç", r"—Å–µ–π—á–∞—Å –≤–∑–ª–µ—Ç–∏—Ç", r"–≥–æ—Ç–æ–≤—ã –∫ –ª—É–Ω–µ",
        r"–¥–æ –ª—É–Ω—ã –Ω–µ –¥–æ–ª–≥–æ", r"—Å–∫–æ—Ä–æ 100x", r"x[0-9]+",
        r"–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–æ—Å—Ç", r"—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ"
    ],
    "fake_insider_info": [
        r"–∏–Ω—Å–∞–π–¥", r"–∏–∑–≤–µ—Å—Ç–Ω–æ –≤ –∫—É–ª—É–∞—Ä–∞—Ö", r"–∏–∑ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞",
        r"–ª—é–¥–∏ –≥–æ–≤–æ—Ä—è—Ç —á—Ç–æ", r"—è–∫–æ–±—ã", r"–ø–æ —Å–ª—É—Ö–∞–º", r"–≥–¥–µ-—Ç–æ —Å–ª—ã—à–∞–ª"
    ],
    "unrealistic_promises": [
        r"–æ—Ç–¥–∞–º [0-9]+ –º–æ–Ω–µ—Ç", r"—Ä–∞–∑–¥–∞—á—É —Ç–æ–∫–µ–Ω–æ–≤", r"–±–µ—Å–ø–ª–∞—Ç–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞–π",
        r"100% —Ä–æ—Å—Ç –∑–∞", r"—É–¥–≤–æ–µ–Ω–∏–µ –∑–∞"
    ],
    "cult_like_language": [
        r"—Å–µ–º—å—è", r"–±—Ä–∞—Ç—Å—Ç–≤–æ", r"–≤–µ—Ä–Ω–æ–ø–æ–¥–¥–∞–Ω–Ω", r"–∏–∑–±—Ä–∞–Ω–Ω",
        r"–ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏", r"—Å–ø–∞—Å–µ–Ω–∏", r"—Å–≤—è—Ç–æ–π –º–∏—Å—Å–∏–∏"
    ],
    "extreme_polarization": [
        r"—Ç–æ–ª—å–∫–æ –¥—É—Ä–∞–∫–∏", r"—Ç–æ–ª—å–∫–æ —É–º–Ω—ã–µ –ª—é–¥–∏", r"–≤—ã –ª–∏–±–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –ª–∏–±–æ",
        r"–Ω–µ –≤ –∫—É—Ä—Å–µ –Ω–∏—á–µ–≥–æ", r"–∑–∞–≤–µ–¥–æ–º–æ –≥–ª—É–ø–æ"
    ]
}

# ============================================================================
# –ê–ù–ê–õ–ò–ó–ê–¢–û–†
# ============================================================================

def analyze_propaganda(text: str) -> Optional[Dict]:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—ã –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π.
    
    Returns:
        Dict —Å –∫–ª—é—á–∞–º–∏:
        - is_propaganda: bool - –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—ã
        - confidence: float - —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç 0.0 –¥–æ 1.0
        - manipulations: List[Dict] - –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏
        - crypto_red_flags: List[str] - –∫—Ä–∏–ø—Ç–æ –∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏
        - analysis: str - —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
    """
    if not text or len(text) < 20:
        return None
    
    text_lower = text.lower()
    manipulations_found = []
    crypto_flags = []
    total_score = 0.0
    
    # ========== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π ==========
    for manip_type, patterns in PROPAGANDA_PATTERNS.items():
        score = 0.0
        found_keywords = []
        found_phrases = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        for keyword_pattern in patterns["keywords"]:
            matches = re.findall(keyword_pattern, text_lower)
            if matches:
                found_keywords.extend(matches)
                score += len(matches) * 0.1
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–∞–∑
        for phrase_pattern in patterns["phrases"]:
            matches = re.findall(phrase_pattern, text_lower)
            if matches:
                found_phrases.extend(matches)
                score += len(matches) * 0.2
        
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏–∑–Ω–∞–∫–∏
        if found_keywords or found_phrases:
            manipulations_found.append({
                "type": manip_type.value,
                "type_name": manip_type.name,
                "description": patterns["description"],
                "score": min(score, 1.0),
                "evidence": found_keywords + found_phrases
            })
            total_score += score
    
    # ========== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏–ø—Ç–æ –∫—Ä–∞—Å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ ==========
    for flag_category, patterns in CRYPTO_RED_FLAGS.items():
        for pattern in patterns:
            if re.search(pattern, text_lower):
                crypto_flags.append(f"üö© {flag_category}: {pattern[:30]}")
    
    # ========== –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫–æ—Ä–∞ ==========
    is_propaganda = len(manipulations_found) > 0 or len(crypto_flags) > 0
    confidence = min(total_score / 5.0, 1.0) if is_propaganda else 0.0
    
    if is_propaganda:
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∫–æ—Ä—É
        manipulations_found.sort(key=lambda x: x["score"], reverse=True)
        
        # –ë–µ—Ä–µ–º —Ç–æ–ø –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏
        top_manipulations = manipulations_found[:3]
        
        return {
            "is_propaganda": True,
            "confidence": confidence,
            "manipulations": top_manipulations,
            "crypto_red_flags": crypto_flags,
            "total_found": len(manipulations_found),
        }
    else:
        return {
            "is_propaganda": False,
            "confidence": 0.0,
            "manipulations": [],
            "crypto_red_flags": [],
            "total_found": 0,
        }


def format_propaganda_analysis(analysis: Dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—ã –¥–ª—è –≤—ã–≤–æ–¥–∞."""
    if not analysis or not analysis.get("is_propaganda"):
        return ""
    
    lines = [
        "‚ö†Ô∏è <b>–û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–ò–ó–ù–ê–ö–ò –ú–ê–ù–ò–ü–£–õ–Ø–¶–ò–ò:</b>\n"
    ]
    
    confidence_pct = int(analysis["confidence"] * 100)
    confidence_emoji = {
        (0, 30): "üü°",
        (30, 60): "üü†",
        (60, 100): "üî¥"
    }
    
    emoji = next(e for (low, high), e in confidence_emoji.items() if low <= confidence_pct <= high)
    
    lines.append(f"{emoji} –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: {confidence_pct}%\n")
    
    if analysis.get("manipulations"):
        lines.append("<b>üìç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏:</b>")
        for manip in analysis["manipulations"][:3]:
            manip_type = manip["type"]
            description = manip["description"]
            score = int(manip["score"] * 100)
            lines.append(f"  ‚Ä¢ <b>{manip_type}</b>: {description} ({score}%)")
    
    if analysis.get("crypto_red_flags"):
        lines.append("\n<b>üö© –ö—Ä–∏–ø—Ç–æ –∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏:</b>")
        for flag in analysis["crypto_red_flags"][:3]:
            lines.append(f"  {flag}")
    
    lines.append("\n<b>üí° –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:</b>")
    lines.append("–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å:")
    lines.append("  ‚Ä¢ –ü—Ä–æ–ø–∞–≥–∞–Ω–¥–æ–π (–≤–ª–∏—è–Ω–∏–µ –Ω–∞ –º–Ω–µ–Ω–∏–µ)")
    lines.append("  ‚Ä¢ –§–∏—à–∏–Ω–≥–æ–º –∏–ª–∏ —Å–∫–∞–º–æ–º (—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è)")
    lines.append("  ‚Ä¢ –î–µ–∑–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–ª–æ–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã)")
    
    lines.append("\n<b>‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å:</b>")
    lines.append("  1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–∫—Ç—ã –≤ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö")
    lines.append("  2Ô∏è‚É£ –ù–∞–π–¥–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è")
    lines.append("  3Ô∏è‚É£ –ù–µ –¥–µ–ª–∞–π—Ç–µ –ø–æ—Å–ø–µ—à–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π")
    lines.append("  4Ô∏è‚É£ –ü–æ–º–Ω–∏—Ç–µ: –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º —Ö–æ—Ä–æ—à–æ, –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ –ª–æ–∂")
    
    return "\n".join(lines)


def get_propaganda_tips() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–≤–µ—Ç—ã –∫–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏."""
    return """<b>üõ°Ô∏è –ö–ê–ö –†–ê–°–ü–û–ó–ù–ê–¢–¨ –ú–ê–ù–ò–ü–£–õ–Ø–¶–ò–Æ –ò –ü–†–û–ü–ê–ì–ê–ù–î–£:</b>

<b>1Ô∏è‚É£ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —è–∑—ã–∫</b>
  –í–º–µ—Å—Ç–æ —Ñ–∞–∫—Ç–æ–≤ - —Å—Ç—Ä–∞—Ö, –≥–Ω–µ–≤, –Ω–µ–Ω–∞–≤–∏—Å—Ç—å
  –ü—Ä–∏–º–µ—Ä: "–≠—Ç–æ —É–≥—Ä–æ–∑–∞ –≤–∞—à–µ–π —Å–µ–º—å–µ!" (–±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤)

<b>2Ô∏è‚É£ –°—Ä–æ—á–Ω–æ—Å—Ç—å –∏ –¥–µ—Ñ–∏—Ü–∏—Ç</b>
  "–°–ø–µ—à–∏—Ç–µ! –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ..."
  –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫–∞–º–∞—Ö –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏

<b>3Ô∏è‚É£ –ß—Ä–µ–∑–º–µ—Ä–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ</b>
  "–í—Å–µ –ø—Ä–æ—Å—Ç–æ" –∏–ª–∏ "–û—Ç–≤–µ—Ç –æ—á–µ–≤–∏–¥–µ–Ω"
  –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–ª–æ–∂–Ω–µ–µ

<b>4Ô∏è‚É£ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ "–ø—Ä–µ–¥—Ä–∞—Å—Å—É–¥–∫–∞–º"</b>
  –ï—Å–ª–∏ —É—Å–ª—ã—à–∞–ª–∏ —Ç–æ, —á—Ç–æ —É–∂–µ –≤–µ—Ä–∏–ª–∏ - —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫ —Å–∫–∞–º–∞
  –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –Ω–∞—à–∏ –ø—Ä–µ–¥—É–±–µ–∂–¥–µ–Ω–∏—è

<b>5Ô∏è‚É£ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</b>
  "–í—Å–µ –∑–Ω–∞—é—Ç", "–ª—é–¥–∏ –≥–æ–≤–æ—Ä—è—Ç", "–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç"
  –ë–µ–∑ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

<b>6Ô∏è‚É£ –ß–µ—Ä–Ω–æ-–±–µ–ª–æ–µ –º—ã—à–ª–µ–Ω–∏–µ</b>
  "–õ–∏–±–æ —Å –Ω–∞–º–∏, –ª–∏–±–æ –≤—Ä–∞–≥–∏"
  –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–±—ã—á–Ω–æ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –∏ –ø–æ–ª—É—Ç–æ–Ω–∞

<b>7Ô∏è‚É£ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤</b>
  –û–¥–Ω–æ –∏ —Ç–æ –∂–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–Ω–æ–≥–æ —Ä–∞–∑
  –°–æ –≤—Ä–µ–º–µ–Ω–µ–º –∑–≤—É—á–∏—Ç –∫–∞–∫ –ø—Ä–∞–≤–¥–∞

<b>8Ô∏è‚É£ –ù–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–∞</b>
  "–û–¥–∏–Ω –∏–∑–≤–µ—Å—Ç–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ —Å–∫–∞–∑–∞–ª"
  –≠—Ç–æ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —ç—Ç–æ –ø—Ä–∞–≤–¥–∞

<b>–í –∫—Ä–∏–ø—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ:</b>
  üö´ "–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 100% —Ä–æ—Å—Ç"
  üö´ "–ò–Ω—Å–∞–π–¥—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
  üö´ "–°–∫–æ—Ä–æ –≤–∑–ª–µ—Ç–∏—Ç –≤ X —Ä–∞–∑"
  üö´ "–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—é—Ç"
  üö´ "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Ä–∞–∑–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤"

<b>–ü–æ–º–Ω–∏—Ç–µ:</b> –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ - –≤–∞—à–∞ –ª—É—á—à–∞—è –∑–∞—â–∏—Ç–∞!
"""


def quick_propaganda_check(text: str) -> Tuple[bool, str]:
    """–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—ã."""
    analysis = analyze_propaganda(text)
    if analysis and analysis.get("is_propaganda"):
        confidence = analysis.get("confidence", 0)
        return True, f"‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å {int(confidence*100)}%)"
    return False, ""

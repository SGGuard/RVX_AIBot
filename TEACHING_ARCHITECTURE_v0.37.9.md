# ๐ Teaching System Architecture v0.37.9

## ๐ฏ ะัะพะฑะปะตะผะฐ: API ะฟะฐะดะฐะตั ะฟัะธ ะฑะพะปััะพะน ะฝะฐะณััะทะบะต

**ะกะธััะฐัะธั:** 
- User ะทะฐะฟัะฐัะธะฒะฐะตั expert ััะพะบ
- API ะฝะตะดะพัััะฟะตะฝ/ัะฟะฐะป
- ะกะธััะตะผะฐ ะฟะพะบะฐะทัะฒะฐะตั "API ะฒัะตะผะตะฝะฝะพ ะฝะตะดะพัััะฟะตะฝ"
- ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฟะพะปััะฐะตั ะบะพะฝัะตะฝั

**ะะพัะตะฝั ะฟัะพะฑะปะตะผั:**
- teach_lesson ะธัะฟะพะปัะทัะตััั ัะตัะตะท HTTP API ะบ ะพัะดะตะปัะฝะพะผั ัะตัะฒะตัั
- ะัะธ ะฑะพะปััะพะน ะฝะฐะณััะทะบะต API ะผะพะถะตั ัะฟะฐััั/ะทะฐะฒะธัะฝััั
- ะะตั fallback ะฝะฐ Gemini ะฒัะทะพะฒ ะฝะฐะฟััะผัั

## โ ะะตัะตะฝะธะต v0.37.9: ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ะฐััะธัะตะบัััะฐ

### ะฃัะพะฒะตะฝั 1: ะัััะพะตะฝะฝัะน ะบะพะฝัะตะฝั (100% ะฝะฐะดะตะถะฝัะน)
```
teach_lesson() 
  โ embedded_teacher.get_embedded_lesson() 
    โ EMBEDDED_CURRICULUM (beginner/intermediate/advanced)
    โ โก ะััััะพ, ะฒัะตะณะดะฐ ัะฐะฑะพัะฐะตั
```

### ะฃัะพะฒะตะฝั 2: API ัะตัะฒะตั (ะฑัััััะน, ะฝะพ ะผะพะถะตั ัะฟะฐััั)
```
teach_lesson()
  โ HTTP POST ะบ /teach_lesson endpoint
    โ api_server.py ะฒัะทัะฒะฐะตั embedded_teacher
    โ โ๏ธ ะะพะถะตั ัะฟะฐััั ะฟัะธ ะฝะฐะณััะทะบะต
    โ Timeout 30 ัะตะบ
```

### ะฃัะพะฒะตะฝั 3: Gemini ะฝะฐะฟััะผัั (ะพะฑัะพะด API) โจ NEW!
```
teach_lesson()
  โ API ัะฟะฐะป? ConnectError / TimeoutError
  โ teach_lesson_via_gemini_direct()
    โ ะัะทัะฒะฐะตั google.genai.Client ะฝะฐะฟััะผัั
    โ ะะฑัะพะดะธั API ัะตัะฒะตั ะฟะพะปะฝะพัััั
    โ โ ะะฐะฑะพัะฐะตั ะดะฐะถะต ะตัะปะธ API ัะฟะฐะป
```

### ะฃัะพะฒะตะฝั 4: ะะฝัะตะปะปะตะบััะฐะปัะฝัะน fallback (ะฟะพัะปะตะดะฝัั ะฝะฐะดะตะถะดะฐ)
```
teach_lesson()
  โ ะัะต ัะปะพะถะธะปะพัั? 
  โ _get_fallback_lesson()
    โ ะััะฐะตััั advanced ะฒัััะพะตะฝะฝัะน (ะตัะปะธ expert ะทะฐะฟัะฐัะธะฒะฐะปัั)
    โ ะะพะทะฒัะฐัะฐะตั ัะตะฐะปัะฝัะน ะบะพะฝัะตะฝั (ะฝะต "offline mode")
```

## ๐ ะฆะตะฟะพัะบะฐ ะพะฑัะฐะฑะพัะบะธ (v0.37.9)

### ะกัะตะฝะฐัะธะน 1: ะะฑััะฝะฐั ัะธััะฐัะธั
```
User: expert ััะพะบ
API: โ ะดะพัััะฟะตะฝ
ะะตะทัะปััะฐั: API โ embedded advanced โ ะบะพะฝัะตะฝั โ
```

### ะกัะตะฝะฐัะธะน 2: API ะฟะตัะตะณััะถะตะฝ
```
User: expert ััะพะบ
API: โ timeout (30 ัะตะบ)
Fallback: Gemini ะฝะฐะฟััะผัั โ ะบะพะฝัะตะฝั โ
ะัะตะธะผััะตััะฒะพ: ะะธะฝัะตั API, ะฑััััะตะต
```

### ะกัะตะฝะฐัะธะน 3: ะะฑะฐ ะะ ะฟะฐะดะฐัั (ัะตะดะบะพ)
```
User: expert ััะพะบ
API: โ ConnectError
Gemini: โ rate limit ะธะปะธ ะฝะตั ะบะปััะฐ
Fallback: advanced ะฒัััะพะตะฝะฝัะน โ ะบะพะฝัะตะฝั โ
ะะตะทัะปััะฐั: ะะพะปัะทะพะฒะฐัะตะปั ะฒัั ัะฐะฒะฝะพ ะฟะพะปััะฐะตั ะบะพะฝัะตะฝั!
```

## ๐ ะะปััะตะฒัะต ะธะทะผะตะฝะตะฝะธั

### 1. embedded_teacher.py (v0.37.8)
```python
# ะะซะะ: ะกะบััะฒะฐะปะพ ะพััััััะฒะธะต ััะพะฒะฝั
if difficulty_lower not in lessons:
    return lessons.get("beginner")  # โ expert โ beginner!

# ะกะขะะะ: ะฏะฒะฝะพ ะฒะพะทะฒัะฐัะฐะตั None
if difficulty_lower not in lessons:
    return None  # โ ะกะธะณะฝะฐะปะธะทะธััะตั ะพะฑ ะพััััััะฒะธะธ
```

### 2. api_server.py (v0.37.8)
```python
# ะัะพะฒะตััะตั ะดะพัััะฟะฝัะต ััะพะฒะฝะธ ะะ ะทะฐะณััะทะบะธ
available_difficulties = get_difficulties_for_topic(topic)
if difficulty == "expert" and "advanced" in available_difficulties:
    difficulty = "advanced"  # expert โ advanced (ะฝะต beginner!)
```

### 3. teacher.py (v0.37.9)
```python
# ะะพะฒะฐั ััะฝะบัะธั ะดะปั ะฟััะผะพะณะพ ะฒัะทะพะฒะฐ Gemini
async def teach_lesson_via_gemini_direct(topic, difficulty_level):
    """ะัะทัะฒะฐะตั Gemini ะฝะฐะฟััะผัั, ะพะฑัะพะดั API"""
    client = genai.Client(api_key=gemini_api_key)
    return client.models.generate_content(...)

# ะ teach_lesson: fallback ะบ Gemini ะฟัะธ ะพัะธะฑะบะฐั API
except httpx.ConnectError:
    gemini_result = await teach_lesson_via_gemini_direct(topic, difficulty_level)
    if gemini_result:
        return gemini_result
    return _get_fallback_lesson(topic, difficulty_level)
```

## ๐ ะฃะปัััะตะฝะธั ะฝะฐะดะตะถะฝะพััะธ

| ะกะธััะฐัะธั | v0.37.7 | v0.37.9 |
|---------|---------|---------|
| API ัะฐะฑะพัะฐะตั ะฝะพัะผะฐะปัะฝะพ | โ ะะพะฝัะตะฝั | โ ะะพะฝัะตะฝั |
| API timeout | โ "offline mode" | โ Gemini ะบะพะฝัะตะฝั |
| API CrashError | โ "offline mode" | โ Gemini ะบะพะฝัะตะฝั |
| ะะฑะฐ ัะฟะฐะปะธ | โ "offline mode" | โ Advanced ะฒัััะพะตะฝะฝัะน |

## ๐ก ะะพัะตะผั ััะพ ัะตัะฐะตั ะฟัะพะฑะปะตะผั ะฟัะธ ะฑะพะปััะพะน ะฝะฐะณััะทะบะต

1. **ะะตะบะพะดะธัะพะฒะฐะฝะธะต ะฝะฐะณััะทะบะธ**: ะะต ะฒัะตะผ ะทะฐะฟัะพัะฐะผ ะฝัะถะตะฝ ะพัะดะตะปัะฝัะน API ะฟัะพัะตัั
2. **ะะฝะพะถะตััะฒะตะฝะฝัะต fallback**: ะััั 3 ััะพะฒะฝั ัะตะทะตัะฒะฐ
3. **ะััััะตะต**: Gemini ะฝะฐะฟััะผัั ะฑััััะตะต ัะตะผ HTTP + API ัะตัะฒะตั
4. **ะะฒัะพะผะฐัะธัะฝะพ**: Fallback ะฟัะพะธััะพะดะธั ะฑะตะท ะฒะผะตัะฐัะตะปัััะฒะฐ

## ๐ฎ ะัะดััะธะต ัะปัััะตะฝะธั

- ะะตัะธัะพะฒะฐะฝะธะต Gemini ัะตะทัะปััะฐัะพะฒ
- Circuit breaker ะดะปั API (ะพัะบะปััะธัั ะตัะปะธ ะผะฝะพะณะพ ะพัะธะฑะพะบ)
- ะะตััะธะบะธ: ะบะฐะบะพะน fallback ะธัะฟะพะปัะทัะตััั ัะฐัะต ะฒัะตะณะพ
- ะะตัะตะตัะฐัั ะฝะฐ ะฒัััะพะตะฝะฝัะต ััะพะบะธ ะฟะพะปะฝะพัััั (ัะฑัะฐัั API ะดะปั ะพะฑััะตะฝะธั)

## ๐ ะััะธัะตะบัััะฐ: 2 ะฟัะพัะตััะฐ ะฒะผะตััะพ 3

```
ะะะะฌะจะ (v0.37.7):
โโโโโโโโโโโโโโโ
โ   bot.py    โ โ Telegram
โโโโโโโโโโโโโโโค
โ teacher.py  โ
โ   (uses     โ
โ  API only)  โ
โโโโโโโโฌโโโโโโโ
       โ HTTP
       โผ
โโโโโโโโโโโโโโโ
โ api_server  โ โ ะะพะถะตั ัะฟะฐััั!
โ (FastAPI)   โ
โโโโโโโโโโโโโโโ

ะขะะะะะฌ (v0.37.9):
โโโโโโโโโโโโโโโโโโโโ
โ    bot.py        โ โ Telegram
โโโโโโโโโโโโโโโโโโโโค
โ  teacher.py      โ
โ  (3 fallback:    โ
โ   1. API         โ
โ   2. Gemini      โ โ ะะฐะฟััะผัั
โ   3. Embedded)   โ
โโโโโโโโโโโโโโโโโโโโ
       โ HTTP (ะพะฟัะธะพะฝะฐะปัะฝะพ)
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  api_server      โ โ ะะตะพะฑัะทะฐัะตะปะตะฝ ะดะปั ะพะฑััะตะฝะธั
โ  (FastAPI)       โ
โโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะะตััะธะพะฝะธัะพะฒะฐะฝะธะต

- **v0.37.6**: ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ััะพะฒะฝะตะน
- **v0.37.7**: ะะฝัะตะปะปะตะบััะฐะปัะฝัะน fallback ั ะฒัััะพะตะฝะฝัะผะธ ััะพะบะฐะผะธ
- **v0.37.8**: ะฃะดะฐะปะตะฝะธะต ะฒัััะพะตะฝะฝะพะณะพ fallback ะฒ embedded_teacher
- **v0.37.9**: Gemini ะฒัะทะพะฒ ะฝะฐะฟััะผัั ะบะฐะบ fallback โ ะะซ ะะะะกะฌ

## โ ะะตะทัะปััะฐั

ะขะตะฟะตัั ะฟะพะปัะทะพะฒะฐัะตะปะธ **ะะะะะะะ** ะฝะต ะฒะธะดัั "API ะฒัะตะผะตะฝะฝะพ ะฝะตะดะพัััะฟะตะฝ" ะฑะตะท ะบะพะฝัะตะฝัะฐ.
ะะผะตััะพ ััะพะณะพ:
- โ ะะพะปััะฐัั ัะตะฐะปัะฝัะน ะบะพะฝัะตะฝั (ะพะฑััะตะฝะธะต ะฒัะตะณะดะฐ ัะฐะฑะพัะฐะตั)
- โ ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะธัะฟะพะปัะทัะตั ะปัััะธะน ะดะพัััะฟะฝัะน ะผะตัะพะด
- โ ะััะธัะตะบัััะฐ ะฑะพะปะตะต ัััะพะนัะธะฒะฐ ะบ ะฝะฐะณััะทะบะต

๐ ะะพัะพะฒะพ ะบ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั!

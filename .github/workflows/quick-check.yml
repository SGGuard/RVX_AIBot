name: Quick Health Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quick-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: üîç Syntax Check
      run: |
        echo "Checking Python syntax..."
        python -m py_compile bot.py api_server.py ai_dialogue.py
        echo "‚úÖ Syntax OK"
    
    - name: üîç Import Check
      run: |
        echo "Checking imports..."
        python << 'EOF'
        import sys
        
        # Check critical packages
        critical_packages = {
            'groq': 'Groq API',
            'mistralai': 'Mistral AI',
            'fastapi': 'FastAPI',
            'telegram': 'Telegram Bot',
            'httpx': 'HTTP Client',
            'sqlalchemy': 'Database ORM',
        }
        
        missing = []
        for pkg, name in critical_packages.items():
            try:
                __import__(pkg)
                print(f"‚úÖ {name} ({pkg}) available")
            except ImportError:
                print(f"‚ö†Ô∏è  {name} ({pkg}) not available")
                missing.append(pkg)
        
        if missing:
            print(f"\n‚ö†Ô∏è  Missing packages: {', '.join(missing)}")
            print("Note: This is OK if requirements.txt is correct")
        else:
            print("\n‚úÖ All critical packages available")
        EOF
    
    - name: üìä File Structure Check
      run: |
        python << 'EOF'
        import os
        
        checks = {
            "Core files": ["bot.py", "api_server.py", "ai_dialogue.py"],
            "Config": ["requirements.txt", ".env.example"],
            "Docs": ["README.md"],
        }
        
        all_ok = True
        for category, files in checks.items():
            print(f"\n{category}:")
            for f in files:
                exists = os.path.exists(f)
                status = "‚úÖ" if exists else "‚ùå"
                print(f"  {status} {f}")
                if not exists and category == "Core files":
                    all_ok = False
        
        if all_ok:
            print("\n‚úÖ All critical files present")
        else:
            print("\n‚ö†Ô∏è  Some core files missing!")
            exit(1)
        EOF
    
    - name: üìà Code Metrics
      run: |
        python << 'EOF'
        import os
        
        files = {
            "bot.py": 0,
            "api_server.py": 0,
            "ai_dialogue.py": 0,
        }
        
        for fname in files:
            if os.path.exists(fname):
                with open(fname) as f:
                    files[fname] = len(f.readlines())
        
        print("\nCode Size:")
        total = 0
        for fname, lines in files.items():
            if lines > 0:
                print(f"  {fname:20s} {lines:5d} lines")
                total += lines
        print(f"  {'TOTAL':20s} {total:5d} lines")
        EOF
    
    - name: üîç Python Syntax Validation
      run: |
        python << 'EOF'
        import ast
        import sys
        
        files_to_check = ['bot.py', 'api_server.py', 'ai_dialogue.py']
        errors = []
        
        for fname in files_to_check:
            try:
                with open(fname, 'r', encoding='utf-8') as f:
                    code = f.read()
                ast.parse(code)
                print(f"‚úÖ {fname}: Valid Python syntax")
            except SyntaxError as e:
                print(f"‚ùå {fname}: Syntax error at line {e.lineno}: {e.msg}")
                errors.append(fname)
            except Exception as e:
                print(f"‚ö†Ô∏è  {fname}: {type(e).__name__}: {e}")
        
        if errors:
            print(f"\n‚ùå Syntax errors in: {', '.join(errors)}")
            sys.exit(1)
        else:
            print(f"\n‚úÖ All files have valid Python syntax")
        EOF
    
    - name: ‚úÖ All Checks Complete
      run: echo "‚úÖ Health check passed!"

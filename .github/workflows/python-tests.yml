name: Python Tests & Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --tb=short || echo "Tests completed with status $?"
      continue-on-error: true
    
    - name: Run code quality checks
      run: |
        pip install pylint flake8 mypy black
        echo "ðŸ” Checking code format with black..."
        black --check *.py 2>/dev/null || echo "Format check finished"
        echo "ðŸ” Running flake8..."
        flake8 *.py --max-line-length=120 --ignore=E501,W503 2>/dev/null || echo "Flake8 check finished"
      continue-on-error: true
    
    - name: Check imports
      run: |
        python << 'EOF'
        critical_modules = ['groq', 'mistralai', 'fastapi', 'telegram']
        missing = []
        
        for module in critical_modules:
            try:
                __import__(module)
                print(f"âœ… {module} available")
            except ImportError:
                print(f"âš ï¸  {module} not available")
                missing.append(module)
        
        if missing:
            print(f"\nNote: {len(missing)} package(s) missing - checking requirements.txt...")
            with open('requirements.txt', 'r') as f:
                req_content = f.read()
                for m in missing:
                    if m in req_content:
                        print(f"  {m} is in requirements.txt âœ…")
        else:
            print("\nâœ… All critical modules available")
        EOF
    
    - name: Verify critical files
      run: |
        python << 'EOF'
        import os
        
        required_files = [
            'bot.py',
            'api_server.py', 
            'ai_dialogue.py',
            'requirements.txt',
            '.env.example',
        ]
        
        print("ðŸ” Verifying critical files...")
        for file in required_files:
            if os.path.exists(file):
                print(f"  âœ… {file}")
            else:
                print(f"  âŒ {file} MISSING!")
                exit(1)
        
        # Check requirements.txt has critical dependencies
        with open('requirements.txt', 'r') as f:
            content = f.read()
            critical = ['fastapi', 'python-telegram-bot', 'httpx', 'groq', 'mistralai']
            for dep in critical:
                if dep in content:
                    print(f"  âœ… {dep} in requirements.txt")
                else:
                    print(f"  âŒ {dep} MISSING from requirements.txt!")
                    exit(1)
        
        print("\nâœ… All checks passed!")
        EOF

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Run security checks
      run: |
        echo "ðŸ”’ Running Bandit security scan..."
        bandit -r *.py -ll 2>/dev/null || echo "Bandit scan completed"
      continue-on-error: true
    
    - name: Check dependencies for vulnerabilities
      run: |
        echo "ðŸ”’ Checking dependencies..."
        pip install -r requirements.txt 2>/dev/null
        safety check --json 2>/dev/null || echo "Safety check completed"
      continue-on-error: true

# v0.33.2: Crypto Calculator Error Handling Fix

## Проблема
При использовании крипто-калькулятора появлялась ошибка:
```
❌ Произошла внутренняя ошибка.
Пожалуйста, попробуйте позже.
```

## Причины
1. **Отсутствие обработки исключений** в callback handlers для калькулятора
   - `calc_token_*` callback (выбор токена и показ параметров)
   - `calc_menu` callback (возврат к меню)
   - Обработка ввода цены в `handle_message`

2. **Недостаточное логирование** в функциях расчета
   - `format_calculator_result()` - форматирование результата
   - `calculate_market_cap()` - основной расчет

3. **Частичная обработка ошибок** при редактировании сообщений
   - Только пустой `except:` без логирования

## Решение (v0.33.2)

### 1. Обработка цены в handle_message (строки 10374-10421)
```python
if context.user_data.get("waiting_for_price"):
    try:
        # Валидация, расчет, отправка результата
        ...
    except Exception as e:
        logger.error(f"❌ Ошибка в калькуляторе: {str(e)}", exc_info=True)
        context.user_data["waiting_for_price"] = False
        await update.message.reply_text(
            "❌ Произошла ошибка при расчете. Пожалуйста, попробуйте позже.\n\n"
            "Используйте /calc для новой попытки."
        )
```

**Улучшения:**
- Try-except блок вокруг всего процесса обработки цены
- Логирование ошибки с полным stack trace (exc_info=True)
- Очистка флага `waiting_for_price` при ошибке
- Понятное сообщение об ошибке пользователю
- Исправлена ошибка: `format_price()` → `${price:,.2f}`

### 2. Callback calc_token_* (строки 8924-8978)
```python
if data.startswith("calc_token_"):
    try:
        # Получение данных токена и показ параметров
        ...
    except Exception as e:
        logger.error(f"❌ Ошибка в calc_token callback: {str(e)}", exc_info=True)
        try:
            await query.answer("❌ Произошла ошибка. Попробуйте позже.", show_alert=True)
        except:
            pass
```

**Улучшения:**
- Основной try-except для всего callback
- Дополнительный try-except при отправке alert (на случай если query закрыт)
- Полное логирование с exc_info=True
- Вложенная обработка ошибок при редактировании сообщения

### 3. Callback calc_menu (строки 8980-9032)
```python
if data == "calc_menu":
    try:
        # Построение меню и отправка
        ...
    except Exception as e:
        logger.error(f"❌ Ошибка в calc_menu callback: {str(e)}", exc_info=True)
        try:
            await query.answer("❌ Произошла ошибка. Попробуйте позже.", show_alert=True)
        except:
            pass
```

**Улучшения:**
- Полная обработка ошибок в процессе построения меню
- Защита от сбоев при отправке уведомления
- Детальное логирование

### 4. format_calculator_result() (crypto_calculator.py, строки 204-250)
```python
def format_calculator_result(token_symbol: str, price: float) -> str:
    try:
        # Расчеты и форматирование
        ...
        return result
    except Exception as e:
        logger.error(f"❌ Ошибка в format_calculator_result: token_symbol={token_symbol}, price={price}, error={str(e)}", exc_info=True)
        return f"❌ Ошибка при расчете для токена {token_symbol}. Попробуйте позже."
```

**Улучшения:**
- Обработка всех возможных ошибок при форматировании
- Логирование параметров для отладки
- Возврат понятного сообщения об ошибке вместо краша

### 5. calculate_market_cap() (crypto_calculator.py, строки 130-143)
```python
def calculate_market_cap(total_supply: float, price: float) -> Tuple[float, str]:
    try:
        market_cap = total_supply * price
        return market_cap, format_market_cap(market_cap)
    except Exception as e:
        logger.error(f"❌ Ошибка в calculate_market_cap: total_supply={total_supply}, price={price}, error={str(e)}", exc_info=True)
        return 0, "$0.00"
```

**Улучшения:**
- Защита от математических ошибок (overflow, invalid types)
- Безопасный fallback с нулевыми значениями
- Логирование для отладки

## Что изменилось

### Файл: bot.py
- **Строки 10374-10421**: Полная переработка обработки цены с try-except
- **Строки 8924-8978**: Добавлена обработка ошибок в calc_token_* callback
- **Строки 8980-9032**: Добавлена обработка ошибок в calc_menu callback
- **Исправлено**: Удалена несуществующая функция `format_price()`, использован встроенный формат

### Файл: crypto_calculator.py
- **Строки 130-143**: Обработка ошибок в calculate_market_cap()
- **Строки 204-250**: Полная переработка format_calculator_result() с try-except

## Логирование для отладки

Теперь при ошибках будут видны логи типа:
```
❌ Ошибка в калькуляторе: division by zero
Traceback (most recent call last):
  File "bot.py", line 10388, in handle_message
    calculator_result = format_calculator_result(token_symbol, price)
  ...
```

Это поможет быстро найти и исправить проблемы.

## Тестирование

После восстановления кода убедитесь, что:
1. ✅ /calc открывает меню выбора токенов
2. ✅ Выбор токена показывает его параметры
3. ✅ Ввод цены (0.001, 1.5, 100) работает корректно
4. ✅ При неправильной цене показывается ошибка валидации
5. ✅ При критической ошибке - понятное сообщение вместо краша

## Версия
- **v0.33.2** - Улучшена обработка ошибок в калькуляторе
- Commit: e3b8e2d
- Статус: ✅ Deployed to Railway

## История
- v0.33.0 - Первая версия калькулятора
- v0.33.1 - Исправлена форматирование больших чисел (B/M/K notation)
- v0.33.2 - Добавлена полная обработка ошибок с логированием

"""
üìÖ ECONOMIC CALENDAR PROCESSOR - v1.0

–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π.
–†–µ–∂–∏–º: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ + –ê–Ω–∞–ª–∏–∑ + –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è
"""

import logging
import re
from typing import Optional

logger = logging.getLogger(__name__)


def build_calendar_processing_prompt() -> str:
    """
    ‚úÖ –ü–†–û–ú–ü–¢ –†–ï–ñ–ò–ú–ê –û–ë–†–ê–ë–û–¢–ö–ò –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–û–ì–û –ö–ê–õ–ï–ù–î–ê–†–Ø v1.0
    
    –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ: "–û–ë–†–ê–ë–û–¢–ê–ô –í–°–ï –°–û–ë–´–¢–ò–Ø"
    –ó–∞–¥–∞—á–∞: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å, –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–≥–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π.
    """
    return """ü§ñ –†–ï–ñ–ò–ú –û–ë–†–ê–ë–û–¢–ö–ò –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–û–ì–û –ö–ê–õ–ï–ù–î–ê–†–Ø v1.0

–¢—ã - –§–ò–ù–ê–ù–°–û–í–´–ô –ê–ù–ê–õ–ò–¢–ò–ö –∏ –ü–û–ú–û–©–ù–ò–ö –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π.
–¢–≤–æ—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ó–ê–î–ê–ß–ê: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–ª–∏—è–Ω–∏–µ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å.

‚ö†Ô∏è –ñ–ï–õ–ï–ó–ù–û–ï –ü–†–ê–í–ò–õ–û ‚Ññ1: –û–ë–†–ê–ë–û–¢–ê–ô –í–°–ï –°–û–ë–´–¢–ò–Ø
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–µ—Å –°–ü–ò–°–û–ö —Å–æ–±—ã—Ç–∏–π ‚Üí —Ç—ã –ê–ù–ê–õ–ò–ó–ò–†–£–ï–®–¨ –ö–ê–ñ–î–û–ï —Å–æ–±—ã—Ç–∏–µ –≤ —ç—Ç–æ–º —Å–ø–∏—Å–∫–µ
‚úÖ –ï—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ 5 —Å–æ–±—ã—Ç–∏–π ‚Üí —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –ø—Ä–æ 5, –∞ –Ω–µ –ø—Ä–æ 1
‚úÖ –ï—Å–ª–∏ –∫–∞–∫–æ–µ-—Ç–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ—è—Å–Ω–æ ‚Üí —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ, –Ω–æ –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å –µ–≥–æ
‚ùå "–î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–∞–∂–¥–æ–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ" + –Ω–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
‚ùå –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ "—Å–≤–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å" = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

‚ö†Ô∏è –ñ–ï–õ–ï–ó–ù–û–ï –ü–†–ê–í–ò–õ–û ‚Ññ2: –ù–ï –≠–ù–¶–ò–ö–õ–û–ü–ï–î–ò–Ø
‚úÖ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–Ω–∞–µ—Ç —á—Ç–æ —Ç–∞–∫–æ–µ LPR (–ø—Ä–∏–Ω–µ—Å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ) ‚Üí –ù–ï —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
‚úÖ –ï—Å–ª–∏ –ø—Ä–∏–≤–µ–ª –¥–∞–Ω–Ω—ã–µ ‚Üí —Ä–∞–±–æ—Ç–∞–π —Å –î–ê–ù–ù–´–ú–ò, –∞ –Ω–µ —Å —Ç–µ–æ—Ä–∏–µ–π
‚ùå "–°—Ç–∞–≤–∫–∞ LPR —ç—Ç–æ..." (–æ–Ω —É–∂–µ –∑–Ω–∞–µ—Ç, –æ–Ω –ø—Ä–∏–Ω–µ—Å –∫–∞–ª–µ–Ω–¥–∞—Ä—å!)
‚ùå "–í–í–ü —ç—Ç–æ –≤–∞–ª–æ–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç..." (—Ö–≤–∞—Ç–∏—Ç –ª–µ–∫—Ü–∏–π!)

‚ö†Ô∏è –ñ–ï–õ–ï–ó–ù–û–ï –ü–†–ê–í–ò–õ–û ‚Ññ3: –û–î–ù–û –°–û–û–ë–©–ï–ù–ò–ï = –û–î–ù–ê –¶–ï–ù–ù–û–°–¢–¨
‚úÖ –î–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ—Ç–æ—Ä–æ–π –ù–ï –±—ã–ª–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ
‚úÖ –ü–æ–º–æ–≥–∞–π –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫ —á—Ç–æ–±—ã –±—ã–ª–æ –ª–µ–≥—á–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
‚ùå –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞
‚ùå –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç

üìã –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï):

1Ô∏è‚É£ –°–¢–†–£–ö–¢–£–†–ê: –†–∞–∑–±–∏—Ç—å –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ –í–ê–ñ–ù–û–°–¢–ò –¥–ª—è –∫—Ä–∏–ø—Ç–æ:
   ‚Ä¢ üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï (–ø—Ä—è–º–æ –≤–ª–∏—è—é—Ç –Ω–∞ –∫—Ä–∏–ø—Ç–æ –∏ –∞–∫—Ü–∏–∏)
   ‚Ä¢ üü† –í–ê–ñ–ù–´–ï (–∫–æ—Å–≤–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ, —É—Å–∏–ª–∏–≤–∞—é—Ç/–æ—Å–ª–∞–±–ª—è—é—Ç —Ñ–æ–Ω)
   ‚Ä¢ üü° –§–û–ù–û–í–´–ï (—Å–ª–∞–±–æ–µ –≤–ª–∏—è–Ω–∏–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —à—É–º—ã)

2Ô∏è‚É£ –î–õ–Ø –ö–ê–ñ–î–û–ì–û –°–û–ë–´–¢–ò–Ø: [–ù–∞–∑–≤–∞–Ω–∏–µ] ‚Üí [–í—Ä–µ–º—è] ‚Üí [–û–∂–∏–¥–∞–Ω–∏–µ] ‚Üí [–í–ª–∏—è–Ω–∏–µ –Ω–∞ –∫—Ä–∏–ø—Ç–æ] ‚Üí [–†–∏—Å–∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏]

3Ô∏è‚É£ –ê–ù–ê–õ–ò–ó –î–õ–Ø –í–°–ï–•: 
   ‚Ä¢ –ß—Ç–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è (–ø–æ –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É/–∏—Å—Ç–æ—Ä–∏–∏)
   ‚Ä¢ –ö—É–¥–∞ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å (–∫–∞–∫–∏–µ –∞–∫—Ç–∏–≤—ã)
   ‚Ä¢ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è)
   ‚Ä¢ –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å (—Å—é—Ä–ø—Ä–∏–∑—ã, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

4Ô∏è‚É£ –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î:
   ‚Ä¢ –ö–∞–∫–æ–π –¥–µ–Ω—å –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ (—Å–ø–æ–∫–æ–π–Ω—ã–π/—É–º–µ—Ä–µ–Ω–Ω—ã–π/–≥–æ—Ä—è—á–∏–π)
   ‚Ä¢ –ì–¥–µ –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Å–∫/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
   ‚Ä¢ –ß—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Å–æ–±—ã—Ç–∏–µ–º
   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ç–æ—Ä–≥–æ–≤–ª–µ (–µ—Å–ª–∏ –º–æ–∂–µ—à—å)

üéØ –ó–û–õ–û–¢–û–ô –ü–†–ò–ú–ï–† –ò–î–ï–ê–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê (—Å—Ä–∞–≤–Ω–∏ —Å –ø—Ä–æ—Å—å–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):

–ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–ò–í–ï–õ:
"
üìÖ 22 –¥–µ–∫–∞–±—Ä—è
üá®üá≥ LPR (04:15 –º—Å–∫) - expected no change
üá¨üáß GDP UK (10:00 –º—Å–∫) - soft
üá∫üá∏ Chicago Fed Index (16:30 –º—Å–∫) - mixed
üá∫üá∏ PCE Price Index (18:00 –º—Å–∫) - –æ–∂–∏–¥–∞–µ—Ç—Å—è +3.2%
üá∫üá∏ Trump statement (00:30 –º—Å–∫) - –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ
"

–¢–û –ò–î–ï–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ (–¢–ï 4 –ë–õ–û–ö–ê):

ü§ñ RVX –ê–ù–ê–õ–ò–ó –ö–ê–õ–ï–ù–î–ê–†–Ø
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –°–û–ë–´–¢–ò–Ø:
üá∫üá∏ PCE Price Index (18:00 –º—Å–∫)
‚Ä¢ –û–∂–∏–¥–∞–µ—Ç—Å—è: +3.2% (–∫–æ–Ω—Å–µ–Ω—Å—É—Å, –≤—ã—à–µ —Å–µ–Ω—Ç—è–±—Ä—è)
‚Ä¢ –í–ª–∏—è–Ω–∏–µ: –ü–†–Ø–ú–û–ï –Ω–∞ –§–†–° —Ä–µ—à–µ–Ω–∏—è –ø–æ —Å—Ç–∞–≤–∫–∞–º
‚Ä¢ –ù–∞ –∫—Ä–∏–ø—Ç–æ: –ï—Å–ª–∏ –≤—ã—à–µ +3.3% ‚Üí –ø–∞–Ω–∏–∫–∞ ‚Üí BTC –ø–∞–¥–∞–µ—Ç. –ï—Å–ª–∏ –Ω–∏–∂–µ +3.0% ‚Üí –æ–±–ª–µ–≥—á–µ–Ω–∏–µ ‚Üí BTC —Ä–∞—Å—Ç–µ—Ç
‚Ä¢ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –í–´–°–û–ö–ê–Ø (¬±5-10% –∑–∞ 15 –º–∏–Ω—É—Ç –≤ –º–æ–º–µ–Ω—Ç –≤—ã—Ö–æ–¥–∞)
‚Ä¢ –°–º–æ—Ç—Ä–µ—Ç—å: Core PCE (–±–µ–∑ –µ–¥—ã) –±—É–¥–µ—Ç –≤—ã—à–µ/–Ω–∏–∂–µ? –ï—Å–ª–∏ Core —Ä–∞—Å—Ç–µ—Ç ‚Üí –µ—â–µ –±–æ–ª—å—à–µ –ø–∞–Ω–∏–∫–∏

üá∫üá∏ Trump Statement (00:30 –º—Å–∫)
‚Ä¢ –ß—Ç–æ –º–æ–≥–ª–æ –±—ã—Ç—å: –û–±—ã—á–Ω–æ –ø—Ä–æ —Ç–æ—Ä–≥–æ–≤—ã–µ –≤–æ–π–Ω—ã, —Ç–∞—Ä–∏—Ñ—ã, –¥–æ–ª–ª–∞—Ä
‚Ä¢ –ù–∞ –∫—Ä–∏–ø—Ç–æ: –ö—Ä–∏–ø—Ç–æ –õ–Æ–ë–ò–¢ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑–∞–µ–º–æ—Å—Ç—å + –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã ‚Üí –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ—Ä—Ö
‚Ä¢ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –í–´–°–û–ö–ê–Ø (–Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ) 
‚Ä¢ –†–∏—Å–∫: –ï—Å–ª–∏ –±—É–¥–µ—Ç –ø—Ä–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏–ø—Ç–æ ‚Üí –ø–∞–Ω–∏–∫–∞ –≤–Ω–∏–∑ –Ω–∞ -10-20%

üü† –í–ê–ñ–ù–´–ï –°–û–ë–´–¢–ò–Ø:
üá¨üáß GDP UK (10:00 –º—Å–∫)
‚Ä¢ –û–∂–∏–¥–∞–µ—Ç—Å—è: –ú—è–≥–∫–æ (slow growth)
‚Ä¢ –ù–∞ –∫—Ä–∏–ø—Ç–æ: –∫–æ—Å–≤–µ–Ω–Ω–æ ‚Üí –µ—Å–ª–∏ GBP –ø–∞–¥–∞–µ—Ç ‚Üí BTC –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏
‚Ä¢ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: —Å—Ä–µ–¥–Ω—è—è (—Ç–æ–ª—å–∫–æ –¥–ª—è GBP –ø–∞—Ä)

üá∫üá∏ Chicago Fed Index (16:30 –º—Å–∫)
‚Ä¢ –û–∂–∏–¥–∞–µ—Ç—Å—è: Mixed (–≤—Ç–æ—Ä–∏—á–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
‚Ä¢ –ù–∞ –∫—Ä–∏–ø—Ç–æ: —Å–ª–∞–±–æ–µ –≤–ª–∏—è–Ω–∏–µ, –º–æ–∂–µ—Ç —É—Å–∏–ª–∏—Ç—å —Ç—Ä–µ–Ω–¥ –ø–µ—Ä–µ–¥ PCE
‚Ä¢ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è-—Å—Ä–µ–¥–Ω—è—è

üü° –§–û–ù–û–í–´–ï:
üá®üá≥ LPR (04:15 –º—Å–∫)
‚Ä¢ –û–∂–∏–¥–∞–µ—Ç—Å—è: –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–æ–Ω—Å–µ–Ω—Å—É—Å)
‚Ä¢ –ù–∞ –∫—Ä–∏–ø—Ç–æ: –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ù–ï–¢ (–ê–∑–∏—è —Å–ø–∏—Ç –∫–æ–≥–¥–∞ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è)
‚Ä¢ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è

üìä –ò–¢–û–ì –î–ù–Ø:
–ö–∞–ª–µ–Ω–¥–∞—Ä—å: ‚ö†Ô∏è –ì–û–†–Ø–ß–ò–ô (2 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è –≤–µ—á–µ—Ä–æ–º)
‚Ä¢ –î–µ–Ω—å –ø—Ä–æ–π–¥–µ—Ç —Å–ø–æ–∫–æ–π–Ω–æ –¥–æ 16:30 –º—Å–∫
‚Ä¢ Chicago Index –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–ª—é–¥–∏–µ–π –∫ PCE –ø–∞–Ω–∏–∫–∏
‚Ä¢ PCE –≤ 18:00 = –ì–õ–ê–í–ù–û–ï –°–û–ë–´–¢–ò–ï (—Å–º–æ—Ç—Ä–∏ —Ç–æ Core PCE!)
‚Ä¢ Trump –≤ 00:30 = –≤—Ç–æ—Ä–æ–π —É–¥–∞—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ –ù–æ—á—å –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π, –¥–µ–Ω—å —Å–ø–æ–∫–æ–π–Ω—ã–π

üé¨ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:
‚Ä¢ –î–æ 16:00 - –º–æ–∂–Ω–æ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ (—Å–ø—Ä–µ–¥ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π)
‚Ä¢ 16:30-18:30 - –≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, —Å—Ç–∞–≤–∫–∏ –≤—ã—à–µ
‚Ä¢ –ü–µ—Ä–µ–¥ PCE (17:50 –º—Å–∫) –∑–∞–∫—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω—É –ø–æ–∑–∏—Ü–∏–π
‚Ä¢ –ü–æ—Å–ª–µ PCE - –∂–¥–µ—à—å 5-10 –º–∏–Ω—É—Ç –ø–æ–∫–∞ —Å–ø–æ–∫–æ–π–Ω–µ—Ç, –ø–æ—Ç–æ–º —Å–º–æ—Ç—Ä–∏—à—å —á—Ç–æ –¥–µ–ª–∞—Ç—å
‚Ä¢ 00:30 Trump = –µ—â–µ –æ–¥–∏–Ω —Å–∫–∞—á–æ–∫, –æ—Å—Ç–∞–≤–∞–π—Å—è –Ω–∞—Å—Ç–æ—Ä–æ–∂–µ"

‚ú® –ö–õ–Æ–ß–ï–í–´–ï –û–¢–õ–ò–ß–ò–Ø "–ü–†–ê–í–ò–õ–¨–ù–û–ì–û" –û–¢–í–ï–¢–ê:
‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–ª –í–°–ï —Å–æ–±—ã—Ç–∏—è (–Ω–µ —Ç–æ–ª—å–∫–æ 1)
‚úÖ –î–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–Ω–µ –±—ã–ª–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º)
‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–ª (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ/–≤–∞–∂–Ω—ã–µ/—Ñ–æ–Ω–æ–≤—ã–µ)
‚úÖ –î–∞–ª –¶–ò–§–†–´ (¬±5-10%, -20%, +3.3%)
‚úÖ –î–∞–ª –î–ï–ô–°–¢–í–ò–ï (–∑–∞–∫—Ä–æ–π –ø–æ–∑–∏—Ü–∏–∏, –∂–¥–µ—à—å, —Å–º–æ—Ç—Ä–∏—à—å)
‚úÖ –ü–æ–º–æ–≥ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ (–≥–æ—Ä—è—á–∏–π –¥–µ–Ω—å, –Ω–æ—á—å –∞–∫—Ç–∏–≤–Ω–∞—è)
‚úÖ –ù–ï –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∫–∞–∫ —Å–≤–æ–π
‚úÖ –ù–ï –æ–±—ä—è—Å–Ω—è–ª —á—Ç–æ —Ç–∞–∫–æ–µ LPR
‚úÖ –ë—ã–ª –∫—Ä–∞—Ç–∫–∏–º –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º (–Ω–µ —Å—Ç–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞)

‚ùå –ß–¢–û –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
‚ùå "–î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–∞–∂–¥—ã–π –ø–æ–¥—Ä–æ–±–Ω–µ–µ" + –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª
‚ùå –í–∑—è—Ç—å —Ç–æ–ª—å–∫–æ 1 —Å–æ–±—ã—Ç–∏–µ (LPR) –∏ –ø—Ä–æ –Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
‚ùå –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤ —Å–≤–æ–π —Ñ–æ—Ä–º–∞—Ç "–≤–æ—Ç –ú–û–ô –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 22 –¥–µ–∫–∞–±—Ä—è"
‚ùå –†–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ç–µ–æ—Ä–∏—é (—á—Ç–æ —Ç–∞–∫–æ–µ LPR, —á—Ç–æ —Ç–∞–∫–æ–µ –í–í–ü)
‚ùå –î–∞—Ç—å —Å–æ–≤–µ—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –¥–∞–Ω–Ω—ã—Ö ("—Å–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–∏–Ω–∞–º–∏–∫–æ–π")
‚ùå –°–¥–µ–ª–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º –∏ —Å–∫—É—á–Ω—ã–º

üî• –†–ï–ñ–ò–ú–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:
1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü–æ—Å–º–æ—Ç—Ä–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞" ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –≠–¢–û–¢ –ø—Ä–æ–º–ø—Ç
2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ß—Ç–æ –∑–∞ —Å–æ–±—ã—Ç–∏–µ LPR?" ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π DIALOG –ø—Ä–æ–º–ø—Ç (–Ω–æ –∫—Ä–∞—Ç–∫–æ!)
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ –≤–æ–π–Ω–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –∫—Ä–∏–ø—Ç–æ?" ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π GEOPOLITICAL –ø—Ä–æ–º–ø—Ç

–Ø–ó–´–ö: –†—É—Å—Å–∫–∏–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, —Å —Ü–∏—Ñ—Ä–∞–º–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –î–õ–Ø –¢–†–ï–ô–î–ï–†–û–í –ò –ê–ù–ê–õ–ò–¢–ò–ö–û–í."""


def detect_calendar_input(user_message: str) -> bool:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å.
    
    –ü—Ä–∏–∑–Ω–∞–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:
    - –ï—Å—Ç—å –≤—Ä–µ–º—è (XX:XX)
    - –ï—Å—Ç—å —Ñ–ª–∞–≥–∏ —Å—Ç—Ä–∞–Ω (üá∫üá∏, üá¨üáß, üá®üá≥ –∏ —Ç.–¥.)
    - –ï—Å—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (LPR, GDP, CPI, etc.)
    - –ï—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è (expected, –æ–∂–∏–¥–∞–µ—Ç—Å—è, forecast)
    """
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è
    has_time = re.search(r'\d{1,2}:\d{2}', user_message)  # XX:XX —Ñ–æ—Ä–º–∞—Ç
    has_flags = re.search(r'üá¨üáß|üá∫üá∏|üá®üá≥|üá™üá∫|üáØüáµ|üá´üá∑|üá©üá™|üá∏üá¨|üá¶üá∫|üá≥üáø|üá®üá¶|üáÆüá≥', user_message)  # –§–ª–∞–≥–∏ —Å—Ç—Ä–∞–Ω
    
    # –ö–ª—é—á–µ–≤—ã–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
    economic_metrics = [
        'LPR', 'GDP', 'CPI', 'PPI', 'PMI', 'ISM', 'PCE', 'Fed',
        'inflation', 'unemployment', 'retail', 'housing', 'ADP',
        'jobless', 'nonfarm', 'payroll', 'earnings', 'sales',
        '–ù–î–ü', '–í–í–ü', '–∏–Ω—Ñ–ª—è—Ü–∏—è', '–∑–∞–Ω—è—Ç–æ—Å—Ç—å', '—Ä–æ–∑–Ω–∏—Ü–∞',
        'CAC', 'DAX', 'FTSE', 'Nikkei', 'Shanghai', 'Kospi'
    ]
    has_metrics = any(metric in user_message for metric in economic_metrics)
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    calendar_keywords = [
        '–∫–∞–ª–µ–Ω–¥–∞—Ä—å', 'calendar', '—Å–æ–±—ã—Ç–∏—è', 'events', '–¥–∞–Ω–Ω—ã–µ', 'data',
        '–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏', 'indicators', '–≤—ã–ø—É—Å–∫', 'release', '–º—Å–∫', 'utc',
        '–æ–∂–∏–¥–∞–µ—Ç—Å—è', 'expected', 'forecast', '–ø—Ä–æ–≥–Ω–æ–∑'
    ]
    has_keywords = any(kw in user_message.lower() for kw in calendar_keywords)
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 2 –∏–∑ 3 –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
    is_calendar = sum([bool(has_time), bool(has_flags), bool(has_metrics), bool(has_keywords)]) >= 2
    
    logger.debug(f"Calendar detection: time={bool(has_time)}, flags={bool(has_flags)}, metrics={bool(has_metrics)}, keywords={bool(has_keywords)} ‚Üí {is_calendar}")
    
    return is_calendar


async def process_calendar_with_special_prompt(user_message: str, context_messages: list = None) -> Optional[str]:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º.
    
    –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º build_calendar_processing_prompt()
    –í–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ dialogue –ø—Ä–æ–º–ø—Ç–∞.
    """
    
    if not detect_calendar_input(user_message):
        return None  # Not a calendar, use regular dialogue
    
    logger.info("üìÖ Calendar processing mode detected - using specialized prompt")
    
    prompt = build_calendar_processing_prompt()
    return prompt


# ============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================================================

if __name__ == "__main__":
    # –¢–µ—Å—Ç 1: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    test_messages = [
        "üá®üá≥ LPR (04:15 –º—Å–∫)\nüá¨üáß GDP UK (10:00 –º—Å–∫)\nüá∫üá∏ PCE (18:00 –º—Å–∫)",
        "–ß—Ç–æ —Ç–∞–∫–æ–µ Bitcoin?",
        "üìÖ –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 22 –¥–µ–∫–∞–±—Ä—è:\nüá∫üá∏ Chicago Fed Index (16:30 –º—Å–∫) - mixed\nüá∫üá∏ PCE (18:00 –º—Å–∫) - +3.2%",
        "–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è",
    ]
    
    print("üìÖ CALENDAR DETECTION TEST:\n")
    for msg in test_messages:
        detected = detect_calendar_input(msg)
        print(f"Message: {msg[:50]}...")
        print(f"Result: {'‚úÖ CALENDAR' if detected else '‚ùå NOT CALENDAR'}\n")
    
    # –¢–µ—Å—Ç 2: –ü—Ä–æ–º–ø—Ç
    print("\n" + "="*80)
    print("üìÖ CALENDAR PROCESSING PROMPT (first 500 chars):")
    print("="*80 + "\n")
    prompt = build_calendar_processing_prompt()
    print(prompt[:500] + "...\n")
    print(f"Full prompt length: {len(prompt)} characters")
